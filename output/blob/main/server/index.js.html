<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>personal-web-2025/server/index.js at main</title>
    <style>
        
        :root {
          --c-indigo-1: #3451b2;
          --c-indigo-2: #3a5ccc;
          --c-indigo-3: #5672cd;
          --c-green: #1a7f37;
          --c-red: #c53030;
          --c-yellow: #9a6700;
          --c-dir: #54aeff;
          --c-gray-soft: rgba(142, 150, 170, .14);
          --c-bg: #ffffff;
          --c-bg-alt: #f6f6f7;
          --c-bg-elv: #ffffff;
          --c-text-1: rgba(60, 60, 67);
          --c-text-2: rgba(60, 60, 67, .78);
          --c-text-3: rgba(60, 60, 67, .56);
          --c-border: #c2c2c4;
          --c-divider: #e2e2e3;
        }

        

        :root {
          --c-brand-1: var(--c-indigo-1);
          --c-brand-2: var(--c-indigo-2);
          --c-brand-3: var(--c-indigo-3);
          --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
          --font-family-mono: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
          --code-line-height: 20px;
          --code-font-size: 12px;
          --code-color: var(--c-brand-1);
          --code-bg: var(--c-gray-soft);
          --code-block-bg: var(--c-bg-alt);
          --code-block-color: var(--c-text-1);
          --header-height: 46px;
          --border-radius: 6px;
          --max-content-width: 1470px;
        }

        * {
          box-sizing: border-box;
        }

        body {
          margin: 0;
          padding: 0;
          font-family: var(--font-family), sans-serif;
          font-size: 14px;
          line-height: 1;
          color: var(--c-text-1);
          background-color: var(--c-bg);
          text-rendering: optimizeLegibility;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          -moz-text-size-adjust: none;
          -webkit-text-size-adjust: none;
          text-size-adjust: none;
          min-height: 100vh;
          display: flex;
          flex-direction: column;
        }

        .nowrap {
          white-space: nowrap;
        }

        h1 {
          margin-inline: 0;
          margin-block: 16px;
          font-size: 20px;
          font-weight: 600;
        }

        a {
          color: var(--c-brand-1);
          font-weight: 500;
          text-decoration: underline;
          text-underline-offset: 2px;
          text-decoration: inherit;
          touch-action: manipulation;
        }

        a:hover {
          color: var(--c-brand-2);
          text-decoration: underline;
        }

        .menu {
          background-color: var(--c-bg-alt);
          border-bottom: 1px solid var(--c-divider);
          overflow-x: auto;
        }

        .menu-content {
          display: flex;
          flex-direction: row;
          align-items: center;
          gap: 16px;
          padding-inline: 16px;
          max-width: var(--max-content-width);
          margin-inline: auto;
        }

        .menu-item {
          display: flex;
          align-items: center;
          border-bottom: 2px solid transparent;
          height: 56px;
          padding-inline: 8px;
        }

        .menu-item a {
          display: flex;
          flex-direction: row;
          gap: 8px;
          align-items: center;
          color: var(--c-text-1);
          padding: 8px 10px;
          border-radius: 4px;
        }

        .menu-item a:hover {
          background-color: var(--c-bg-elv);
          text-decoration: none;
        }

        .menu-item.selected {
          border-bottom-color: var(--c-brand-1);
        }

        .project-name {
          font-weight: 600;
          font-size: 16px;
          margin-inline: 16px;
          color: var(--c-text-1);
          text-decoration: none;
        }

        main {
          flex-grow: 1;
          width: 100%;
          max-width: var(--max-content-width);
          margin: 16px auto;
        }

        .main-content {
          padding-inline: 16px;
        }

        footer {
          padding: 12px 16px;
          background-color: var(--c-bg-alt);
          border-top: 1px solid var(--c-divider);
          color: var(--c-text-3);
          font-size: 12px;
          text-align: center;
        }

        .header-container {
          container-type: scroll-state;
          position: sticky;
          top: 0;
        }

        .header-container {
          @container scroll-state(stuck: top) {
            header {
              border-top: none;
              border-top-left-radius: 0;
              border-top-right-radius: 0;
            }

            .goto-top {
              display: flex;
            }
          }
        }

        header {
          display: flex;
          flex-direction: row;
          align-items: center;
          min-height: var(--header-height);
          padding-inline: 16px;
          background: var(--c-bg-alt);
          border: 1px solid var(--c-border);
          border-top-left-radius: var(--border-radius);
          border-top-right-radius: var(--border-radius);
        }

        header h1 {
          word-break: break-all;
          font-weight: 600;
          font-size: 16px;
          margin: 0;
          padding: 0;
        }

        .header-ref {
          color: var(--c-text-2);
          border: 1px solid var(--c-border);
          border-radius: 6px;
          padding: 6px 10px;
          margin-right: 10px;
          margin-left: -6px;
        }

        header .path {
          font-size: 16px;
        }

        .breadcrumbs {
          display: flex;
          flex-direction: row;
          flex-wrap: wrap;
          gap: 6px;
          font-size: 16px;
        }

        .breadcrumbs a {
          word-break: break-all;
        }

        .goto-top {
          display: none;
          margin-left: auto;
          padding: 6px 10px;
          background: none;
          border: none;
          border-radius: 6px;
          gap: 4px;
          align-items: center;
          color: var(--c-text-1);
          cursor: pointer;
        }

        .goto-top:hover {
          background: var(--c-bg-elv);
        }
    </style>
    
    <style>
        .bg { background-color: #ffffff; }
.chroma { background-color: #ffffff; }
.chroma .ln:target { background-color: #e5e5e5 }
.chroma .lnt:target { background-color: #e5e5e5 }
.chroma .err { color: #f6f8fa; background-color: #82071e }
.chroma .lnlinks { outline: none; text-decoration: none; color: inherit }
.chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
.chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; }
.chroma .hl { background-color: #e5e5e5 }
.chroma .lnt { white-space: pre; -webkit-user-select: none; user-select: none; margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
.chroma .ln { white-space: pre; -webkit-user-select: none; user-select: none; margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
.chroma .line { display: flex; }
.chroma .k { color: #cf222e }
.chroma .kc { color: #cf222e }
.chroma .kd { color: #cf222e }
.chroma .kn { color: #cf222e }
.chroma .kp { color: #cf222e }
.chroma .kr { color: #cf222e }
.chroma .kt { color: #cf222e }
.chroma .na { color: #1f2328 }
.chroma .nc { color: #1f2328 }
.chroma .no { color: #0550ae }
.chroma .nd { color: #0550ae }
.chroma .ni { color: #6639ba }
.chroma .nl { color: #990000; font-weight: bold }
.chroma .nn { color: #24292e }
.chroma .nx { color: #1f2328 }
.chroma .nt { color: #0550ae }
.chroma .nb { color: #6639ba }
.chroma .bp { color: #6a737d }
.chroma .nv { color: #953800 }
.chroma .vc { color: #953800 }
.chroma .vg { color: #953800 }
.chroma .vi { color: #953800 }
.chroma .vm { color: #953800 }
.chroma .nf { color: #6639ba }
.chroma .fm { color: #6639ba }
.chroma .s { color: #0a3069 }
.chroma .sa { color: #0a3069 }
.chroma .sb { color: #0a3069 }
.chroma .sc { color: #0a3069 }
.chroma .dl { color: #0a3069 }
.chroma .sd { color: #0a3069 }
.chroma .s2 { color: #0a3069 }
.chroma .se { color: #0a3069 }
.chroma .sh { color: #0a3069 }
.chroma .si { color: #0a3069 }
.chroma .sx { color: #0a3069 }
.chroma .sr { color: #0a3069 }
.chroma .s1 { color: #0a3069 }
.chroma .ss { color: #032f62 }
.chroma .m { color: #0550ae }
.chroma .mb { color: #0550ae }
.chroma .mf { color: #0550ae }
.chroma .mh { color: #0550ae }
.chroma .mi { color: #0550ae }
.chroma .il { color: #0550ae }
.chroma .mo { color: #0550ae }
.chroma .o { color: #0550ae }
.chroma .ow { color: #0550ae }
.chroma .p { color: #1f2328 }
.chroma .c { color: #57606a }
.chroma .ch { color: #57606a }
.chroma .cm { color: #57606a }
.chroma .c1 { color: #57606a }
.chroma .cs { color: #57606a }
.chroma .cp { color: #57606a }
.chroma .cpf { color: #57606a }
.chroma .gd { color: #82071e; background-color: #ffebe9 }
.chroma .ge { color: #1f2328 }
.chroma .gi { color: #116329; background-color: #dafbe1 }
.chroma .go { color: #1f2328 }
.chroma .gl { text-decoration: underline }
.chroma .w { color: #ffffff }


        [id] {
          scroll-margin-top: var(--header-height);
        }

        pre {
          border: 1px solid var(--c-border);
          border-top: none;
          border-bottom-left-radius: var(--border-radius);
          border-bottom-right-radius: var(--border-radius);
        }

        pre {
          margin: 0;
          padding: 8px 16px;
          overflow-x: auto;
          white-space: pre;
          word-spacing: normal;
          word-break: normal;
          word-wrap: normal;
          tab-size: 4;
          font-family: var(--font-family-mono), monospace;
        }

        pre > code {
          display: block;
          padding: 0 16px;
          width: fit-content;
          min-width: 100%;
          line-height: var(--code-line-height);
          font-size: var(--code-font-size);
        }

        .border {
          border: 1px solid var(--c-border);
          border-top: none;
          border-bottom-left-radius: 6px;
          border-bottom-right-radius: 6px;
        }

        .binary-file {
          padding: 8px 16px;
          font-style: italic;
        }

        .image {
          padding: 8px 16px;
          text-align: center;
        }

        .image img {
          max-width: 100%;
          height: auto;
        }
    </style>

</head>
<body>

    <svg style="display: none" aria-hidden="true" focusable="false">
        <symbol id="dir" viewBox="0 0 16 16">
            <path fill="currentColor"
                  d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"/>
        </symbol>
        <symbol id="file" viewBox="0 0 16 16">
            <path fill="currentColor"
                  d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"/>
        </symbol>
        <symbol id="file-added" viewBox="0 0 16 16">
            <path fill="currentColor"
                  d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V4.664a.25.25 0 0 0-.073-.177l-2.914-2.914a.25.25 0 0 0-.177-.073Zm4.48 3.758a.75.75 0 0 1 .755.745l.01 1.497h1.497a.75.75 0 0 1 0 1.5H9v1.507a.75.75 0 0 1-1.5 0V9.005l-1.502.01a.75.75 0 0 1-.01-1.5l1.507-.01-.01-1.492a.75.75 0 0 1 .745-.755Z"/>
        </symbol>
        <symbol id="file-modified" viewBox="0 0 16 16">
            <path fill="currentColor"
                  d="M1 1.75C1 .784 1.784 0 2.75 0h7.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16H2.75A1.75 1.75 0 0 1 1 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25V4.664a.25.25 0 0 0-.073-.177l-2.914-2.914a.25.25 0 0 0-.177-.073ZM8 3.25a.75.75 0 0 1 .75.75v1.5h1.5a.75.75 0 0 1 0 1.5h-1.5v1.5a.75.75 0 0 1-1.5 0V7h-1.5a.75.75 0 0 1 0-1.5h1.5V4A.75.75 0 0 1 8 3.25Zm-3 8a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1-.75-.75Z"/>
        </symbol>
        <symbol id="file-deleted" viewBox="0 0 16 16">
            <path fill="currentColor"
                  d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V4.664a.25.25 0 0 0-.073-.177l-2.914-2.914a.25.25 0 0 0-.177-.073Zm4.5 6h2.242a.75.75 0 0 1 0 1.5h-2.24l-2.254.015a.75.75 0 0 1-.01-1.5Z"/>
        </symbol>
        <symbol id="file-renamed" viewBox="0 0 16 16">
            <path fill="currentColor"
                  d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-3.5a.75.75 0 0 1 0-1.5h3.5a.25.25 0 0 0 .25-.25V4.664a.25.25 0 0 0-.073-.177l-2.914-2.914a.25.25 0 0 0-.177-.073H3.75a.25.25 0 0 0-.25.25v6.5a.75.75 0 0 1-1.5 0v-6.5Z"/>
            <path fill="currentColor"
                  d="m5.427 15.573 3.146-3.146a.25.25 0 0 0 0-.354L5.427 8.927A.25.25 0 0 0 5 9.104V11.5H.75a.75.75 0 0 0 0 1.5H5v2.396c0 .223.27.335.427.177Z"/>
        </symbol>
        <symbol id="arrow-top" viewBox="0 0 16 16">
            <path fill="currentColor"
                  d="M3.47 7.78a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0l4.25 4.25a.751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018L9 4.81v7.44a.75.75 0 0 1-1.5 0V4.81L4.53 7.78a.75.75 0 0 1-1.06 0Z"></path>
        </symbol>
        <symbol id="commit" viewBox="0 0 16 16">
            <path fill="currentColor"
                  d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path>
        </symbol>
        <symbol id="branch" viewBox="0 0 16 16">
            <path fill="currentColor"
                  d="M9.5 3.25a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.493 2.493 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25Zm-6 0a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Zm8.25-.75a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z"></path>
        </symbol>
        <symbol id="tag" viewBox="0 0 16 16">
            <path fill="currentColor"
                  d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"></path>
        </symbol>
        <symbol id="code" viewBox="0 0 16 16">
            <path fill="currentColor"
                  d="m11.28 3.22 4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L13.94 8l-3.72-3.72a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215Zm-6.56 0a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L2.06 8l3.72 3.72a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L.47 8.53a.75.75 0 0 1 0-1.06Z"></path>
        </symbol>
    </svg>

<div class="menu">
    <div class="menu-content">
        <a href="../../../index.html" class="project-name">personal-web-2025</a>
        <div class="menu-item selected">
            <a href="../../../blob/main/index.html">
                <svg aria-hidden="true" width="16" height="16">
                    <use xlink:href="#code"></use>
                </svg>
                Code
            </a>
        </div>
        <div class="menu-item ">
            <a href="../../../branches.html">
                <svg aria-hidden="true" focusable="false" width="16" height="16">
                    <use xlink:href="#branch"></use>
                </svg>
                Branches
            </a>
        </div>
        <div class="menu-item ">
            <a href="../../../tags.html">
                <svg aria-hidden="true" focusable="false" width="16" height="16">
                    <use xlink:href="#tag"></use>
                </svg>
                Tags
            </a>
        </div>
        <div class="menu-item ">
            <a href="../../../commits/main/index.html">
                <svg aria-hidden="true" focusable="false" width="16" height="16">
                    <use xlink:href="#commit"></use>
                </svg>
                Commits
            </a>
        </div>
    </div>
</div>
<main>
    <div class="main-content">
        
    
    <div class="header-container">
        <header>
            
                <div class="header-ref" aria-label="Ref">main</div>
            
            
                <nav class="breadcrumbs" aria-label="Breadcrumbs">
                    
                        
                        
                            <a href="./../index.html">personal-web-2025</a>
                        
                    
                        
                            <div>/</div>
                        
                        
                            <a href="./index.html">server</a>
                        
                    
                        
                            <div>/</div>
                        
                        
                            <h1>index.js</h1>
                            
                        
                    
                </nav>
            
            <button class="goto-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                <svg aria-hidden="true" focusable="false" width="16" height="16">
                    <use xlink:href="#arrow-top"></use>
                </svg>
                Top
            </button>
        </header>
    </div>

    
        <pre class="chroma"><code><span class="line"><span class="ln" id="L1"><a class="lnlinks" href="#L1">   1</a></span><span class="cl"><span class="kr">import</span> <span class="nx">express</span> <span class="nx">from</span> <span class="s1">&#39;express&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2"><a class="lnlinks" href="#L2">   2</a></span><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">createServer</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;http&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L3"><a class="lnlinks" href="#L3">   3</a></span><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Server</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;socket.io&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L4"><a class="lnlinks" href="#L4">   4</a></span><span class="cl"><span class="kr">import</span> <span class="nx">cors</span> <span class="nx">from</span> <span class="s1">&#39;cors&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L5"><a class="lnlinks" href="#L5">   5</a></span><span class="cl"><span class="kr">import</span> <span class="nx">fs</span> <span class="nx">from</span> <span class="s1">&#39;fs&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L6"><a class="lnlinks" href="#L6">   6</a></span><span class="cl"><span class="kr">import</span> <span class="nx">path</span> <span class="nx">from</span> <span class="s1">&#39;path&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L7"><a class="lnlinks" href="#L7">   7</a></span><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">fileURLToPath</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;url&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L8"><a class="lnlinks" href="#L8">   8</a></span><span class="cl"><span class="kr">import</span> <span class="nx">multer</span> <span class="nx">from</span> <span class="s1">&#39;multer&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L9"><a class="lnlinks" href="#L9">   9</a></span><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">toZonedTime</span><span class="p">,</span> <span class="nx">fromZonedTime</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;date-fns-tz&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L10"><a class="lnlinks" href="#L10">  10</a></span><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">generateSignedUrl</span><span class="p">,</span> <span class="nx">generateSignedUrlsForPrefix</span><span class="p">,</span> <span class="nx">isValidFilePath</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;./utils/gcsHelper.js&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L11"><a class="lnlinks" href="#L11">  11</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L12"><a class="lnlinks" href="#L12">  12</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L13"><a class="lnlinks" href="#L13">  13</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L14"><a class="lnlinks" href="#L14">  14</a></span><span class="cl"><span class="kr">const</span> <span class="nx">_</span><span class="nx">_filename</span> <span class="o">=</span> <span class="nx">fileURLToPath</span><span class="p">(</span><span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L15"><a class="lnlinks" href="#L15">  15</a></span><span class="cl"><span class="kr">const</span> <span class="nx">_</span><span class="nx">_dirname</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">_</span><span class="nx">_filename</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L16"><a class="lnlinks" href="#L16">  16</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L17"><a class="lnlinks" href="#L17">  17</a></span><span class="cl"><span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L18"><a class="lnlinks" href="#L18">  18</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L19"><a class="lnlinks" href="#L19">  19</a></span><span class="cl"><span class="c1">// CORS configuration - explicitly allow production and development domains
</span></span></span><span class="line"><span class="ln" id="L20"><a class="lnlinks" href="#L20">  20</a></span><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">corsOptions</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L21"><a class="lnlinks" href="#L21">  21</a></span><span class="cl">    <span class="nx">origin</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln" id="L22"><a class="lnlinks" href="#L22">  22</a></span><span class="cl">        <span class="s1">&#39;http://localhost:3000&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L23"><a class="lnlinks" href="#L23">  23</a></span><span class="cl">        <span class="s1">&#39;http://localhost:5173&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L24"><a class="lnlinks" href="#L24">  24</a></span><span class="cl">        <span class="s1">&#39;https://www.distilledchild.space&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L25"><a class="lnlinks" href="#L25">  25</a></span><span class="cl">        <span class="s1">&#39;https://distilledchild.space&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L26"><a class="lnlinks" href="#L26">  26</a></span><span class="cl">        <span class="s1">&#39;https://personal-web-2025-mauve.vercel.app&#39;</span>
</span></span><span class="line"><span class="ln" id="L27"><a class="lnlinks" href="#L27">  27</a></span><span class="cl">    <span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L28"><a class="lnlinks" href="#L28">  28</a></span><span class="cl">    <span class="nx">methods</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L29"><a class="lnlinks" href="#L29">  29</a></span><span class="cl">    <span class="nx">allowedHeaders</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;X-Requested-With&#39;</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L30"><a class="lnlinks" href="#L30">  30</a></span><span class="cl">    <span class="nx">credentials</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L31"><a class="lnlinks" href="#L31">  31</a></span><span class="cl">    <span class="nx">optionsSuccessStatus</span><span class="o">:</span> <span class="mi">200</span>
</span></span><span class="line"><span class="ln" id="L32"><a class="lnlinks" href="#L32">  32</a></span><span class="cl"><span class="p">}</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L33"><a class="lnlinks" href="#L33">  33</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L34"><a class="lnlinks" href="#L34">  34</a></span><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">(</span><span class="nx">corsOptions</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L35"><a class="lnlinks" href="#L35">  35</a></span><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L36"><a class="lnlinks" href="#L36">  36</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L37"><a class="lnlinks" href="#L37">  37</a></span><span class="cl"><span class="c1">// Root route for health check
</span></span></span><span class="line"><span class="ln" id="L38"><a class="lnlinks" href="#L38">  38</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L39"><a class="lnlinks" href="#L39">  39</a></span><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;Hello from Cloud Run! ðŸš€ Server is running correctly.&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L40"><a class="lnlinks" href="#L40">  40</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L41"><a class="lnlinks" href="#L41">  41</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L42"><a class="lnlinks" href="#L42">  42</a></span><span class="cl"><span class="c1">// Load environment variables
</span></span></span><span class="line"><span class="ln" id="L43"><a class="lnlinks" href="#L43">  43</a></span><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="nx">dotenv</span> <span class="nx">from</span> <span class="s1">&#39;dotenv&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L44"><a class="lnlinks" href="#L44">  44</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L45"><a class="lnlinks" href="#L45">  45</a></span><span class="cl"><span class="c1">// Load .env from parent directory (project root)
</span></span></span><span class="line"><span class="ln" id="L46"><a class="lnlinks" href="#L46">  46</a></span><span class="cl"><span class="c1"></span><span class="nx">dotenv</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">_</span><span class="nx">_dirname</span><span class="p">,</span> <span class="s1">&#39;../.env&#39;</span><span class="p">)</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L47"><a class="lnlinks" href="#L47">  47</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L48"><a class="lnlinks" href="#L48">  48</a></span><span class="cl"><span class="kr">const</span> <span class="nx">GOOGLE</span><span class="nx">_CLIENT</span><span class="nx">_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GOOGLE</span><span class="nx">_CLIENT</span><span class="nx">_ID</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L49"><a class="lnlinks" href="#L49">  49</a></span><span class="cl"><span class="kr">const</span> <span class="nx">GOOGLE</span><span class="nx">_CLIENT</span><span class="nx">_SECRET</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GOOGLE</span><span class="nx">_CLIENT</span><span class="nx">_SECRET</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L50"><a class="lnlinks" href="#L50">  50</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L51"><a class="lnlinks" href="#L51">  51</a></span><span class="cl"><span class="c1">// Determine Redirect URI based on environment
</span></span></span><span class="line"><span class="ln" id="L52"><a class="lnlinks" href="#L52">  52</a></span><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">isProduction</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE</span><span class="nx">_ENV</span> <span class="o">===</span> <span class="s1">&#39;production&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L53"><a class="lnlinks" href="#L53">  53</a></span><span class="cl"><span class="kr">const</span> <span class="nx">REDIRECT</span><span class="nx">_URI</span> <span class="o">=</span> <span class="nx">isProduction</span>
</span></span><span class="line"><span class="ln" id="L54"><a class="lnlinks" href="#L54">  54</a></span><span class="cl">    <span class="o">?</span> <span class="s1">&#39;https://www.distilledchild.space/oauth/google/callback&#39;</span>
</span></span><span class="line"><span class="ln" id="L55"><a class="lnlinks" href="#L55">  55</a></span><span class="cl">    <span class="o">:</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GOOGLE</span><span class="nx">_REDIRECT</span><span class="nx">_URI</span> <span class="o">||</span> <span class="s1">&#39;http://localhost:3000/oauth/google/callback&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L56"><a class="lnlinks" href="#L56">  56</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L57"><a class="lnlinks" href="#L57">  57</a></span><span class="cl"><span class="c1">// Database connection
</span></span></span><span class="line"><span class="ln" id="L58"><a class="lnlinks" href="#L58">  58</a></span><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="nx">mongoose</span> <span class="nx">from</span> <span class="s1">&#39;mongoose&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L59"><a class="lnlinks" href="#L59">  59</a></span><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Storage</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;@google-cloud/storage&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L60"><a class="lnlinks" href="#L60">  60</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L61"><a class="lnlinks" href="#L61">  61</a></span><span class="cl"><span class="c1">// Initialize Google Cloud Storage
</span></span></span><span class="line"><span class="ln" id="L62"><a class="lnlinks" href="#L62">  62</a></span><span class="cl"><span class="c1"></span><span class="c1">// Supports both file path (local) and JSON string (Railway/Render)
</span></span></span><span class="line"><span class="ln" id="L63"><a class="lnlinks" href="#L63">  63</a></span><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">storageConfig</span> <span class="o">=</span> <span class="p">{</span><span class="p">}</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L64"><a class="lnlinks" href="#L64">  64</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L65"><a class="lnlinks" href="#L65">  65</a></span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GCP</span><span class="nx">_SERVICE</span><span class="nx">_ACCOUNT</span><span class="nx">_KEY</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L66"><a class="lnlinks" href="#L66">  66</a></span><span class="cl">    <span class="c1">// Railway/Render: JSON string in environment variable
</span></span></span><span class="line"><span class="ln" id="L67"><a class="lnlinks" href="#L67">  67</a></span><span class="cl"><span class="c1"></span>    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L68"><a class="lnlinks" href="#L68">  68</a></span><span class="cl">        <span class="nx">storageConfig</span><span class="p">.</span><span class="nx">credentials</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GCP</span><span class="nx">_SERVICE</span><span class="nx">_ACCOUNT</span><span class="nx">_KEY</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L69"><a class="lnlinks" href="#L69">  69</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Using GCS credentials from GCP_SERVICE_ACCOUNT_KEY&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L70"><a class="lnlinks" href="#L70">  70</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L71"><a class="lnlinks" href="#L71">  71</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to parse GCP_SERVICE_ACCOUNT_KEY:&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L72"><a class="lnlinks" href="#L72">  72</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L73"><a class="lnlinks" href="#L73">  73</a></span><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GOOGLE</span><span class="nx">_APPLICATION</span><span class="nx">_CREDENTIALS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L74"><a class="lnlinks" href="#L74">  74</a></span><span class="cl">    <span class="c1">// Local: file path
</span></span></span><span class="line"><span class="ln" id="L75"><a class="lnlinks" href="#L75">  75</a></span><span class="cl"><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Using GCS credentials from GOOGLE_APPLICATION_CREDENTIALS file&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L76"><a class="lnlinks" href="#L76">  76</a></span><span class="cl">    <span class="nx">storageConfig</span><span class="p">.</span><span class="nx">keyFilename</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GOOGLE</span><span class="nx">_APPLICATION</span><span class="nx">_CREDENTIALS</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L77"><a class="lnlinks" href="#L77">  77</a></span><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="s1">&#39;/app/gcs-key.json&#39;</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L78"><a class="lnlinks" href="#L78">  78</a></span><span class="cl">    <span class="c1">// Cloud Run: Secret Manager mounted key
</span></span></span><span class="line"><span class="ln" id="L79"><a class="lnlinks" href="#L79">  79</a></span><span class="cl"><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Using GCS credentials from Cloud Run Secret Manager (/app/gcs-key.json)&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L80"><a class="lnlinks" href="#L80">  80</a></span><span class="cl">    <span class="nx">storageConfig</span><span class="p">.</span><span class="nx">keyFilename</span> <span class="o">=</span> <span class="s1">&#39;/app/gcs-key.json&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L81"><a class="lnlinks" href="#L81">  81</a></span><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">_</span><span class="nx">_dirname</span><span class="p">,</span> <span class="s1">&#39;../service-account-key.json&#39;</span><span class="p">)</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L82"><a class="lnlinks" href="#L82">  82</a></span><span class="cl">    <span class="c1">// Local: automatic detection of service-account-key.json in root
</span></span></span><span class="line"><span class="ln" id="L83"><a class="lnlinks" href="#L83">  83</a></span><span class="cl"><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Using GCS credentials from local service-account-key.json&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L84"><a class="lnlinks" href="#L84">  84</a></span><span class="cl">    <span class="nx">storageConfig</span><span class="p">.</span><span class="nx">keyFilename</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">_</span><span class="nx">_dirname</span><span class="p">,</span> <span class="s1">&#39;../service-account-key.json&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L85"><a class="lnlinks" href="#L85">  85</a></span><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L86"><a class="lnlinks" href="#L86">  86</a></span><span class="cl">    <span class="c1">// Default: Application Default Credentials (gcloud auth)
</span></span></span><span class="line"><span class="ln" id="L87"><a class="lnlinks" href="#L87">  87</a></span><span class="cl"><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Using GCS default credentials&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L88"><a class="lnlinks" href="#L88">  88</a></span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L89"><a class="lnlinks" href="#L89">  89</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L90"><a class="lnlinks" href="#L90">  90</a></span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GCP</span><span class="nx">_PROJECT</span><span class="nx">_ID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L91"><a class="lnlinks" href="#L91">  91</a></span><span class="cl">    <span class="nx">storageConfig</span><span class="p">.</span><span class="nx">projectId</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GCP</span><span class="nx">_PROJECT</span><span class="nx">_ID</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L92"><a class="lnlinks" href="#L92">  92</a></span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L93"><a class="lnlinks" href="#L93">  93</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L94"><a class="lnlinks" href="#L94">  94</a></span><span class="cl"><span class="kr">const</span> <span class="nx">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Storage</span><span class="p">(</span><span class="nx">storageConfig</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L95"><a class="lnlinks" href="#L95">  95</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L96"><a class="lnlinks" href="#L96">  96</a></span><span class="cl"><span class="c1">// Configure multer for memory storage
</span></span></span><span class="line"><span class="ln" id="L97"><a class="lnlinks" href="#L97">  97</a></span><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">upload</span> <span class="o">=</span> <span class="nx">multer</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L98"><a class="lnlinks" href="#L98">  98</a></span><span class="cl">    <span class="nx">storage</span><span class="o">:</span> <span class="nx">multer</span><span class="p">.</span><span class="nx">memoryStorage</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L99"><a class="lnlinks" href="#L99">  99</a></span><span class="cl">    <span class="nx">limits</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L100"><a class="lnlinks" href="#L100"> 100</a></span><span class="cl">        <span class="nx">fileSize</span><span class="o">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="c1">// 5MB limit
</span></span></span><span class="line"><span class="ln" id="L101"><a class="lnlinks" href="#L101"> 101</a></span><span class="cl"><span class="c1"></span>    <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L102"><a class="lnlinks" href="#L102"> 102</a></span><span class="cl">    <span class="nx">fileFilter</span><span class="o">:</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L103"><a class="lnlinks" href="#L103"> 103</a></span><span class="cl">        <span class="c1">// Accept images only
</span></span></span><span class="line"><span class="ln" id="L104"><a class="lnlinks" href="#L104"> 104</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">file</span><span class="p">.</span><span class="nx">mimetype</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;image/&#39;</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L105"><a class="lnlinks" href="#L105"> 105</a></span><span class="cl">            <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Only image files are allowed!&#39;</span><span class="p">)</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L106"><a class="lnlinks" href="#L106"> 106</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L107"><a class="lnlinks" href="#L107"> 107</a></span><span class="cl">        <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L108"><a class="lnlinks" href="#L108"> 108</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L109"><a class="lnlinks" href="#L109"> 109</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L110"><a class="lnlinks" href="#L110"> 110</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L111"><a class="lnlinks" href="#L111"> 111</a></span><span class="cl"><span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGODB</span><span class="nx">_URI</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="L112"><a class="lnlinks" href="#L112"> 112</a></span><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="p">(</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Connected to MongoDB&#39;</span><span class="p">)</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="L113"><a class="lnlinks" href="#L113"> 113</a></span><span class="cl">    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;MongoDB connection error:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L114"><a class="lnlinks" href="#L114"> 114</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L115"><a class="lnlinks" href="#L115"> 115</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L116"><a class="lnlinks" href="#L116"> 116</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L117"><a class="lnlinks" href="#L117"> 117</a></span><span class="cl"><span class="kr">const</span> <span class="nx">stateSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L118"><a class="lnlinks" href="#L118"> 118</a></span><span class="cl">    <span class="nx">code</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L119"><a class="lnlinks" href="#L119"> 119</a></span><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L120"><a class="lnlinks" href="#L120"> 120</a></span><span class="cl">    <span class="nx">status</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L121"><a class="lnlinks" href="#L121"> 121</a></span><span class="cl">    <span class="nx">fips</span><span class="nx">_code</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L122"><a class="lnlinks" href="#L122"> 122</a></span><span class="cl">    <span class="nx">color</span><span class="nx">_code</span><span class="o">:</span> <span class="nb">String</span> <span class="c1">// column added for filling states with colors 
</span></span></span><span class="line"><span class="ln" id="L123"><a class="lnlinks" href="#L123"> 123</a></span><span class="cl"><span class="c1"></span><span class="p">}</span><span class="p">,</span> <span class="p">{</span> <span class="nx">collection</span><span class="o">:</span> <span class="s1">&#39;STATE&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L124"><a class="lnlinks" href="#L124"> 124</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L125"><a class="lnlinks" href="#L125"> 125</a></span><span class="cl"><span class="kr">const</span> <span class="nx">State</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="nx">stateSchema</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L126"><a class="lnlinks" href="#L126"> 126</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L127"><a class="lnlinks" href="#L127"> 127</a></span><span class="cl"><span class="kr">const</span> <span class="nx">citySchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L128"><a class="lnlinks" href="#L128"> 128</a></span><span class="cl">    <span class="nx">state</span><span class="nx">_code</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L129"><a class="lnlinks" href="#L129"> 129</a></span><span class="cl">    <span class="nx">city</span><span class="nx">_name</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L130"><a class="lnlinks" href="#L130"> 130</a></span><span class="cl">    <span class="nx">city</span><span class="nx">_code</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="c1">// Airport code (e.g., ORD, BOS, JFK)
</span></span></span><span class="line"><span class="ln" id="L131"><a class="lnlinks" href="#L131"> 131</a></span><span class="cl"><span class="c1"></span>    <span class="nx">latitude</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L132"><a class="lnlinks" href="#L132"> 132</a></span><span class="cl">    <span class="nx">longitude</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L133"><a class="lnlinks" href="#L133"> 133</a></span><span class="cl">    <span class="nx">status</span><span class="o">:</span> <span class="nb">String</span>
</span></span><span class="line"><span class="ln" id="L134"><a class="lnlinks" href="#L134"> 134</a></span><span class="cl"><span class="p">}</span><span class="p">,</span> <span class="p">{</span> <span class="nx">collection</span><span class="o">:</span> <span class="s1">&#39;CITY&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L135"><a class="lnlinks" href="#L135"> 135</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L136"><a class="lnlinks" href="#L136"> 136</a></span><span class="cl"><span class="kr">const</span> <span class="nx">City</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="nx">citySchema</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L137"><a class="lnlinks" href="#L137"> 137</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L138"><a class="lnlinks" href="#L138"> 138</a></span><span class="cl"><span class="kr">const</span> <span class="nx">artMuseumSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L139"><a class="lnlinks" href="#L139"> 139</a></span><span class="cl">    <span class="nx">id</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L140"><a class="lnlinks" href="#L140"> 140</a></span><span class="cl">    <span class="nx">city</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="c1">// Legacy field
</span></span></span><span class="line"><span class="ln" id="L141"><a class="lnlinks" href="#L141"> 141</a></span><span class="cl"><span class="c1"></span>    <span class="nx">city</span><span class="nx">_code</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="c1">// City code for lookup in CITY table
</span></span></span><span class="line"><span class="ln" id="L142"><a class="lnlinks" href="#L142"> 142</a></span><span class="cl"><span class="c1"></span>    <span class="nx">museum</span><span class="nx">_code</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L143"><a class="lnlinks" href="#L143"> 143</a></span><span class="cl">    <span class="nx">museum</span><span class="nx">_name</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L144"><a class="lnlinks" href="#L144"> 144</a></span><span class="cl">    <span class="nx">state</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L145"><a class="lnlinks" href="#L145"> 145</a></span><span class="cl">    <span class="nx">show</span><span class="o">:</span> <span class="nb">String</span> <span class="c1">// &#39;Y&#39; or &#39;N&#39; to show/hide museum
</span></span></span><span class="line"><span class="ln" id="L146"><a class="lnlinks" href="#L146"> 146</a></span><span class="cl"><span class="c1"></span><span class="p">}</span><span class="p">,</span> <span class="p">{</span> <span class="nx">collection</span><span class="o">:</span> <span class="s1">&#39;INTERESTS_ART_MUSEUM&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L147"><a class="lnlinks" href="#L147"> 147</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L148"><a class="lnlinks" href="#L148"> 148</a></span><span class="cl"><span class="kr">const</span> <span class="nx">ArtMuseum</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;ArtMuseum&#39;</span><span class="p">,</span> <span class="nx">artMuseumSchema</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L149"><a class="lnlinks" href="#L149"> 149</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L150"><a class="lnlinks" href="#L150"> 150</a></span><span class="cl"><span class="c1">// Get Art Museums with City Data
</span></span></span><span class="line"><span class="ln" id="L151"><a class="lnlinks" href="#L151"> 151</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/interests/art-museums&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L152"><a class="lnlinks" href="#L152"> 152</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L153"><a class="lnlinks" href="#L153"> 153</a></span><span class="cl">        <span class="c1">// Filter museums where show=&#39;Y&#39;
</span></span></span><span class="line"><span class="ln" id="L154"><a class="lnlinks" href="#L154"> 154</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">museums</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">ArtMuseum</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="p">{</span> <span class="nx">show</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L155"><a class="lnlinks" href="#L155"> 155</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L156"><a class="lnlinks" href="#L156"> 156</a></span><span class="cl">        <span class="c1">// Google Cloud Storage bucket configuration
</span></span></span><span class="line"><span class="ln" id="L157"><a class="lnlinks" href="#L157"> 157</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">GCS</span><span class="nx">_BUCKET</span><span class="nx">_NAME</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GCS</span><span class="nx">_BUCKET</span><span class="nx">_NAME</span> <span class="o">||</span> <span class="s1">&#39;distilledchild&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L158"><a class="lnlinks" href="#L158"> 158</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L159"><a class="lnlinks" href="#L159"> 159</a></span><span class="cl">        <span class="c1">// Enrich museums with city data (coordinates and full name) and state data (fips_code)
</span></span></span><span class="line"><span class="ln" id="L160"><a class="lnlinks" href="#L160"> 160</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">enrichedMuseums</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">museums</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kr">async</span> <span class="p">(</span><span class="nx">museum</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L161"><a class="lnlinks" href="#L161"> 161</a></span><span class="cl">            <span class="c1">// Find city by code - museum.city_code or museum.city contains the city code
</span></span></span><span class="line"><span class="ln" id="L162"><a class="lnlinks" href="#L162"> 162</a></span><span class="cl"><span class="c1"></span>            <span class="kr">const</span> <span class="nx">cityCode</span> <span class="o">=</span> <span class="nx">museum</span><span class="p">.</span><span class="nx">city</span><span class="nx">_code</span> <span class="o">||</span> <span class="nx">museum</span><span class="p">.</span><span class="nx">city</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L163"><a class="lnlinks" href="#L163"> 163</a></span><span class="cl">            <span class="kr">const</span> <span class="nx">cityData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">City</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span> <span class="nx">city</span><span class="nx">_code</span><span class="o">:</span> <span class="nx">cityCode</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L164"><a class="lnlinks" href="#L164"> 164</a></span><span class="cl">            <span class="c1">// Find state by code to get fips_code
</span></span></span><span class="line"><span class="ln" id="L165"><a class="lnlinks" href="#L165"> 165</a></span><span class="cl"><span class="c1"></span>            <span class="kr">const</span> <span class="nx">stateData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">State</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span> <span class="nx">code</span><span class="o">:</span> <span class="nx">museum</span><span class="p">.</span><span class="nx">state</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L166"><a class="lnlinks" href="#L166"> 166</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L167"><a class="lnlinks" href="#L167"> 167</a></span><span class="cl">            <span class="c1">// Log for debugging
</span></span></span><span class="line"><span class="ln" id="L168"><a class="lnlinks" href="#L168"> 168</a></span><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cityData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L169"><a class="lnlinks" href="#L169"> 169</a></span><span class="cl">                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">City not found for code: </span><span class="si">${</span><span class="nx">cityCode</span><span class="si">}</span><span class="sb">, museum: </span><span class="si">${</span><span class="nx">museum</span><span class="p">.</span><span class="nx">museum</span><span class="nx">_name</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L170"><a class="lnlinks" href="#L170"> 170</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L171"><a class="lnlinks" href="#L171"> 171</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L172"><a class="lnlinks" href="#L172"> 172</a></span><span class="cl">            <span class="c1">// Load artworks from GCS bucket
</span></span></span><span class="line"><span class="ln" id="L173"><a class="lnlinks" href="#L173"> 173</a></span><span class="cl"><span class="c1"></span>            <span class="kd">let</span> <span class="nx">artworks</span> <span class="o">=</span> <span class="p">[</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L174"><a class="lnlinks" href="#L174"> 174</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L175"><a class="lnlinks" href="#L175"> 175</a></span><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">museum</span><span class="p">.</span><span class="nx">museum</span><span class="nx">_code</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L176"><a class="lnlinks" href="#L176"> 176</a></span><span class="cl">                <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L177"><a class="lnlinks" href="#L177"> 177</a></span><span class="cl">                    <span class="c1">// Generate signed URLs for all images in museum folder
</span></span></span><span class="line"><span class="ln" id="L178"><a class="lnlinks" href="#L178"> 178</a></span><span class="cl"><span class="c1"></span>                    <span class="nx">artworks</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">generateSignedUrlsForPrefix</span><span class="p">(</span>
</span></span><span class="line"><span class="ln" id="L179"><a class="lnlinks" href="#L179"> 179</a></span><span class="cl">                        <span class="nx">storage</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L180"><a class="lnlinks" href="#L180"> 180</a></span><span class="cl">                        <span class="nx">GCS</span><span class="nx">_BUCKET</span><span class="nx">_NAME</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L181"><a class="lnlinks" href="#L181"> 181</a></span><span class="cl">                        <span class="sb">`</span><span class="sb">interests/art/</span><span class="si">${</span><span class="nx">museum</span><span class="p">.</span><span class="nx">museum</span><span class="nx">_code</span><span class="si">}</span><span class="sb">/</span><span class="sb">`</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L182"><a class="lnlinks" href="#L182"> 182</a></span><span class="cl">                        <span class="sr">/\.(png|jpg|jpeg|gif|webp)$/i</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L183"><a class="lnlinks" href="#L183"> 183</a></span><span class="cl">                        <span class="mi">60</span> <span class="c1">// 1 hour expiry
</span></span></span><span class="line"><span class="ln" id="L184"><a class="lnlinks" href="#L184"> 184</a></span><span class="cl"><span class="c1"></span>                    <span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L185"><a class="lnlinks" href="#L185"> 185</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L186"><a class="lnlinks" href="#L186"> 186</a></span><span class="cl">                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Loaded </span><span class="si">${</span><span class="nx">artworks</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> artworks for </span><span class="si">${</span><span class="nx">museum</span><span class="p">.</span><span class="nx">museum</span><span class="nx">_code</span><span class="si">}</span><span class="sb"> from GCS (signed URLs)</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L187"><a class="lnlinks" href="#L187"> 187</a></span><span class="cl">                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L188"><a class="lnlinks" href="#L188"> 188</a></span><span class="cl">                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Error reading GCS bucket for </span><span class="si">${</span><span class="nx">museum</span><span class="p">.</span><span class="nx">museum</span><span class="nx">_code</span><span class="si">}</span><span class="sb">:</span><span class="sb">`</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L189"><a class="lnlinks" href="#L189"> 189</a></span><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L190"><a class="lnlinks" href="#L190"> 190</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L191"><a class="lnlinks" href="#L191"> 191</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L192"><a class="lnlinks" href="#L192"> 192</a></span><span class="cl">            <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L193"><a class="lnlinks" href="#L193"> 193</a></span><span class="cl">                <span class="p">...</span><span class="nx">museum</span><span class="p">.</span><span class="nx">toObject</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L194"><a class="lnlinks" href="#L194"> 194</a></span><span class="cl">                <span class="nx">city</span><span class="nx">_name</span><span class="o">:</span> <span class="nx">cityData</span> <span class="o">?</span> <span class="nx">cityData</span><span class="p">.</span><span class="nx">city</span><span class="nx">_name</span> <span class="o">:</span> <span class="nx">cityCode</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L195"><a class="lnlinks" href="#L195"> 195</a></span><span class="cl">                <span class="c1">// Use city coordinates if available, otherwise null.
</span></span></span><span class="line"><span class="ln" id="L196"><a class="lnlinks" href="#L196"> 196</a></span><span class="cl"><span class="c1"></span>                <span class="c1">// Format: [longitude, latitude] for d3-geo
</span></span></span><span class="line"><span class="ln" id="L197"><a class="lnlinks" href="#L197"> 197</a></span><span class="cl"><span class="c1"></span>                <span class="nx">coordinates</span><span class="o">:</span> <span class="p">(</span><span class="nx">cityData</span> <span class="o">&amp;&amp;</span> <span class="nx">cityData</span><span class="p">.</span><span class="nx">longitude</span> <span class="o">&amp;&amp;</span> <span class="nx">cityData</span><span class="p">.</span><span class="nx">latitude</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="L198"><a class="lnlinks" href="#L198"> 198</a></span><span class="cl">                    <span class="o">?</span> <span class="p">[</span><span class="nx">cityData</span><span class="p">.</span><span class="nx">longitude</span><span class="p">,</span> <span class="nx">cityData</span><span class="p">.</span><span class="nx">latitude</span><span class="p">]</span>
</span></span><span class="line"><span class="ln" id="L199"><a class="lnlinks" href="#L199"> 199</a></span><span class="cl">                    <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L200"><a class="lnlinks" href="#L200"> 200</a></span><span class="cl">                <span class="nx">fips</span><span class="nx">_code</span><span class="o">:</span> <span class="nx">stateData</span> <span class="o">?</span> <span class="nx">stateData</span><span class="p">.</span><span class="nx">fips</span><span class="nx">_code</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L201"><a class="lnlinks" href="#L201"> 201</a></span><span class="cl">                <span class="nx">artworks</span><span class="o">:</span> <span class="nx">artworks</span>
</span></span><span class="line"><span class="ln" id="L202"><a class="lnlinks" href="#L202"> 202</a></span><span class="cl">            <span class="p">}</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L203"><a class="lnlinks" href="#L203"> 203</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L204"><a class="lnlinks" href="#L204"> 204</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L205"><a class="lnlinks" href="#L205"> 205</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">enrichedMuseums</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L206"><a class="lnlinks" href="#L206"> 206</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L207"><a class="lnlinks" href="#L207"> 207</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error fetching art museums:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L208"><a class="lnlinks" href="#L208"> 208</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L209"><a class="lnlinks" href="#L209"> 209</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L210"><a class="lnlinks" href="#L210"> 210</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L211"><a class="lnlinks" href="#L211"> 211</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L212"><a class="lnlinks" href="#L212"> 212</a></span><span class="cl"><span class="c1">// Get Signed URLs for HiC Browser data files
</span></span></span><span class="line"><span class="ln" id="L213"><a class="lnlinks" href="#L213"> 213</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/research/hic-data&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L214"><a class="lnlinks" href="#L214"> 214</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L215"><a class="lnlinks" href="#L215"> 215</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">fileName</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L216"><a class="lnlinks" href="#L216"> 216</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L217"><a class="lnlinks" href="#L217"> 217</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L218"><a class="lnlinks" href="#L218"> 218</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;fileName parameter is required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L219"><a class="lnlinks" href="#L219"> 219</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L220"><a class="lnlinks" href="#L220"> 220</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L221"><a class="lnlinks" href="#L221"> 221</a></span><span class="cl">        <span class="c1">// Validate fileName to prevent path traversal
</span></span></span><span class="line"><span class="ln" id="L222"><a class="lnlinks" href="#L222"> 222</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isValidFilePath</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L223"><a class="lnlinks" href="#L223"> 223</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Invalid fileName&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L224"><a class="lnlinks" href="#L224"> 224</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L225"><a class="lnlinks" href="#L225"> 225</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L226"><a class="lnlinks" href="#L226"> 226</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">GCS</span><span class="nx">_BUCKET</span><span class="nx">_NAME</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GCS</span><span class="nx">_BUCKET</span><span class="nx">_NAME</span> <span class="o">||</span> <span class="s1">&#39;distilledchild&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L227"><a class="lnlinks" href="#L227"> 227</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="sb">`</span><span class="sb">research/hic-browser/</span><span class="si">${</span><span class="nx">fileName</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L228"><a class="lnlinks" href="#L228"> 228</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L229"><a class="lnlinks" href="#L229"> 229</a></span><span class="cl">        <span class="c1">// Generate signed URL using helper function
</span></span></span><span class="line"><span class="ln" id="L230"><a class="lnlinks" href="#L230"> 230</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">signedUrl</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">generateSignedUrl</span><span class="p">(</span><span class="nx">storage</span><span class="p">,</span> <span class="nx">GCS</span><span class="nx">_BUCKET</span><span class="nx">_NAME</span><span class="p">,</span> <span class="nx">filePath</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L231"><a class="lnlinks" href="#L231"> 231</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L232"><a class="lnlinks" href="#L232"> 232</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">signedUrl</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L233"><a class="lnlinks" href="#L233"> 233</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L234"><a class="lnlinks" href="#L234"> 234</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error generating signed URL for HiC data:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L235"><a class="lnlinks" href="#L235"> 235</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L236"><a class="lnlinks" href="#L236"> 236</a></span><span class="cl">        <span class="c1">// Return appropriate error based on error message
</span></span></span><span class="line"><span class="ln" id="L237"><a class="lnlinks" href="#L237"> 237</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;not found&#39;</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L238"><a class="lnlinks" href="#L238"> 238</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;File not found&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L239"><a class="lnlinks" href="#L239"> 239</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L240"><a class="lnlinks" href="#L240"> 240</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L241"><a class="lnlinks" href="#L241"> 241</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L242"><a class="lnlinks" href="#L242"> 242</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L243"><a class="lnlinks" href="#L243"> 243</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L244"><a class="lnlinks" href="#L244"> 244</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L245"><a class="lnlinks" href="#L245"> 245</a></span><span class="cl"><span class="kr">const</span> <span class="nx">techBlogSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L246"><a class="lnlinks" href="#L246"> 246</a></span><span class="cl">    <span class="nx">category</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L247"><a class="lnlinks" href="#L247"> 247</a></span><span class="cl">    <span class="nx">title</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L248"><a class="lnlinks" href="#L248"> 248</a></span><span class="cl">    <span class="nx">content</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L249"><a class="lnlinks" href="#L249"> 249</a></span><span class="cl">    <span class="nx">likes</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L250"><a class="lnlinks" href="#L250"> 250</a></span><span class="cl">    <span class="nx">views</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L251"><a class="lnlinks" href="#L251"> 251</a></span><span class="cl">    <span class="nx">createdAt</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L252"><a class="lnlinks" href="#L252"> 252</a></span><span class="cl">    <span class="nx">updatedAt</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L253"><a class="lnlinks" href="#L253"> 253</a></span><span class="cl">    <span class="nx">isPublished</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Boolean</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L254"><a class="lnlinks" href="#L254"> 254</a></span><span class="cl">    <span class="nx">slug</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L255"><a class="lnlinks" href="#L255"> 255</a></span><span class="cl">    <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L256"><a class="lnlinks" href="#L256"> 256</a></span><span class="cl">    <span class="nx">author</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L257"><a class="lnlinks" href="#L257"> 257</a></span><span class="cl">        <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L258"><a class="lnlinks" href="#L258"> 258</a></span><span class="cl">        <span class="nx">email</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L259"><a class="lnlinks" href="#L259"> 259</a></span><span class="cl">        <span class="nx">avatar</span><span class="o">:</span> <span class="nb">String</span>
</span></span><span class="line"><span class="ln" id="L260"><a class="lnlinks" href="#L260"> 260</a></span><span class="cl">    <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L261"><a class="lnlinks" href="#L261"> 261</a></span><span class="cl">    <span class="nx">likedBy</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span> <span class="p">}</span><span class="p">]</span><span class="p">,</span>  <span class="c1">// Array of email strings
</span></span></span><span class="line"><span class="ln" id="L262"><a class="lnlinks" href="#L262"> 262</a></span><span class="cl"><span class="c1"></span>    <span class="nx">show</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span> <span class="p">}</span>  <span class="c1">// &#39;Y&#39; or &#39;N&#39;
</span></span></span><span class="line"><span class="ln" id="L263"><a class="lnlinks" href="#L263"> 263</a></span><span class="cl"><span class="c1"></span><span class="p">}</span><span class="p">,</span> <span class="p">{</span> <span class="nx">collection</span><span class="o">:</span> <span class="s1">&#39;TECH_BLOG&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L264"><a class="lnlinks" href="#L264"> 264</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L265"><a class="lnlinks" href="#L265"> 265</a></span><span class="cl"><span class="kr">const</span> <span class="nx">TechBlog</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;TechBlog&#39;</span><span class="p">,</span> <span class="nx">techBlogSchema</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L266"><a class="lnlinks" href="#L266"> 266</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L267"><a class="lnlinks" href="#L267"> 267</a></span><span class="cl"><span class="c1">// Workout Schema for Strava activities
</span></span></span><span class="line"><span class="ln" id="L268"><a class="lnlinks" href="#L268"> 268</a></span><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">workoutSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L269"><a class="lnlinks" href="#L269"> 269</a></span><span class="cl">    <span class="nx">activity</span><span class="nx">_id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span> <span class="nx">unique</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L270"><a class="lnlinks" href="#L270"> 270</a></span><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L271"><a class="lnlinks" href="#L271"> 271</a></span><span class="cl">    <span class="nx">distance</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L272"><a class="lnlinks" href="#L272"> 272</a></span><span class="cl">    <span class="nx">moving</span><span class="nx">_time</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L273"><a class="lnlinks" href="#L273"> 273</a></span><span class="cl">    <span class="nx">elapsed</span><span class="nx">_time</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L274"><a class="lnlinks" href="#L274"> 274</a></span><span class="cl">    <span class="nx">total</span><span class="nx">_elevation</span><span class="nx">_gain</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L275"><a class="lnlinks" href="#L275"> 275</a></span><span class="cl">    <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L276"><a class="lnlinks" href="#L276"> 276</a></span><span class="cl">    <span class="nx">sport</span><span class="nx">_type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L277"><a class="lnlinks" href="#L277"> 277</a></span><span class="cl">    <span class="nx">start</span><span class="nx">_date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L278"><a class="lnlinks" href="#L278"> 278</a></span><span class="cl">    <span class="nx">start</span><span class="nx">_date</span><span class="nx">_local</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L279"><a class="lnlinks" href="#L279"> 279</a></span><span class="cl">    <span class="nx">average</span><span class="nx">_speed</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L280"><a class="lnlinks" href="#L280"> 280</a></span><span class="cl">    <span class="nx">max</span><span class="nx">_speed</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L281"><a class="lnlinks" href="#L281"> 281</a></span><span class="cl">    <span class="nx">athlete</span><span class="nx">_id</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L282"><a class="lnlinks" href="#L282"> 282</a></span><span class="cl">    <span class="nx">insertedAt</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L283"><a class="lnlinks" href="#L283"> 283</a></span><span class="cl">    <span class="nx">createdAt</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L284"><a class="lnlinks" href="#L284"> 284</a></span><span class="cl"><span class="p">}</span><span class="p">,</span> <span class="p">{</span> <span class="nx">collection</span><span class="o">:</span> <span class="s1">&#39;INTERESTS_WORKOUT&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L285"><a class="lnlinks" href="#L285"> 285</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L286"><a class="lnlinks" href="#L286"> 286</a></span><span class="cl"><span class="kr">const</span> <span class="nx">Workout</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Workout&#39;</span><span class="p">,</span> <span class="nx">workoutSchema</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L287"><a class="lnlinks" href="#L287"> 287</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L288"><a class="lnlinks" href="#L288"> 288</a></span><span class="cl"><span class="c1">// TODO List Schema
</span></span></span><span class="line"><span class="ln" id="L289"><a class="lnlinks" href="#L289"> 289</a></span><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">todoListSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L290"><a class="lnlinks" href="#L290"> 290</a></span><span class="cl">    <span class="nx">email</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L291"><a class="lnlinks" href="#L291"> 291</a></span><span class="cl">    <span class="nx">category</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="kr">enum</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;personal&#39;</span><span class="p">,</span> <span class="s1">&#39;dev&#39;</span><span class="p">]</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="s1">&#39;personal&#39;</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L292"><a class="lnlinks" href="#L292"> 292</a></span><span class="cl">    <span class="nx">title</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L293"><a class="lnlinks" href="#L293"> 293</a></span><span class="cl">    <span class="nx">description</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L294"><a class="lnlinks" href="#L294"> 294</a></span><span class="cl">    <span class="nx">status</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="kr">enum</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span> <span class="s1">&#39;in_progress&#39;</span><span class="p">,</span> <span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="s1">&#39;pending&#39;</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L295"><a class="lnlinks" href="#L295"> 295</a></span><span class="cl">    <span class="nx">priority</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="kr">enum</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="s1">&#39;medium&#39;</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L296"><a class="lnlinks" href="#L296"> 296</a></span><span class="cl">    <span class="nx">due</span><span class="nx">_date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L297"><a class="lnlinks" href="#L297"> 297</a></span><span class="cl">    <span class="nx">start</span><span class="nx">_time</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L298"><a class="lnlinks" href="#L298"> 298</a></span><span class="cl">    <span class="nx">end</span><span class="nx">_time</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L299"><a class="lnlinks" href="#L299"> 299</a></span><span class="cl">    <span class="nx">completed</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Boolean</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L300"><a class="lnlinks" href="#L300"> 300</a></span><span class="cl">    <span class="nx">show</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L301"><a class="lnlinks" href="#L301"> 301</a></span><span class="cl">    <span class="nx">sort</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="c1">// Project ID for dev todos
</span></span></span><span class="line"><span class="ln" id="L302"><a class="lnlinks" href="#L302"> 302</a></span><span class="cl"><span class="c1"></span>    <span class="nx">created</span><span class="nx">_at</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L303"><a class="lnlinks" href="#L303"> 303</a></span><span class="cl">    <span class="nx">updated</span><span class="nx">_at</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L304"><a class="lnlinks" href="#L304"> 304</a></span><span class="cl"><span class="p">}</span><span class="p">,</span> <span class="p">{</span> <span class="nx">collection</span><span class="o">:</span> <span class="s1">&#39;TODO_LIST&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L305"><a class="lnlinks" href="#L305"> 305</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L306"><a class="lnlinks" href="#L306"> 306</a></span><span class="cl"><span class="kr">const</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;TodoList&#39;</span><span class="p">,</span> <span class="nx">todoListSchema</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L307"><a class="lnlinks" href="#L307"> 307</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L308"><a class="lnlinks" href="#L308"> 308</a></span><span class="cl"><span class="c1">// Contact Schema
</span></span></span><span class="line"><span class="ln" id="L309"><a class="lnlinks" href="#L309"> 309</a></span><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">contactSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L310"><a class="lnlinks" href="#L310"> 310</a></span><span class="cl">    <span class="nx">Email</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L311"><a class="lnlinks" href="#L311"> 311</a></span><span class="cl">    <span class="nx">GitHub</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L312"><a class="lnlinks" href="#L312"> 312</a></span><span class="cl">    <span class="nx">LinkedIn</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L313"><a class="lnlinks" href="#L313"> 313</a></span><span class="cl">    <span class="nx">Location</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L314"><a class="lnlinks" href="#L314"> 314</a></span><span class="cl">        <span class="nx">city</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L315"><a class="lnlinks" href="#L315"> 315</a></span><span class="cl">        <span class="nx">state</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L316"><a class="lnlinks" href="#L316"> 316</a></span><span class="cl">        <span class="nx">country</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L317"><a class="lnlinks" href="#L317"> 317</a></span><span class="cl">        <span class="nx">latitude</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L318"><a class="lnlinks" href="#L318"> 318</a></span><span class="cl">        <span class="nx">longitude</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L319"><a class="lnlinks" href="#L319"> 319</a></span><span class="cl">        <span class="nx">ip</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L320"><a class="lnlinks" href="#L320"> 320</a></span><span class="cl">        <span class="nx">timezone</span><span class="o">:</span> <span class="nb">String</span>
</span></span><span class="line"><span class="ln" id="L321"><a class="lnlinks" href="#L321"> 321</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L322"><a class="lnlinks" href="#L322"> 322</a></span><span class="cl"><span class="p">}</span><span class="p">,</span> <span class="p">{</span> <span class="nx">collection</span><span class="o">:</span> <span class="s1">&#39;CONTACT&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L323"><a class="lnlinks" href="#L323"> 323</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L324"><a class="lnlinks" href="#L324"> 324</a></span><span class="cl"><span class="kr">const</span> <span class="nx">Contact</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Contact&#39;</span><span class="p">,</span> <span class="nx">contactSchema</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L325"><a class="lnlinks" href="#L325"> 325</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L326"><a class="lnlinks" href="#L326"> 326</a></span><span class="cl"><span class="c1">// Google OAuth Endpoint
</span></span></span><span class="line"><span class="ln" id="L327"><a class="lnlinks" href="#L327"> 327</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/auth/google&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L328"><a class="lnlinks" href="#L328"> 328</a></span><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L329"><a class="lnlinks" href="#L329"> 329</a></span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">code</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;No code provided&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L330"><a class="lnlinks" href="#L330"> 330</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L331"><a class="lnlinks" href="#L331"> 331</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L332"><a class="lnlinks" href="#L332"> 332</a></span><span class="cl">        <span class="c1">// 1. Exchange code for tokens
</span></span></span><span class="line"><span class="ln" id="L333"><a class="lnlinks" href="#L333"> 333</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">tokenResponse</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://oauth2.googleapis.com/token&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L334"><a class="lnlinks" href="#L334"> 334</a></span><span class="cl">            <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L335"><a class="lnlinks" href="#L335"> 335</a></span><span class="cl">            <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L336"><a class="lnlinks" href="#L336"> 336</a></span><span class="cl">            <span class="nx">body</span><span class="o">:</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L337"><a class="lnlinks" href="#L337"> 337</a></span><span class="cl">                <span class="nx">code</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L338"><a class="lnlinks" href="#L338"> 338</a></span><span class="cl">                <span class="nx">client</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">GOOGLE</span><span class="nx">_CLIENT</span><span class="nx">_ID</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L339"><a class="lnlinks" href="#L339"> 339</a></span><span class="cl">                <span class="nx">client</span><span class="nx">_secret</span><span class="o">:</span> <span class="nx">GOOGLE</span><span class="nx">_CLIENT</span><span class="nx">_SECRET</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L340"><a class="lnlinks" href="#L340"> 340</a></span><span class="cl">                <span class="nx">redirect</span><span class="nx">_uri</span><span class="o">:</span> <span class="nx">REDIRECT</span><span class="nx">_URI</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L341"><a class="lnlinks" href="#L341"> 341</a></span><span class="cl">                <span class="nx">grant</span><span class="nx">_type</span><span class="o">:</span> <span class="s1">&#39;authorization_code&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L342"><a class="lnlinks" href="#L342"> 342</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L343"><a class="lnlinks" href="#L343"> 343</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L344"><a class="lnlinks" href="#L344"> 344</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L345"><a class="lnlinks" href="#L345"> 345</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">tokenData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">tokenResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L346"><a class="lnlinks" href="#L346"> 346</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">tokenResponse</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L347"><a class="lnlinks" href="#L347"> 347</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Token exchange failed:&#39;</span><span class="p">,</span> <span class="nx">tokenData</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L348"><a class="lnlinks" href="#L348"> 348</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Failed to exchange token&#39;</span><span class="p">,</span> <span class="nx">details</span><span class="o">:</span> <span class="nx">tokenData</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L349"><a class="lnlinks" href="#L349"> 349</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L350"><a class="lnlinks" href="#L350"> 350</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L351"><a class="lnlinks" href="#L351"> 351</a></span><span class="cl">        <span class="c1">// 2. Get User Profile
</span></span></span><span class="line"><span class="ln" id="L352"><a class="lnlinks" href="#L352"> 352</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">userResponse</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://www.googleapis.com/oauth2/v2/userinfo&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L353"><a class="lnlinks" href="#L353"> 353</a></span><span class="cl">            <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="nx">Authorization</span><span class="o">:</span> <span class="sb">`</span><span class="sb">Bearer </span><span class="si">${</span><span class="nx">tokenData</span><span class="p">.</span><span class="nx">access</span><span class="nx">_token</span><span class="si">}</span><span class="sb">`</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L354"><a class="lnlinks" href="#L354"> 354</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L355"><a class="lnlinks" href="#L355"> 355</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L356"><a class="lnlinks" href="#L356"> 356</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">userData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">userResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L357"><a class="lnlinks" href="#L357"> 357</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">userResponse</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L358"><a class="lnlinks" href="#L358"> 358</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Failed to get user info&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L359"><a class="lnlinks" href="#L359"> 359</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L360"><a class="lnlinks" href="#L360"> 360</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L361"><a class="lnlinks" href="#L361"> 361</a></span><span class="cl">        <span class="c1">// 3. Check Member Role
</span></span></span><span class="line"><span class="ln" id="L362"><a class="lnlinks" href="#L362"> 362</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">member</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Member</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span> <span class="nx">email</span><span class="o">:</span> <span class="nx">userData</span><span class="p">.</span><span class="nx">email</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L363"><a class="lnlinks" href="#L363"> 363</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">role</span> <span class="o">=</span> <span class="nx">member</span> <span class="o">?</span> <span class="nx">member</span><span class="p">.</span><span class="nx">role</span> <span class="o">:</span> <span class="s1">&#39;guest&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L364"><a class="lnlinks" href="#L364"> 364</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L365"><a class="lnlinks" href="#L365"> 365</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L366"><a class="lnlinks" href="#L366"> 366</a></span><span class="cl">            <span class="nx">name</span><span class="o">:</span> <span class="nx">userData</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L367"><a class="lnlinks" href="#L367"> 367</a></span><span class="cl">            <span class="nx">email</span><span class="o">:</span> <span class="nx">userData</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L368"><a class="lnlinks" href="#L368"> 368</a></span><span class="cl">            <span class="nx">picture</span><span class="o">:</span> <span class="nx">userData</span><span class="p">.</span><span class="nx">picture</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L369"><a class="lnlinks" href="#L369"> 369</a></span><span class="cl">            <span class="nx">role</span><span class="o">:</span> <span class="nx">role</span>
</span></span><span class="line"><span class="ln" id="L370"><a class="lnlinks" href="#L370"> 370</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L371"><a class="lnlinks" href="#L371"> 371</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L372"><a class="lnlinks" href="#L372"> 372</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L373"><a class="lnlinks" href="#L373"> 373</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error exchanging token:&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span> <span class="o">||</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L374"><a class="lnlinks" href="#L374"> 374</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Failed to authenticate&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L375"><a class="lnlinks" href="#L375"> 375</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L376"><a class="lnlinks" href="#L376"> 376</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L377"><a class="lnlinks" href="#L377"> 377</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L378"><a class="lnlinks" href="#L378"> 378</a></span><span class="cl"><span class="c1">// Travel States Endpoint
</span></span></span><span class="line"><span class="ln" id="L379"><a class="lnlinks" href="#L379"> 379</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/travel/states&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L380"><a class="lnlinks" href="#L380"> 380</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L381"><a class="lnlinks" href="#L381"> 381</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">states</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">State</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="p">{</span><span class="p">}</span><span class="p">,</span> <span class="s1">&#39;code status fips_code&#39;</span><span class="p">)</span><span class="p">;</span> <span class="c1">//fips_code is the state code added
</span></span></span><span class="line"><span class="ln" id="L382"><a class="lnlinks" href="#L382"> 382</a></span><span class="cl"><span class="c1"></span>        <span class="c1">// console.log(&#34;It&#39;s backend::::::::::::::::::::::::::::::::::&#34; + JSON.stringify(states, null, 2));
</span></span></span><span class="line"><span class="ln" id="L383"><a class="lnlinks" href="#L383"> 383</a></span><span class="cl"><span class="c1"></span>        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">states</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L384"><a class="lnlinks" href="#L384"> 384</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L385"><a class="lnlinks" href="#L385"> 385</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L386"><a class="lnlinks" href="#L386"> 386</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L387"><a class="lnlinks" href="#L387"> 387</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L388"><a class="lnlinks" href="#L388"> 388</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L389"><a class="lnlinks" href="#L389"> 389</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L390"><a class="lnlinks" href="#L390"> 390</a></span><span class="cl"><span class="c1">// Tech and Bio Endpoint
</span></span></span><span class="line"><span class="ln" id="L391"><a class="lnlinks" href="#L391"> 391</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/tech-blog&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L392"><a class="lnlinks" href="#L392"> 392</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L393"><a class="lnlinks" href="#L393"> 393</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">blogs</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">TechBlog</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="p">{</span> <span class="nx">isPublished</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">show</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span> <span class="p">}</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="L394"><a class="lnlinks" href="#L394"> 394</a></span><span class="cl">            <span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="p">{</span> <span class="nx">createdAt</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L395"><a class="lnlinks" href="#L395"> 395</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">blogs</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L396"><a class="lnlinks" href="#L396"> 396</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L397"><a class="lnlinks" href="#L397"> 397</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L398"><a class="lnlinks" href="#L398"> 398</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L399"><a class="lnlinks" href="#L399"> 399</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L400"><a class="lnlinks" href="#L400"> 400</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L401"><a class="lnlinks" href="#L401"> 401</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L402"><a class="lnlinks" href="#L402"> 402</a></span><span class="cl"><span class="c1">// Create Tech and Bio Post
</span></span></span><span class="line"><span class="ln" id="L403"><a class="lnlinks" href="#L403"> 403</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/tech-blog&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L404"><a class="lnlinks" href="#L404"> 404</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L405"><a class="lnlinks" href="#L405"> 405</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TECH-BLOG] POST request received:&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L406"><a class="lnlinks" href="#L406"> 406</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TECH-BLOG] Tags received:&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">tags</span><span class="p">,</span> <span class="s1">&#39;Type:&#39;</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L407"><a class="lnlinks" href="#L407"> 407</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">category</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">author</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L408"><a class="lnlinks" href="#L408"> 408</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L409"><a class="lnlinks" href="#L409"> 409</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">category</span> <span class="o">||</span> <span class="o">!</span><span class="nx">title</span> <span class="o">||</span> <span class="o">!</span><span class="nx">content</span> <span class="o">||</span> <span class="o">!</span><span class="nx">author</span> <span class="o">||</span> <span class="o">!</span><span class="nx">author</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L410"><a class="lnlinks" href="#L410"> 410</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[TECH-BLOG] Missing required fields&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L411"><a class="lnlinks" href="#L411"> 411</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Category, title, content, and author are required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L412"><a class="lnlinks" href="#L412"> 412</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L413"><a class="lnlinks" href="#L413"> 413</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L414"><a class="lnlinks" href="#L414"> 414</a></span><span class="cl">        <span class="c1">// Check if user is authorized (distilledchild or wellclouder)
</span></span></span><span class="line"><span class="ln" id="L415"><a class="lnlinks" href="#L415"> 415</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L416"><a class="lnlinks" href="#L416"> 416</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">author</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L417"><a class="lnlinks" href="#L417"> 417</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[TECH-BLOG] Unauthorized email:&#39;</span><span class="p">,</span> <span class="nx">author</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L418"><a class="lnlinks" href="#L418"> 418</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized: Only authorized users can create posts&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L419"><a class="lnlinks" href="#L419"> 419</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L420"><a class="lnlinks" href="#L420"> 420</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L421"><a class="lnlinks" href="#L421"> 421</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">newBlog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TechBlog</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L422"><a class="lnlinks" href="#L422"> 422</a></span><span class="cl">            <span class="nx">category</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L423"><a class="lnlinks" href="#L423"> 423</a></span><span class="cl">            <span class="nx">title</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L424"><a class="lnlinks" href="#L424"> 424</a></span><span class="cl">            <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L425"><a class="lnlinks" href="#L425"> 425</a></span><span class="cl">            <span class="nx">author</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L426"><a class="lnlinks" href="#L426"> 426</a></span><span class="cl">                <span class="nx">name</span><span class="o">:</span> <span class="nx">author</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L427"><a class="lnlinks" href="#L427"> 427</a></span><span class="cl">                <span class="nx">email</span><span class="o">:</span> <span class="nx">author</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L428"><a class="lnlinks" href="#L428"> 428</a></span><span class="cl">                <span class="nx">avatar</span><span class="o">:</span> <span class="nx">author</span><span class="p">.</span><span class="nx">avatar</span>
</span></span><span class="line"><span class="ln" id="L429"><a class="lnlinks" href="#L429"> 429</a></span><span class="cl">            <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L430"><a class="lnlinks" href="#L430"> 430</a></span><span class="cl">            <span class="nx">likes</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L431"><a class="lnlinks" href="#L431"> 431</a></span><span class="cl">            <span class="nx">views</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L432"><a class="lnlinks" href="#L432"> 432</a></span><span class="cl">            <span class="nx">createdAt</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L433"><a class="lnlinks" href="#L433"> 433</a></span><span class="cl">            <span class="nx">updatedAt</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L434"><a class="lnlinks" href="#L434"> 434</a></span><span class="cl">            <span class="nx">isPublished</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L435"><a class="lnlinks" href="#L435"> 435</a></span><span class="cl">            <span class="nx">show</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L436"><a class="lnlinks" href="#L436"> 436</a></span><span class="cl">            <span class="nx">likedBy</span><span class="o">:</span> <span class="p">[</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L437"><a class="lnlinks" href="#L437"> 437</a></span><span class="cl">            <span class="nx">tags</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">tags</span> <span class="o">||</span> <span class="p">[</span><span class="p">]</span>
</span></span><span class="line"><span class="ln" id="L438"><a class="lnlinks" href="#L438"> 438</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L439"><a class="lnlinks" href="#L439"> 439</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L440"><a class="lnlinks" href="#L440"> 440</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">savedBlog</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">newBlog</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L441"><a class="lnlinks" href="#L441"> 441</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TECH-BLOG] Post saved successfully:&#39;</span><span class="p">,</span> <span class="nx">savedBlog</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L442"><a class="lnlinks" href="#L442"> 442</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TECH-BLOG] Saved tags:&#39;</span><span class="p">,</span> <span class="nx">savedBlog</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L443"><a class="lnlinks" href="#L443"> 443</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">savedBlog</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L444"><a class="lnlinks" href="#L444"> 444</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L445"><a class="lnlinks" href="#L445"> 445</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[TECH-BLOG] Error creating post:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L446"><a class="lnlinks" href="#L446"> 446</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L447"><a class="lnlinks" href="#L447"> 447</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L448"><a class="lnlinks" href="#L448"> 448</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L449"><a class="lnlinks" href="#L449"> 449</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L450"><a class="lnlinks" href="#L450"> 450</a></span><span class="cl"><span class="c1">// ... (skip upload-image, opal-generate, like)
</span></span></span><span class="line"><span class="ln" id="L451"><a class="lnlinks" href="#L451"> 451</a></span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln" id="L452"><a class="lnlinks" href="#L452"> 452</a></span><span class="cl"><span class="c1">// Update Tech and Bio Post
</span></span></span><span class="line"><span class="ln" id="L453"><a class="lnlinks" href="#L453"> 453</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;/api/tech-blog/:id&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L454"><a class="lnlinks" href="#L454"> 454</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L455"><a class="lnlinks" href="#L455"> 455</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L456"><a class="lnlinks" href="#L456"> 456</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">[TECH-BLOG] PUT request for id: </span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L457"><a class="lnlinks" href="#L457"> 457</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TECH-BLOG] Tags received:&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">tags</span><span class="p">,</span> <span class="s1">&#39;Type:&#39;</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L458"><a class="lnlinks" href="#L458"> 458</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">category</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L459"><a class="lnlinks" href="#L459"> 459</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L460"><a class="lnlinks" href="#L460"> 460</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L461"><a class="lnlinks" href="#L461"> 461</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Email is required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L462"><a class="lnlinks" href="#L462"> 462</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L463"><a class="lnlinks" href="#L463"> 463</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L464"><a class="lnlinks" href="#L464"> 464</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">blog</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">TechBlog</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L465"><a class="lnlinks" href="#L465"> 465</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">blog</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L466"><a class="lnlinks" href="#L466"> 466</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[TECH-BLOG] Post not found:&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L467"><a class="lnlinks" href="#L467"> 467</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Blog post not found&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L468"><a class="lnlinks" href="#L468"> 468</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L469"><a class="lnlinks" href="#L469"> 469</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L470"><a class="lnlinks" href="#L470"> 470</a></span><span class="cl">        <span class="c1">// Check if user is the author
</span></span></span><span class="line"><span class="ln" id="L471"><a class="lnlinks" href="#L471"> 471</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">blog</span><span class="p">.</span><span class="nx">author</span><span class="p">.</span><span class="nx">email</span> <span class="o">!==</span> <span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L472"><a class="lnlinks" href="#L472"> 472</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[TECH-BLOG] Unauthorized update attempt by:&#39;</span><span class="p">,</span> <span class="nx">email</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L473"><a class="lnlinks" href="#L473"> 473</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized: Only author can update&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L474"><a class="lnlinks" href="#L474"> 474</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L475"><a class="lnlinks" href="#L475"> 475</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L476"><a class="lnlinks" href="#L476"> 476</a></span><span class="cl">        <span class="c1">// Update fields
</span></span></span><span class="line"><span class="ln" id="L477"><a class="lnlinks" href="#L477"> 477</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">category</span><span class="p">)</span> <span class="nx">blog</span><span class="p">.</span><span class="nx">category</span> <span class="o">=</span> <span class="nx">category</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L478"><a class="lnlinks" href="#L478"> 478</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="nx">blog</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">title</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L479"><a class="lnlinks" href="#L479"> 479</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="nx">blog</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">content</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L480"><a class="lnlinks" href="#L480"> 480</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span> <span class="nx">blog</span><span class="p">.</span><span class="nx">tags</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">tags</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L481"><a class="lnlinks" href="#L481"> 481</a></span><span class="cl">        <span class="nx">blog</span><span class="p">.</span><span class="nx">updatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L482"><a class="lnlinks" href="#L482"> 482</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L483"><a class="lnlinks" href="#L483"> 483</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">updatedBlog</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">blog</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L484"><a class="lnlinks" href="#L484"> 484</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TECH-BLOG] Post updated successfully:&#39;</span><span class="p">,</span> <span class="nx">updatedBlog</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L485"><a class="lnlinks" href="#L485"> 485</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TECH-BLOG] Updated tags:&#39;</span><span class="p">,</span> <span class="nx">updatedBlog</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L486"><a class="lnlinks" href="#L486"> 486</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">updatedBlog</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L487"><a class="lnlinks" href="#L487"> 487</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L488"><a class="lnlinks" href="#L488"> 488</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[TECH-BLOG] Error updating post:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L489"><a class="lnlinks" href="#L489"> 489</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L490"><a class="lnlinks" href="#L490"> 490</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L491"><a class="lnlinks" href="#L491"> 491</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L492"><a class="lnlinks" href="#L492"> 492</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L493"><a class="lnlinks" href="#L493"> 493</a></span><span class="cl"><span class="c1">// Upload image to GCS for Tech and Bio
</span></span></span><span class="line"><span class="ln" id="L494"><a class="lnlinks" href="#L494"> 494</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/tech-blog/upload-image&#39;</span><span class="p">,</span> <span class="nx">upload</span><span class="p">.</span><span class="nx">single</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L495"><a class="lnlinks" href="#L495"> 495</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L496"><a class="lnlinks" href="#L496"> 496</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L497"><a class="lnlinks" href="#L497"> 497</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;No image file provided&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L498"><a class="lnlinks" href="#L498"> 498</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L499"><a class="lnlinks" href="#L499"> 499</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L500"><a class="lnlinks" href="#L500"> 500</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">file</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L501"><a class="lnlinks" href="#L501"> 501</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L502"><a class="lnlinks" href="#L502"> 502</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">timestamp</span><span class="si">}</span><span class="sb">-</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">originalname</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/g</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L503"><a class="lnlinks" href="#L503"> 503</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">bucketName</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GCS</span><span class="nx">_BUCKET</span><span class="nx">_NAME</span> <span class="o">||</span> <span class="s1">&#39;distilledchild&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L504"><a class="lnlinks" href="#L504"> 504</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">bucket</span><span class="p">(</span><span class="nx">bucketName</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L505"><a class="lnlinks" href="#L505"> 505</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Request body:&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span><span class="p">;</span>   <span class="c1">// ë°”ë”” ì „ì²´ í™•ì¸
</span></span></span><span class="line"><span class="ln" id="L506"><a class="lnlinks" href="#L506"> 506</a></span><span class="cl"><span class="c1"></span>        <span class="c1">// ì¹´í…Œê³ ë¦¬ ë¶„ê¸°
</span></span></span><span class="line"><span class="ln" id="L507"><a class="lnlinks" href="#L507"> 507</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">category</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">category</span><span class="p">;</span> <span class="c1">// í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ë‹¬
</span></span></span><span class="line"><span class="ln" id="L508"><a class="lnlinks" href="#L508"> 508</a></span><span class="cl"><span class="c1"></span>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Received category:&#39;</span><span class="p">,</span> <span class="nx">category</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L509"><a class="lnlinks" href="#L509"> 509</a></span><span class="cl">        <span class="kd">let</span> <span class="nx">prefix</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L510"><a class="lnlinks" href="#L510"> 510</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">category</span> <span class="o">===</span> <span class="s1">&#39;Biology&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L511"><a class="lnlinks" href="#L511"> 511</a></span><span class="cl">            <span class="nx">prefix</span> <span class="o">=</span> <span class="s1">&#39;blog/bio&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L512"><a class="lnlinks" href="#L512"> 512</a></span><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">category</span> <span class="o">===</span> <span class="s1">&#39;Tech&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L513"><a class="lnlinks" href="#L513"> 513</a></span><span class="cl">            <span class="nx">prefix</span> <span class="o">=</span> <span class="s1">&#39;blog/tech&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L514"><a class="lnlinks" href="#L514"> 514</a></span><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L515"><a class="lnlinks" href="#L515"> 515</a></span><span class="cl">            <span class="c1">// ê¸°ë³¸ê°’
</span></span></span><span class="line"><span class="ln" id="L516"><a class="lnlinks" href="#L516"> 516</a></span><span class="cl"><span class="c1"></span>            <span class="nx">prefix</span> <span class="o">=</span> <span class="s1">&#39;blog/misc&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L517"><a class="lnlinks" href="#L517"> 517</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L518"><a class="lnlinks" href="#L518"> 518</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L519"><a class="lnlinks" href="#L519"> 519</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">blob</span> <span class="o">=</span> <span class="nx">bucket</span><span class="p">.</span><span class="nx">file</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">prefix</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">fileName</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L520"><a class="lnlinks" href="#L520"> 520</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L521"><a class="lnlinks" href="#L521"> 521</a></span><span class="cl">        <span class="c1">// Create a write stream
</span></span></span><span class="line"><span class="ln" id="L522"><a class="lnlinks" href="#L522"> 522</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">blobStream</span> <span class="o">=</span> <span class="nx">blob</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L523"><a class="lnlinks" href="#L523"> 523</a></span><span class="cl">            <span class="nx">resumable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L524"><a class="lnlinks" href="#L524"> 524</a></span><span class="cl">            <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L525"><a class="lnlinks" href="#L525"> 525</a></span><span class="cl">                <span class="nx">contentType</span><span class="o">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">mimetype</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L526"><a class="lnlinks" href="#L526"> 526</a></span><span class="cl">            <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L527"><a class="lnlinks" href="#L527"> 527</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L528"><a class="lnlinks" href="#L528"> 528</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L529"><a class="lnlinks" href="#L529"> 529</a></span><span class="cl">        <span class="nx">blobStream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L530"><a class="lnlinks" href="#L530"> 530</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Upload error:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L531"><a class="lnlinks" href="#L531"> 531</a></span><span class="cl">            <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Failed to upload image&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L532"><a class="lnlinks" href="#L532"> 532</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L533"><a class="lnlinks" href="#L533"> 533</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L534"><a class="lnlinks" href="#L534"> 534</a></span><span class="cl">        <span class="nx">blobStream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;finish&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L535"><a class="lnlinks" href="#L535"> 535</a></span><span class="cl">            <span class="c1">// Make the file public
</span></span></span><span class="line"><span class="ln" id="L536"><a class="lnlinks" href="#L536"> 536</a></span><span class="cl"><span class="c1"></span>            <span class="kr">await</span> <span class="nx">blob</span><span class="p">.</span><span class="nx">makePublic</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L537"><a class="lnlinks" href="#L537"> 537</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L538"><a class="lnlinks" href="#L538"> 538</a></span><span class="cl">            <span class="c1">// Generate public URL
</span></span></span><span class="line"><span class="ln" id="L539"><a class="lnlinks" href="#L539"> 539</a></span><span class="cl"><span class="c1"></span>            <span class="kr">const</span> <span class="nx">publicUrl</span> <span class="o">=</span> <span class="sb">`</span><span class="sb">https://storage.googleapis.com/</span><span class="si">${</span><span class="nx">bucketName</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">prefix</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">fileName</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L540"><a class="lnlinks" href="#L540"> 540</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L541"><a class="lnlinks" href="#L541"> 541</a></span><span class="cl">            <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L542"><a class="lnlinks" href="#L542"> 542</a></span><span class="cl">                <span class="nx">success</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L543"><a class="lnlinks" href="#L543"> 543</a></span><span class="cl">                <span class="nx">url</span><span class="o">:</span> <span class="nx">publicUrl</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L544"><a class="lnlinks" href="#L544"> 544</a></span><span class="cl">                <span class="nx">fileName</span><span class="o">:</span> <span class="nx">fileName</span>
</span></span><span class="line"><span class="ln" id="L545"><a class="lnlinks" href="#L545"> 545</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L546"><a class="lnlinks" href="#L546"> 546</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L547"><a class="lnlinks" href="#L547"> 547</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L548"><a class="lnlinks" href="#L548"> 548</a></span><span class="cl">        <span class="c1">// Write the file buffer to GCS
</span></span></span><span class="line"><span class="ln" id="L549"><a class="lnlinks" href="#L549"> 549</a></span><span class="cl"><span class="c1"></span>        <span class="nx">blobStream</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L550"><a class="lnlinks" href="#L550"> 550</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L551"><a class="lnlinks" href="#L551"> 551</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Image upload error:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L552"><a class="lnlinks" href="#L552"> 552</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L553"><a class="lnlinks" href="#L553"> 553</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L554"><a class="lnlinks" href="#L554"> 554</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L555"><a class="lnlinks" href="#L555"> 555</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L556"><a class="lnlinks" href="#L556"> 556</a></span><span class="cl"><span class="c1">// Like/Unlike Tech and Bio Post
</span></span></span><span class="line"><span class="ln" id="L557"><a class="lnlinks" href="#L557"> 557</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/tech-blog/:id/like&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L558"><a class="lnlinks" href="#L558"> 558</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L559"><a class="lnlinks" href="#L559"> 559</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L560"><a class="lnlinks" href="#L560"> 560</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L561"><a class="lnlinks" href="#L561"> 561</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L562"><a class="lnlinks" href="#L562"> 562</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L563"><a class="lnlinks" href="#L563"> 563</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Email is required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L564"><a class="lnlinks" href="#L564"> 564</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L565"><a class="lnlinks" href="#L565"> 565</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L566"><a class="lnlinks" href="#L566"> 566</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">blog</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">TechBlog</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L567"><a class="lnlinks" href="#L567"> 567</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">blog</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L568"><a class="lnlinks" href="#L568"> 568</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Blog post not found&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L569"><a class="lnlinks" href="#L569"> 569</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L570"><a class="lnlinks" href="#L570"> 570</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L571"><a class="lnlinks" href="#L571"> 571</a></span><span class="cl">        <span class="c1">// Initialize likedBy if it doesn&#39;t exist
</span></span></span><span class="line"><span class="ln" id="L572"><a class="lnlinks" href="#L572"> 572</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">blog</span><span class="p">.</span><span class="nx">likedBy</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L573"><a class="lnlinks" href="#L573"> 573</a></span><span class="cl">            <span class="nx">blog</span><span class="p">.</span><span class="nx">likedBy</span> <span class="o">=</span> <span class="p">[</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L574"><a class="lnlinks" href="#L574"> 574</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L575"><a class="lnlinks" href="#L575"> 575</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L576"><a class="lnlinks" href="#L576"> 576</a></span><span class="cl">        <span class="c1">// Check if user already liked (by email)
</span></span></span><span class="line"><span class="ln" id="L577"><a class="lnlinks" href="#L577"> 577</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">likedIndex</span> <span class="o">=</span> <span class="nx">blog</span><span class="p">.</span><span class="nx">likedBy</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L578"><a class="lnlinks" href="#L578"> 578</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L579"><a class="lnlinks" href="#L579"> 579</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">likedIndex</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L580"><a class="lnlinks" href="#L580"> 580</a></span><span class="cl">            <span class="c1">// Unlike: remove email from likedBy
</span></span></span><span class="line"><span class="ln" id="L581"><a class="lnlinks" href="#L581"> 581</a></span><span class="cl"><span class="c1"></span>            <span class="nx">blog</span><span class="p">.</span><span class="nx">likedBy</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">likedIndex</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L582"><a class="lnlinks" href="#L582"> 582</a></span><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L583"><a class="lnlinks" href="#L583"> 583</a></span><span class="cl">            <span class="c1">// Like: add email to likedBy
</span></span></span><span class="line"><span class="ln" id="L584"><a class="lnlinks" href="#L584"> 584</a></span><span class="cl"><span class="c1"></span>            <span class="nx">blog</span><span class="p">.</span><span class="nx">likedBy</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L585"><a class="lnlinks" href="#L585"> 585</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L586"><a class="lnlinks" href="#L586"> 586</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L587"><a class="lnlinks" href="#L587"> 587</a></span><span class="cl">        <span class="c1">// Update likes count based on likedBy array length
</span></span></span><span class="line"><span class="ln" id="L588"><a class="lnlinks" href="#L588"> 588</a></span><span class="cl"><span class="c1"></span>        <span class="nx">blog</span><span class="p">.</span><span class="nx">likes</span> <span class="o">=</span> <span class="nx">blog</span><span class="p">.</span><span class="nx">likedBy</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L589"><a class="lnlinks" href="#L589"> 589</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L590"><a class="lnlinks" href="#L590"> 590</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">blog</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L591"><a class="lnlinks" href="#L591"> 591</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L592"><a class="lnlinks" href="#L592"> 592</a></span><span class="cl">            <span class="nx">likes</span><span class="o">:</span> <span class="nx">blog</span><span class="p">.</span><span class="nx">likes</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L593"><a class="lnlinks" href="#L593"> 593</a></span><span class="cl">            <span class="nx">likedBy</span><span class="o">:</span> <span class="nx">blog</span><span class="p">.</span><span class="nx">likedBy</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L594"><a class="lnlinks" href="#L594"> 594</a></span><span class="cl">            <span class="nx">isLiked</span><span class="o">:</span> <span class="nx">likedIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="ln" id="L595"><a class="lnlinks" href="#L595"> 595</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L596"><a class="lnlinks" href="#L596"> 596</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L597"><a class="lnlinks" href="#L597"> 597</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L598"><a class="lnlinks" href="#L598"> 598</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L599"><a class="lnlinks" href="#L599"> 599</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L600"><a class="lnlinks" href="#L600"> 600</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L601"><a class="lnlinks" href="#L601"> 601</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L602"><a class="lnlinks" href="#L602"> 602</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L603"><a class="lnlinks" href="#L603"> 603</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L604"><a class="lnlinks" href="#L604"> 604</a></span><span class="cl"><span class="c1">// Delete (Soft Delete) Tech and Bio Post
</span></span></span><span class="line"><span class="ln" id="L605"><a class="lnlinks" href="#L605"> 605</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/api/tech-blog/:id&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L606"><a class="lnlinks" href="#L606"> 606</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L607"><a class="lnlinks" href="#L607"> 607</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L608"><a class="lnlinks" href="#L608"> 608</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L609"><a class="lnlinks" href="#L609"> 609</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L610"><a class="lnlinks" href="#L610"> 610</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L611"><a class="lnlinks" href="#L611"> 611</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Email is required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L612"><a class="lnlinks" href="#L612"> 612</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L613"><a class="lnlinks" href="#L613"> 613</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L614"><a class="lnlinks" href="#L614"> 614</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">blog</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">TechBlog</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L615"><a class="lnlinks" href="#L615"> 615</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">blog</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L616"><a class="lnlinks" href="#L616"> 616</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Blog post not found&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L617"><a class="lnlinks" href="#L617"> 617</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L618"><a class="lnlinks" href="#L618"> 618</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L619"><a class="lnlinks" href="#L619"> 619</a></span><span class="cl">        <span class="c1">// Check if user is the author
</span></span></span><span class="line"><span class="ln" id="L620"><a class="lnlinks" href="#L620"> 620</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">blog</span><span class="p">.</span><span class="nx">author</span><span class="p">.</span><span class="nx">email</span> <span class="o">!==</span> <span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L621"><a class="lnlinks" href="#L621"> 621</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized: Only author can delete&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L622"><a class="lnlinks" href="#L622"> 622</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L623"><a class="lnlinks" href="#L623"> 623</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L624"><a class="lnlinks" href="#L624"> 624</a></span><span class="cl">        <span class="c1">// Soft delete: set show to &#39;N&#39;
</span></span></span><span class="line"><span class="ln" id="L625"><a class="lnlinks" href="#L625"> 625</a></span><span class="cl"><span class="c1"></span>        <span class="nx">blog</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L626"><a class="lnlinks" href="#L626"> 626</a></span><span class="cl">        <span class="nx">blog</span><span class="p">.</span><span class="nx">updatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L627"><a class="lnlinks" href="#L627"> 627</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L628"><a class="lnlinks" href="#L628"> 628</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">blog</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L629"><a class="lnlinks" href="#L629"> 629</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Blog post deleted successfully&#39;</span><span class="p">,</span> <span class="nx">blog</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L630"><a class="lnlinks" href="#L630"> 630</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L631"><a class="lnlinks" href="#L631"> 631</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L632"><a class="lnlinks" href="#L632"> 632</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L633"><a class="lnlinks" href="#L633"> 633</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L634"><a class="lnlinks" href="#L634"> 634</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L635"><a class="lnlinks" href="#L635"> 635</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L636"><a class="lnlinks" href="#L636"> 636</a></span><span class="cl"><span class="c1">// --- About Page Schemas &amp; Endpoints ---
</span></span></span><span class="line"><span class="ln" id="L637"><a class="lnlinks" href="#L637"> 637</a></span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln" id="L638"><a class="lnlinks" href="#L638"> 638</a></span><span class="cl"><span class="c1">// ABOUT_ME Schema
</span></span></span><span class="line"><span class="ln" id="L639"><a class="lnlinks" href="#L639"> 639</a></span><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">aboutMeSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L640"><a class="lnlinks" href="#L640"> 640</a></span><span class="cl">    <span class="nx">introduction</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L641"><a class="lnlinks" href="#L641"> 641</a></span><span class="cl">    <span class="nx">research</span><span class="nx">_interests</span><span class="o">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L642"><a class="lnlinks" href="#L642"> 642</a></span><span class="cl">    <span class="nx">hobbies</span><span class="o">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L643"><a class="lnlinks" href="#L643"> 643</a></span><span class="cl">    <span class="nx">future</span><span class="nx">_goal</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L644"><a class="lnlinks" href="#L644"> 644</a></span><span class="cl">    <span class="nx">show</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L645"><a class="lnlinks" href="#L645"> 645</a></span><span class="cl">    <span class="nx">updated</span><span class="nx">_at</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L646"><a class="lnlinks" href="#L646"> 646</a></span><span class="cl"><span class="p">}</span><span class="p">,</span> <span class="p">{</span> <span class="nx">collection</span><span class="o">:</span> <span class="s1">&#39;ABOUT_ME&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L647"><a class="lnlinks" href="#L647"> 647</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L648"><a class="lnlinks" href="#L648"> 648</a></span><span class="cl"><span class="kr">const</span> <span class="nx">AboutMe</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;AboutMe&#39;</span><span class="p">,</span> <span class="nx">aboutMeSchema</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L649"><a class="lnlinks" href="#L649"> 649</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L650"><a class="lnlinks" href="#L650"> 650</a></span><span class="cl"><span class="c1">// ABOUT_ACADEMIC Schema
</span></span></span><span class="line"><span class="ln" id="L651"><a class="lnlinks" href="#L651"> 651</a></span><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">aboutAcademicSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L652"><a class="lnlinks" href="#L652"> 652</a></span><span class="cl">    <span class="nx">education</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L653"><a class="lnlinks" href="#L653"> 653</a></span><span class="cl">        <span class="nx">degree</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L654"><a class="lnlinks" href="#L654"> 654</a></span><span class="cl">        <span class="nx">institution</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L655"><a class="lnlinks" href="#L655"> 655</a></span><span class="cl">        <span class="nx">location</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L656"><a class="lnlinks" href="#L656"> 656</a></span><span class="cl">        <span class="nx">period</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L657"><a class="lnlinks" href="#L657"> 657</a></span><span class="cl">        <span class="nx">description</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L658"><a class="lnlinks" href="#L658"> 658</a></span><span class="cl">        <span class="nx">gpa</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L659"><a class="lnlinks" href="#L659"> 659</a></span><span class="cl">        <span class="nx">order</span><span class="o">:</span> <span class="nb">Number</span>
</span></span><span class="line"><span class="ln" id="L660"><a class="lnlinks" href="#L660"> 660</a></span><span class="cl">    <span class="p">}</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L661"><a class="lnlinks" href="#L661"> 661</a></span><span class="cl">    <span class="nx">experience</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L662"><a class="lnlinks" href="#L662"> 662</a></span><span class="cl">        <span class="nx">title</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L663"><a class="lnlinks" href="#L663"> 663</a></span><span class="cl">        <span class="nx">organization</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L664"><a class="lnlinks" href="#L664"> 664</a></span><span class="cl">        <span class="nx">location</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L665"><a class="lnlinks" href="#L665"> 665</a></span><span class="cl">        <span class="nx">period</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L666"><a class="lnlinks" href="#L666"> 666</a></span><span class="cl">        <span class="nx">description</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L667"><a class="lnlinks" href="#L667"> 667</a></span><span class="cl">        <span class="nx">responsibilities</span><span class="o">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L668"><a class="lnlinks" href="#L668"> 668</a></span><span class="cl">        <span class="nx">order</span><span class="o">:</span> <span class="nb">Number</span>
</span></span><span class="line"><span class="ln" id="L669"><a class="lnlinks" href="#L669"> 669</a></span><span class="cl">    <span class="p">}</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L670"><a class="lnlinks" href="#L670"> 670</a></span><span class="cl">    <span class="nx">publications</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L671"><a class="lnlinks" href="#L671"> 671</a></span><span class="cl">        <span class="nx">title</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L672"><a class="lnlinks" href="#L672"> 672</a></span><span class="cl">        <span class="nx">authors</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L673"><a class="lnlinks" href="#L673"> 673</a></span><span class="cl">        <span class="nx">journal</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L674"><a class="lnlinks" href="#L674"> 674</a></span><span class="cl">        <span class="nx">year</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L675"><a class="lnlinks" href="#L675"> 675</a></span><span class="cl">        <span class="nx">volume</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L676"><a class="lnlinks" href="#L676"> 676</a></span><span class="cl">        <span class="nx">pages</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L677"><a class="lnlinks" href="#L677"> 677</a></span><span class="cl">        <span class="nx">doi</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L678"><a class="lnlinks" href="#L678"> 678</a></span><span class="cl">        <span class="nx">pmid</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L679"><a class="lnlinks" href="#L679"> 679</a></span><span class="cl">        <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L680"><a class="lnlinks" href="#L680"> 680</a></span><span class="cl">        <span class="nx">order</span><span class="o">:</span> <span class="nb">Number</span>
</span></span><span class="line"><span class="ln" id="L681"><a class="lnlinks" href="#L681"> 681</a></span><span class="cl">    <span class="p">}</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L682"><a class="lnlinks" href="#L682"> 682</a></span><span class="cl">    <span class="nx">skills</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L683"><a class="lnlinks" href="#L683"> 683</a></span><span class="cl">        <span class="nx">programming</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">level</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">order</span><span class="o">:</span> <span class="nb">Number</span> <span class="p">}</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L684"><a class="lnlinks" href="#L684"> 684</a></span><span class="cl">        <span class="nx">bioinformatics</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">level</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">order</span><span class="o">:</span> <span class="nb">Number</span> <span class="p">}</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L685"><a class="lnlinks" href="#L685"> 685</a></span><span class="cl">        <span class="nx">tools</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">level</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">order</span><span class="o">:</span> <span class="nb">Number</span> <span class="p">}</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L686"><a class="lnlinks" href="#L686"> 686</a></span><span class="cl">        <span class="nx">frameworks</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">level</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">order</span><span class="o">:</span> <span class="nb">Number</span> <span class="p">}</span><span class="p">]</span>
</span></span><span class="line"><span class="ln" id="L687"><a class="lnlinks" href="#L687"> 687</a></span><span class="cl">    <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L688"><a class="lnlinks" href="#L688"> 688</a></span><span class="cl">    <span class="nx">awards</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L689"><a class="lnlinks" href="#L689"> 689</a></span><span class="cl">        <span class="nx">title</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L690"><a class="lnlinks" href="#L690"> 690</a></span><span class="cl">        <span class="nx">organization</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L691"><a class="lnlinks" href="#L691"> 691</a></span><span class="cl">        <span class="nx">year</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L692"><a class="lnlinks" href="#L692"> 692</a></span><span class="cl">        <span class="nx">description</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L693"><a class="lnlinks" href="#L693"> 693</a></span><span class="cl">        <span class="nx">order</span><span class="o">:</span> <span class="nb">Number</span>
</span></span><span class="line"><span class="ln" id="L694"><a class="lnlinks" href="#L694"> 694</a></span><span class="cl">    <span class="p">}</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L695"><a class="lnlinks" href="#L695"> 695</a></span><span class="cl">    <span class="nx">links</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L696"><a class="lnlinks" href="#L696"> 696</a></span><span class="cl">        <span class="nx">ORCiD</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L697"><a class="lnlinks" href="#L697"> 697</a></span><span class="cl">        <span class="nx">GoogleScholar</span><span class="o">:</span> <span class="nb">String</span>
</span></span><span class="line"><span class="ln" id="L698"><a class="lnlinks" href="#L698"> 698</a></span><span class="cl">    <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L699"><a class="lnlinks" href="#L699"> 699</a></span><span class="cl">    <span class="nx">show</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L700"><a class="lnlinks" href="#L700"> 700</a></span><span class="cl">    <span class="nx">updated</span><span class="nx">_at</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L701"><a class="lnlinks" href="#L701"> 701</a></span><span class="cl"><span class="p">}</span><span class="p">,</span> <span class="p">{</span> <span class="nx">collection</span><span class="o">:</span> <span class="s1">&#39;ABOUT_ACADEMIC&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L702"><a class="lnlinks" href="#L702"> 702</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L703"><a class="lnlinks" href="#L703"> 703</a></span><span class="cl"><span class="kr">const</span> <span class="nx">AboutAcademic</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;AboutAcademic&#39;</span><span class="p">,</span> <span class="nx">aboutAcademicSchema</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L704"><a class="lnlinks" href="#L704"> 704</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L705"><a class="lnlinks" href="#L705"> 705</a></span><span class="cl"><span class="c1">// Milestone Schema
</span></span></span><span class="line"><span class="ln" id="L706"><a class="lnlinks" href="#L706"> 706</a></span><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">milestoneSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L707"><a class="lnlinks" href="#L707"> 707</a></span><span class="cl">    <span class="nx">date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L708"><a class="lnlinks" href="#L708"> 708</a></span><span class="cl">    <span class="nx">title</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L709"><a class="lnlinks" href="#L709"> 709</a></span><span class="cl">    <span class="nx">description</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L710"><a class="lnlinks" href="#L710"> 710</a></span><span class="cl">    <span class="nx">createdAt</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L711"><a class="lnlinks" href="#L711"> 711</a></span><span class="cl">    <span class="nx">category</span><span class="o">:</span> <span class="nb">String</span> <span class="c1">// &#39;ME&#39; or &#39;WEB&#39;
</span></span></span><span class="line"><span class="ln" id="L712"><a class="lnlinks" href="#L712"> 712</a></span><span class="cl"><span class="c1"></span><span class="p">}</span><span class="p">,</span> <span class="p">{</span> <span class="nx">collection</span><span class="o">:</span> <span class="s1">&#39;ABOUT_MILESTONE&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L713"><a class="lnlinks" href="#L713"> 713</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L714"><a class="lnlinks" href="#L714"> 714</a></span><span class="cl"><span class="kr">const</span> <span class="nx">Milestone</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Milestone&#39;</span><span class="p">,</span> <span class="nx">milestoneSchema</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L715"><a class="lnlinks" href="#L715"> 715</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L716"><a class="lnlinks" href="#L716"> 716</a></span><span class="cl"><span class="c1">// Get Milestones
</span></span></span><span class="line"><span class="ln" id="L717"><a class="lnlinks" href="#L717"> 717</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/milestones&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L718"><a class="lnlinks" href="#L718"> 718</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L719"><a class="lnlinks" href="#L719"> 719</a></span><span class="cl">        <span class="c1">// Sort by date ascending (chronological) as per &#34;time order&#34; request for history
</span></span></span><span class="line"><span class="ln" id="L720"><a class="lnlinks" href="#L720"> 720</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">milestones</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Milestone</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="p">{</span> <span class="nx">date</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L721"><a class="lnlinks" href="#L721"> 721</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">milestones</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L722"><a class="lnlinks" href="#L722"> 722</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L723"><a class="lnlinks" href="#L723"> 723</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L724"><a class="lnlinks" href="#L724"> 724</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L725"><a class="lnlinks" href="#L725"> 725</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L726"><a class="lnlinks" href="#L726"> 726</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L727"><a class="lnlinks" href="#L727"> 727</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L728"><a class="lnlinks" href="#L728"> 728</a></span><span class="cl"><span class="c1">// Create Milestone
</span></span></span><span class="line"><span class="ln" id="L729"><a class="lnlinks" href="#L729"> 729</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/milestones&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L730"><a class="lnlinks" href="#L730"> 730</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L731"><a class="lnlinks" href="#L731"> 731</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">description</span><span class="p">,</span> <span class="nx">category</span><span class="p">,</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L732"><a class="lnlinks" href="#L732"> 732</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L733"><a class="lnlinks" href="#L733"> 733</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L734"><a class="lnlinks" href="#L734"> 734</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L735"><a class="lnlinks" href="#L735"> 735</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L736"><a class="lnlinks" href="#L736"> 736</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L737"><a class="lnlinks" href="#L737"> 737</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L738"><a class="lnlinks" href="#L738"> 738</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">newMilestone</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Milestone</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L739"><a class="lnlinks" href="#L739"> 739</a></span><span class="cl">            <span class="nx">date</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L740"><a class="lnlinks" href="#L740"> 740</a></span><span class="cl">            <span class="nx">title</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L741"><a class="lnlinks" href="#L741"> 741</a></span><span class="cl">            <span class="nx">description</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L742"><a class="lnlinks" href="#L742"> 742</a></span><span class="cl">            <span class="nx">category</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L743"><a class="lnlinks" href="#L743"> 743</a></span><span class="cl">            <span class="nx">createdAt</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="L744"><a class="lnlinks" href="#L744"> 744</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L745"><a class="lnlinks" href="#L745"> 745</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L746"><a class="lnlinks" href="#L746"> 746</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">newMilestone</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L747"><a class="lnlinks" href="#L747"> 747</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">newMilestone</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L748"><a class="lnlinks" href="#L748"> 748</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L749"><a class="lnlinks" href="#L749"> 749</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L750"><a class="lnlinks" href="#L750"> 750</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L751"><a class="lnlinks" href="#L751"> 751</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L752"><a class="lnlinks" href="#L752"> 752</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L753"><a class="lnlinks" href="#L753"> 753</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L754"><a class="lnlinks" href="#L754"> 754</a></span><span class="cl"><span class="c1">// Update Milestone
</span></span></span><span class="line"><span class="ln" id="L755"><a class="lnlinks" href="#L755"> 755</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;/api/milestones/:id&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L756"><a class="lnlinks" href="#L756"> 756</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L757"><a class="lnlinks" href="#L757"> 757</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L758"><a class="lnlinks" href="#L758"> 758</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">description</span><span class="p">,</span> <span class="nx">category</span><span class="p">,</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L759"><a class="lnlinks" href="#L759"> 759</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L760"><a class="lnlinks" href="#L760"> 760</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L761"><a class="lnlinks" href="#L761"> 761</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L762"><a class="lnlinks" href="#L762"> 762</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L763"><a class="lnlinks" href="#L763"> 763</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L764"><a class="lnlinks" href="#L764"> 764</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L765"><a class="lnlinks" href="#L765"> 765</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">milestone</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Milestone</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L766"><a class="lnlinks" href="#L766"> 766</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">milestone</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Not found&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L767"><a class="lnlinks" href="#L767"> 767</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L768"><a class="lnlinks" href="#L768"> 768</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="nx">milestone</span><span class="p">.</span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L769"><a class="lnlinks" href="#L769"> 769</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="nx">milestone</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">title</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L770"><a class="lnlinks" href="#L770"> 770</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">description</span><span class="p">)</span> <span class="nx">milestone</span><span class="p">.</span><span class="nx">description</span> <span class="o">=</span> <span class="nx">description</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L771"><a class="lnlinks" href="#L771"> 771</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">category</span><span class="p">)</span> <span class="nx">milestone</span><span class="p">.</span><span class="nx">category</span> <span class="o">=</span> <span class="nx">category</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L772"><a class="lnlinks" href="#L772"> 772</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L773"><a class="lnlinks" href="#L773"> 773</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">milestone</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L774"><a class="lnlinks" href="#L774"> 774</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">milestone</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L775"><a class="lnlinks" href="#L775"> 775</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L776"><a class="lnlinks" href="#L776"> 776</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L777"><a class="lnlinks" href="#L777"> 777</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L778"><a class="lnlinks" href="#L778"> 778</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L779"><a class="lnlinks" href="#L779"> 779</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L780"><a class="lnlinks" href="#L780"> 780</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L781"><a class="lnlinks" href="#L781"> 781</a></span><span class="cl"><span class="c1">// Delete Milestone
</span></span></span><span class="line"><span class="ln" id="L782"><a class="lnlinks" href="#L782"> 782</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/api/milestones/:id&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L783"><a class="lnlinks" href="#L783"> 783</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L784"><a class="lnlinks" href="#L784"> 784</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L785"><a class="lnlinks" href="#L785"> 785</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L786"><a class="lnlinks" href="#L786"> 786</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L787"><a class="lnlinks" href="#L787"> 787</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L788"><a class="lnlinks" href="#L788"> 788</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L789"><a class="lnlinks" href="#L789"> 789</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L790"><a class="lnlinks" href="#L790"> 790</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L791"><a class="lnlinks" href="#L791"> 791</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L792"><a class="lnlinks" href="#L792"> 792</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">Milestone</span><span class="p">.</span><span class="nx">findByIdAndDelete</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L793"><a class="lnlinks" href="#L793"> 793</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Deleted successfully&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L794"><a class="lnlinks" href="#L794"> 794</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L795"><a class="lnlinks" href="#L795"> 795</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L796"><a class="lnlinks" href="#L796"> 796</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L797"><a class="lnlinks" href="#L797"> 797</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L798"><a class="lnlinks" href="#L798"> 798</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L799"><a class="lnlinks" href="#L799"> 799</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L800"><a class="lnlinks" href="#L800"> 800</a></span><span class="cl"><span class="c1">// --- ABOUT_ME Endpoints ---
</span></span></span><span class="line"><span class="ln" id="L801"><a class="lnlinks" href="#L801"> 801</a></span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln" id="L802"><a class="lnlinks" href="#L802"> 802</a></span><span class="cl"><span class="c1">// Get About Me
</span></span></span><span class="line"><span class="ln" id="L803"><a class="lnlinks" href="#L803"> 803</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/about-me&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L804"><a class="lnlinks" href="#L804"> 804</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L805"><a class="lnlinks" href="#L805"> 805</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">aboutMe</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">AboutMe</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span> <span class="nx">show</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L806"><a class="lnlinks" href="#L806"> 806</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">aboutMe</span> <span class="o">||</span> <span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L807"><a class="lnlinks" href="#L807"> 807</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L808"><a class="lnlinks" href="#L808"> 808</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L809"><a class="lnlinks" href="#L809"> 809</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L810"><a class="lnlinks" href="#L810"> 810</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L811"><a class="lnlinks" href="#L811"> 811</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L812"><a class="lnlinks" href="#L812"> 812</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L813"><a class="lnlinks" href="#L813"> 813</a></span><span class="cl"><span class="c1">// Create About Me
</span></span></span><span class="line"><span class="ln" id="L814"><a class="lnlinks" href="#L814"> 814</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/about-me&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L815"><a class="lnlinks" href="#L815"> 815</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L816"><a class="lnlinks" href="#L816"> 816</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">introduction</span><span class="p">,</span> <span class="nx">research</span><span class="nx">_interests</span><span class="p">,</span> <span class="nx">hobbies</span><span class="p">,</span> <span class="nx">future</span><span class="nx">_goal</span><span class="p">,</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L817"><a class="lnlinks" href="#L817"> 817</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L818"><a class="lnlinks" href="#L818"> 818</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L819"><a class="lnlinks" href="#L819"> 819</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L820"><a class="lnlinks" href="#L820"> 820</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L821"><a class="lnlinks" href="#L821"> 821</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L822"><a class="lnlinks" href="#L822"> 822</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L823"><a class="lnlinks" href="#L823"> 823</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">newAboutMe</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AboutMe</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L824"><a class="lnlinks" href="#L824"> 824</a></span><span class="cl">            <span class="nx">introduction</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L825"><a class="lnlinks" href="#L825"> 825</a></span><span class="cl">            <span class="nx">research</span><span class="nx">_interests</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L826"><a class="lnlinks" href="#L826"> 826</a></span><span class="cl">            <span class="nx">hobbies</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L827"><a class="lnlinks" href="#L827"> 827</a></span><span class="cl">            <span class="nx">future</span><span class="nx">_goal</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L828"><a class="lnlinks" href="#L828"> 828</a></span><span class="cl">            <span class="nx">show</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L829"><a class="lnlinks" href="#L829"> 829</a></span><span class="cl">            <span class="nx">updated</span><span class="nx">_at</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="L830"><a class="lnlinks" href="#L830"> 830</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L831"><a class="lnlinks" href="#L831"> 831</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L832"><a class="lnlinks" href="#L832"> 832</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">newAboutMe</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L833"><a class="lnlinks" href="#L833"> 833</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">newAboutMe</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L834"><a class="lnlinks" href="#L834"> 834</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L835"><a class="lnlinks" href="#L835"> 835</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L836"><a class="lnlinks" href="#L836"> 836</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L837"><a class="lnlinks" href="#L837"> 837</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L838"><a class="lnlinks" href="#L838"> 838</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L839"><a class="lnlinks" href="#L839"> 839</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L840"><a class="lnlinks" href="#L840"> 840</a></span><span class="cl"><span class="c1">// Update About Me
</span></span></span><span class="line"><span class="ln" id="L841"><a class="lnlinks" href="#L841"> 841</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;/api/about-me/:id&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L842"><a class="lnlinks" href="#L842"> 842</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L843"><a class="lnlinks" href="#L843"> 843</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L844"><a class="lnlinks" href="#L844"> 844</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">introduction</span><span class="p">,</span> <span class="nx">research</span><span class="nx">_interests</span><span class="p">,</span> <span class="nx">hobbies</span><span class="p">,</span> <span class="nx">future</span><span class="nx">_goal</span><span class="p">,</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L845"><a class="lnlinks" href="#L845"> 845</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L846"><a class="lnlinks" href="#L846"> 846</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L847"><a class="lnlinks" href="#L847"> 847</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L848"><a class="lnlinks" href="#L848"> 848</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L849"><a class="lnlinks" href="#L849"> 849</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L850"><a class="lnlinks" href="#L850"> 850</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L851"><a class="lnlinks" href="#L851"> 851</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">aboutMe</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">AboutMe</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L852"><a class="lnlinks" href="#L852"> 852</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">aboutMe</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Not found&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L853"><a class="lnlinks" href="#L853"> 853</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L854"><a class="lnlinks" href="#L854"> 854</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">introduction</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">aboutMe</span><span class="p">.</span><span class="nx">introduction</span> <span class="o">=</span> <span class="nx">introduction</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L855"><a class="lnlinks" href="#L855"> 855</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">research</span><span class="nx">_interests</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">aboutMe</span><span class="p">.</span><span class="nx">research</span><span class="nx">_interests</span> <span class="o">=</span> <span class="nx">research</span><span class="nx">_interests</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L856"><a class="lnlinks" href="#L856"> 856</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">hobbies</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">aboutMe</span><span class="p">.</span><span class="nx">hobbies</span> <span class="o">=</span> <span class="nx">hobbies</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L857"><a class="lnlinks" href="#L857"> 857</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">future</span><span class="nx">_goal</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">aboutMe</span><span class="p">.</span><span class="nx">future</span><span class="nx">_goal</span> <span class="o">=</span> <span class="nx">future</span><span class="nx">_goal</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L858"><a class="lnlinks" href="#L858"> 858</a></span><span class="cl">        <span class="nx">aboutMe</span><span class="p">.</span><span class="nx">updated</span><span class="nx">_at</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L859"><a class="lnlinks" href="#L859"> 859</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L860"><a class="lnlinks" href="#L860"> 860</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">aboutMe</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L861"><a class="lnlinks" href="#L861"> 861</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">aboutMe</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L862"><a class="lnlinks" href="#L862"> 862</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L863"><a class="lnlinks" href="#L863"> 863</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L864"><a class="lnlinks" href="#L864"> 864</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L865"><a class="lnlinks" href="#L865"> 865</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L866"><a class="lnlinks" href="#L866"> 866</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L867"><a class="lnlinks" href="#L867"> 867</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L868"><a class="lnlinks" href="#L868"> 868</a></span><span class="cl"><span class="c1">// --- ABOUT_ACADEMIC Endpoints ---
</span></span></span><span class="line"><span class="ln" id="L869"><a class="lnlinks" href="#L869"> 869</a></span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln" id="L870"><a class="lnlinks" href="#L870"> 870</a></span><span class="cl"><span class="c1">// Get About Academic
</span></span></span><span class="line"><span class="ln" id="L871"><a class="lnlinks" href="#L871"> 871</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/about-academic&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L872"><a class="lnlinks" href="#L872"> 872</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L873"><a class="lnlinks" href="#L873"> 873</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">aboutAcademic</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">AboutAcademic</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span> <span class="nx">show</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L874"><a class="lnlinks" href="#L874"> 874</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">aboutAcademic</span> <span class="o">||</span> <span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L875"><a class="lnlinks" href="#L875"> 875</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L876"><a class="lnlinks" href="#L876"> 876</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L877"><a class="lnlinks" href="#L877"> 877</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L878"><a class="lnlinks" href="#L878"> 878</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L879"><a class="lnlinks" href="#L879"> 879</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L880"><a class="lnlinks" href="#L880"> 880</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L881"><a class="lnlinks" href="#L881"> 881</a></span><span class="cl"><span class="c1">// Create About Academic
</span></span></span><span class="line"><span class="ln" id="L882"><a class="lnlinks" href="#L882"> 882</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/about-academic&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L883"><a class="lnlinks" href="#L883"> 883</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L884"><a class="lnlinks" href="#L884"> 884</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">education</span><span class="p">,</span> <span class="nx">experience</span><span class="p">,</span> <span class="nx">publications</span><span class="p">,</span> <span class="nx">skills</span><span class="p">,</span> <span class="nx">awards</span><span class="p">,</span> <span class="nx">links</span><span class="p">,</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L885"><a class="lnlinks" href="#L885"> 885</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L886"><a class="lnlinks" href="#L886"> 886</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L887"><a class="lnlinks" href="#L887"> 887</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L888"><a class="lnlinks" href="#L888"> 888</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L889"><a class="lnlinks" href="#L889"> 889</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L890"><a class="lnlinks" href="#L890"> 890</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L891"><a class="lnlinks" href="#L891"> 891</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">newAboutAcademic</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AboutAcademic</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L892"><a class="lnlinks" href="#L892"> 892</a></span><span class="cl">            <span class="nx">education</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L893"><a class="lnlinks" href="#L893"> 893</a></span><span class="cl">            <span class="nx">experience</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L894"><a class="lnlinks" href="#L894"> 894</a></span><span class="cl">            <span class="nx">publications</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L895"><a class="lnlinks" href="#L895"> 895</a></span><span class="cl">            <span class="nx">skills</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L896"><a class="lnlinks" href="#L896"> 896</a></span><span class="cl">            <span class="nx">awards</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L897"><a class="lnlinks" href="#L897"> 897</a></span><span class="cl">            <span class="nx">links</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L898"><a class="lnlinks" href="#L898"> 898</a></span><span class="cl">            <span class="nx">show</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L899"><a class="lnlinks" href="#L899"> 899</a></span><span class="cl">            <span class="nx">updated</span><span class="nx">_at</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="L900"><a class="lnlinks" href="#L900"> 900</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L901"><a class="lnlinks" href="#L901"> 901</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L902"><a class="lnlinks" href="#L902"> 902</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">newAboutAcademic</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L903"><a class="lnlinks" href="#L903"> 903</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">newAboutAcademic</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L904"><a class="lnlinks" href="#L904"> 904</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L905"><a class="lnlinks" href="#L905"> 905</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L906"><a class="lnlinks" href="#L906"> 906</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L907"><a class="lnlinks" href="#L907"> 907</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L908"><a class="lnlinks" href="#L908"> 908</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L909"><a class="lnlinks" href="#L909"> 909</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L910"><a class="lnlinks" href="#L910"> 910</a></span><span class="cl"><span class="c1">// Update About Academic
</span></span></span><span class="line"><span class="ln" id="L911"><a class="lnlinks" href="#L911"> 911</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;/api/about-academic/:id&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L912"><a class="lnlinks" href="#L912"> 912</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L913"><a class="lnlinks" href="#L913"> 913</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L914"><a class="lnlinks" href="#L914"> 914</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">education</span><span class="p">,</span> <span class="nx">experience</span><span class="p">,</span> <span class="nx">publications</span><span class="p">,</span> <span class="nx">skills</span><span class="p">,</span> <span class="nx">awards</span><span class="p">,</span> <span class="nx">links</span><span class="p">,</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L915"><a class="lnlinks" href="#L915"> 915</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L916"><a class="lnlinks" href="#L916"> 916</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L917"><a class="lnlinks" href="#L917"> 917</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L918"><a class="lnlinks" href="#L918"> 918</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L919"><a class="lnlinks" href="#L919"> 919</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L920"><a class="lnlinks" href="#L920"> 920</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L921"><a class="lnlinks" href="#L921"> 921</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">aboutAcademic</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">AboutAcademic</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L922"><a class="lnlinks" href="#L922"> 922</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">aboutAcademic</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Not found&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L923"><a class="lnlinks" href="#L923"> 923</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L924"><a class="lnlinks" href="#L924"> 924</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">education</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">aboutAcademic</span><span class="p">.</span><span class="nx">education</span> <span class="o">=</span> <span class="nx">education</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L925"><a class="lnlinks" href="#L925"> 925</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">experience</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">aboutAcademic</span><span class="p">.</span><span class="nx">experience</span> <span class="o">=</span> <span class="nx">experience</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L926"><a class="lnlinks" href="#L926"> 926</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">publications</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">aboutAcademic</span><span class="p">.</span><span class="nx">publications</span> <span class="o">=</span> <span class="nx">publications</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L927"><a class="lnlinks" href="#L927"> 927</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">skills</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">aboutAcademic</span><span class="p">.</span><span class="nx">skills</span> <span class="o">=</span> <span class="nx">skills</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L928"><a class="lnlinks" href="#L928"> 928</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">awards</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">aboutAcademic</span><span class="p">.</span><span class="nx">awards</span> <span class="o">=</span> <span class="nx">awards</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L929"><a class="lnlinks" href="#L929"> 929</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L930"><a class="lnlinks" href="#L930"> 930</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">links</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L931"><a class="lnlinks" href="#L931"> 931</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Updating links:&#39;</span><span class="p">,</span> <span class="nx">links</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L932"><a class="lnlinks" href="#L932"> 932</a></span><span class="cl">            <span class="nx">aboutAcademic</span><span class="p">.</span><span class="nx">links</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L933"><a class="lnlinks" href="#L933"> 933</a></span><span class="cl">                <span class="nx">ORCiD</span><span class="o">:</span> <span class="nx">links</span><span class="p">.</span><span class="nx">ORCiD</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L934"><a class="lnlinks" href="#L934"> 934</a></span><span class="cl">                <span class="nx">GoogleScholar</span><span class="o">:</span> <span class="nx">links</span><span class="p">.</span><span class="nx">GoogleScholar</span>
</span></span><span class="line"><span class="ln" id="L935"><a class="lnlinks" href="#L935"> 935</a></span><span class="cl">            <span class="p">}</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L936"><a class="lnlinks" href="#L936"> 936</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L937"><a class="lnlinks" href="#L937"> 937</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L938"><a class="lnlinks" href="#L938"> 938</a></span><span class="cl">        <span class="nx">aboutAcademic</span><span class="p">.</span><span class="nx">updated</span><span class="nx">_at</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L939"><a class="lnlinks" href="#L939"> 939</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L940"><a class="lnlinks" href="#L940"> 940</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">aboutAcademic</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L941"><a class="lnlinks" href="#L941"> 941</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AboutAcademic updated successfully&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L942"><a class="lnlinks" href="#L942"> 942</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">aboutAcademic</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L943"><a class="lnlinks" href="#L943"> 943</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L944"><a class="lnlinks" href="#L944"> 944</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L945"><a class="lnlinks" href="#L945"> 945</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L946"><a class="lnlinks" href="#L946"> 946</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L947"><a class="lnlinks" href="#L947"> 947</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L948"><a class="lnlinks" href="#L948"> 948</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L949"><a class="lnlinks" href="#L949"> 949</a></span><span class="cl"><span class="kr">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L950"><a class="lnlinks" href="#L950"> 950</a></span><span class="cl"><span class="kr">const</span> <span class="nx">io</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L951"><a class="lnlinks" href="#L951"> 951</a></span><span class="cl">    <span class="nx">cors</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L952"><a class="lnlinks" href="#L952"> 952</a></span><span class="cl">        <span class="nx">origin</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln" id="L953"><a class="lnlinks" href="#L953"> 953</a></span><span class="cl">            <span class="s2">&#34;http://localhost:5173&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L954"><a class="lnlinks" href="#L954"> 954</a></span><span class="cl">            <span class="s2">&#34;http://localhost:3000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L955"><a class="lnlinks" href="#L955"> 955</a></span><span class="cl">            <span class="s2">&#34;https://www.distilledchild.space&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L956"><a class="lnlinks" href="#L956"> 956</a></span><span class="cl">            <span class="s2">&#34;https://distilledchild.space&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L957"><a class="lnlinks" href="#L957"> 957</a></span><span class="cl">            <span class="s2">&#34;https://personal-web-2025-mauve.vercel.app&#34;</span>
</span></span><span class="line"><span class="ln" id="L958"><a class="lnlinks" href="#L958"> 958</a></span><span class="cl">        <span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L959"><a class="lnlinks" href="#L959"> 959</a></span><span class="cl">        <span class="nx">methods</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;GET&#34;</span><span class="p">,</span> <span class="s2">&#34;POST&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln" id="L960"><a class="lnlinks" href="#L960"> 960</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L961"><a class="lnlinks" href="#L961"> 961</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L962"><a class="lnlinks" href="#L962"> 962</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L963"><a class="lnlinks" href="#L963"> 963</a></span><span class="cl"><span class="c1">// State
</span></span></span><span class="line"><span class="ln" id="L964"><a class="lnlinks" href="#L964"> 964</a></span><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">waitingQueue</span> <span class="o">=</span> <span class="p">[</span><span class="p">]</span><span class="p">;</span> <span class="c1">// Array of { socketId: string, userInfo: { email?: string, name?: string, avatar?: string } }
</span></span></span><span class="line"><span class="ln" id="L965"><a class="lnlinks" href="#L965"> 965</a></span><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">activeChat</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// { visitorId: string, ownerId: string, userInfo: object } | null
</span></span></span><span class="line"><span class="ln" id="L966"><a class="lnlinks" href="#L966"> 966</a></span><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">ownerSocketId</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L967"><a class="lnlinks" href="#L967"> 967</a></span><span class="cl"><span class="kd">let</span> <span class="nx">allChats</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">(</span><span class="p">)</span><span class="p">;</span> <span class="c1">// socketId -&gt; { messages: [], userInfo: {}, sessionId: string }
</span></span></span><span class="line"><span class="ln" id="L968"><a class="lnlinks" href="#L968"> 968</a></span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln" id="L969"><a class="lnlinks" href="#L969"> 969</a></span><span class="cl"><span class="c1">// Helper: Generate readable name from session ID
</span></span></span><span class="line"><span class="ln" id="L970"><a class="lnlinks" href="#L970"> 970</a></span><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">generateNickname</span><span class="p">(</span><span class="nx">sessionId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L971"><a class="lnlinks" href="#L971"> 971</a></span><span class="cl">    <span class="c1">// Extract numbers from session ID (e.g., &#34;1764277055030-abc123&#34; -&gt; &#34;1764277055030&#34;)
</span></span></span><span class="line"><span class="ln" id="L972"><a class="lnlinks" href="#L972"> 972</a></span><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">numbers</span> <span class="o">=</span> <span class="nx">sessionId</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L973"><a class="lnlinks" href="#L973"> 973</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L974"><a class="lnlinks" href="#L974"> 974</a></span><span class="cl">    <span class="c1">// Mapping: 0-9 to letters
</span></span></span><span class="line"><span class="ln" id="L975"><a class="lnlinks" href="#L975"> 975</a></span><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L976"><a class="lnlinks" href="#L976"> 976</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L977"><a class="lnlinks" href="#L977"> 977</a></span><span class="cl">    <span class="kd">let</span> <span class="nx">nickname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L978"><a class="lnlinks" href="#L978"> 978</a></span><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="kr">char</span> <span class="k">of</span> <span class="nx">numbers</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L979"><a class="lnlinks" href="#L979"> 979</a></span><span class="cl">        <span class="nx">nickname</span> <span class="o">+=</span> <span class="nx">map</span><span class="p">[</span><span class="nb">parseInt</span><span class="p">(</span><span class="kr">char</span><span class="p">)</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L980"><a class="lnlinks" href="#L980"> 980</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L981"><a class="lnlinks" href="#L981"> 981</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L982"><a class="lnlinks" href="#L982"> 982</a></span><span class="cl">    <span class="k">return</span> <span class="nx">nickname</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L983"><a class="lnlinks" href="#L983"> 983</a></span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L984"><a class="lnlinks" href="#L984"> 984</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L985"><a class="lnlinks" href="#L985"> 985</a></span><span class="cl"><span class="c1">// Helper: Save chat to file
</span></span></span><span class="line"><span class="ln" id="L986"><a class="lnlinks" href="#L986"> 986</a></span><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">saveChatToFile</span><span class="p">(</span><span class="nx">socketId</span><span class="p">,</span> <span class="nx">chatData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L987"><a class="lnlinks" href="#L987"> 987</a></span><span class="cl">    <span class="kr">const</span> <span class="nx">logsDir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">_</span><span class="nx">_dirname</span><span class="p">,</span> <span class="s1">&#39;chat_logs&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L988"><a class="lnlinks" href="#L988"> 988</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L989"><a class="lnlinks" href="#L989"> 989</a></span><span class="cl">    <span class="c1">// Create directory if it doesn&#39;t exist
</span></span></span><span class="line"><span class="ln" id="L990"><a class="lnlinks" href="#L990"> 990</a></span><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">logsDir</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L991"><a class="lnlinks" href="#L991"> 991</a></span><span class="cl">        <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdirSync</span><span class="p">(</span><span class="nx">logsDir</span><span class="p">,</span> <span class="p">{</span> <span class="nx">recursive</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L992"><a class="lnlinks" href="#L992"> 992</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L993"><a class="lnlinks" href="#L993"> 993</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L994"><a class="lnlinks" href="#L994"> 994</a></span><span class="cl">    <span class="kr">const</span> <span class="nx">userInfo</span> <span class="o">=</span> <span class="nx">chatData</span><span class="p">.</span><span class="nx">userInfo</span> <span class="o">||</span> <span class="p">{</span><span class="p">}</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L995"><a class="lnlinks" href="#L995"> 995</a></span><span class="cl">    <span class="kr">const</span> <span class="nx">messages</span> <span class="o">=</span> <span class="nx">chatData</span><span class="p">.</span><span class="nx">messages</span> <span class="o">||</span> <span class="p">[</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L996"><a class="lnlinks" href="#L996"> 996</a></span><span class="cl">    <span class="kr">const</span> <span class="nx">sessionId</span> <span class="o">=</span> <span class="nx">chatData</span><span class="p">.</span><span class="nx">sessionId</span> <span class="o">||</span> <span class="nx">socketId</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L997"><a class="lnlinks" href="#L997"> 997</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L998"><a class="lnlinks" href="#L998"> 998</a></span><span class="cl">    <span class="c1">// Generate identifier (email or nickname from session ID)
</span></span></span><span class="line"><span class="ln" id="L999"><a class="lnlinks" href="#L999"> 999</a></span><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">identifier</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1000"><a class="lnlinks" href="#L1000">1000</a></span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">userInfo</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1001"><a class="lnlinks" href="#L1001">1001</a></span><span class="cl">        <span class="nx">identifier</span> <span class="o">=</span> <span class="nx">userInfo</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">;</span> <span class="c1">// e.g., &#34;distilledchild&#34;
</span></span></span><span class="line"><span class="ln" id="L1002"><a class="lnlinks" href="#L1002">1002</a></span><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1003"><a class="lnlinks" href="#L1003">1003</a></span><span class="cl">        <span class="nx">identifier</span> <span class="o">=</span> <span class="nx">generateNickname</span><span class="p">(</span><span class="nx">sessionId</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1004"><a class="lnlinks" href="#L1004">1004</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1005"><a class="lnlinks" href="#L1005">1005</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1006"><a class="lnlinks" href="#L1006">1006</a></span><span class="cl">    <span class="c1">// Get current date in MM_DD format
</span></span></span><span class="line"><span class="ln" id="L1007"><a class="lnlinks" href="#L1007">1007</a></span><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1008"><a class="lnlinks" href="#L1008">1008</a></span><span class="cl">    <span class="kr">const</span> <span class="nx">month</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">now</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">(</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="p">.</span><span class="nx">padStart</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1009"><a class="lnlinks" href="#L1009">1009</a></span><span class="cl">    <span class="kr">const</span> <span class="nx">day</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">now</span><span class="p">.</span><span class="nx">getDate</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="nx">padStart</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1010"><a class="lnlinks" href="#L1010">1010</a></span><span class="cl">    <span class="kr">const</span> <span class="nx">datePrefix</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">month</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nx">day</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1011"><a class="lnlinks" href="#L1011">1011</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1012"><a class="lnlinks" href="#L1012">1012</a></span><span class="cl">    <span class="c1">// Base filename
</span></span></span><span class="line"><span class="ln" id="L1013"><a class="lnlinks" href="#L1013">1013</a></span><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">baseFilename</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">datePrefix</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nx">identifier</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1014"><a class="lnlinks" href="#L1014">1014</a></span><span class="cl">    <span class="kd">let</span> <span class="nx">filename</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">baseFilename</span><span class="si">}</span><span class="sb">.txt</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1015"><a class="lnlinks" href="#L1015">1015</a></span><span class="cl">    <span class="kd">let</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">logsDir</span><span class="p">,</span> <span class="nx">filename</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1016"><a class="lnlinks" href="#L1016">1016</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1017"><a class="lnlinks" href="#L1017">1017</a></span><span class="cl">    <span class="c1">// Check if file exists and find the right sequence number
</span></span></span><span class="line"><span class="ln" id="L1018"><a class="lnlinks" href="#L1018">1018</a></span><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">sequenceNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1019"><a class="lnlinks" href="#L1019">1019</a></span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1020"><a class="lnlinks" href="#L1020">1020</a></span><span class="cl">        <span class="c1">// Read existing file to check if it&#39;s from today
</span></span></span><span class="line"><span class="ln" id="L1021"><a class="lnlinks" href="#L1021">1021</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">existingContent</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1022"><a class="lnlinks" href="#L1022">1022</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">firstLine</span> <span class="o">=</span> <span class="nx">existingContent</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1023"><a class="lnlinks" href="#L1023">1023</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1024"><a class="lnlinks" href="#L1024">1024</a></span><span class="cl">        <span class="c1">// Check if last message is from today
</span></span></span><span class="line"><span class="ln" id="L1025"><a class="lnlinks" href="#L1025">1025</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">today</span> <span class="o">=</span> <span class="nx">now</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1026"><a class="lnlinks" href="#L1026">1026</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">firstLine</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">today</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1027"><a class="lnlinks" href="#L1027">1027</a></span><span class="cl">            <span class="c1">// Same day - append to existing file
</span></span></span><span class="line"><span class="ln" id="L1028"><a class="lnlinks" href="#L1028">1028</a></span><span class="cl"><span class="c1"></span>            <span class="c1">// Do nothing, will append below
</span></span></span><span class="line"><span class="ln" id="L1029"><a class="lnlinks" href="#L1029">1029</a></span><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1030"><a class="lnlinks" href="#L1030">1030</a></span><span class="cl">            <span class="c1">// Different day - need to find sequence number
</span></span></span><span class="line"><span class="ln" id="L1031"><a class="lnlinks" href="#L1031">1031</a></span><span class="cl"><span class="c1"></span>            <span class="k">while</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1032"><a class="lnlinks" href="#L1032">1032</a></span><span class="cl">                <span class="nx">filename</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">baseFilename</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nx">sequenceNumber</span><span class="si">}</span><span class="sb">.txt</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1033"><a class="lnlinks" href="#L1033">1033</a></span><span class="cl">                <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">logsDir</span><span class="p">,</span> <span class="nx">filename</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1034"><a class="lnlinks" href="#L1034">1034</a></span><span class="cl">                <span class="nx">sequenceNumber</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1035"><a class="lnlinks" href="#L1035">1035</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1036"><a class="lnlinks" href="#L1036">1036</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1037"><a class="lnlinks" href="#L1037">1037</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1038"><a class="lnlinks" href="#L1038">1038</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1039"><a class="lnlinks" href="#L1039">1039</a></span><span class="cl">    <span class="c1">// Format messages
</span></span></span><span class="line"><span class="ln" id="L1040"><a class="lnlinks" href="#L1040">1040</a></span><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1041"><a class="lnlinks" href="#L1041">1041</a></span><span class="cl">    <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="sb">`</span><span class="sb">\n</span><span class="sb">=== Chat Session: </span><span class="si">${</span><span class="nx">timestamp</span><span class="si">}</span><span class="sb"> ===</span><span class="sb">\n</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1042"><a class="lnlinks" href="#L1042">1042</a></span><span class="cl">    <span class="nx">content</span> <span class="o">+=</span> <span class="sb">`</span><span class="sb">User: </span><span class="si">${</span><span class="nx">userInfo</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="nx">identifier</span><span class="si">}</span><span class="sb">\n</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1043"><a class="lnlinks" href="#L1043">1043</a></span><span class="cl">    <span class="nx">content</span> <span class="o">+=</span> <span class="sb">`</span><span class="sb">Session ID: </span><span class="si">${</span><span class="nx">sessionId</span><span class="si">}</span><span class="sb">\n</span><span class="sb">\n</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1044"><a class="lnlinks" href="#L1044">1044</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1045"><a class="lnlinks" href="#L1045">1045</a></span><span class="cl">    <span class="nx">messages</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">msg</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1046"><a class="lnlinks" href="#L1046">1046</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">speaker</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">===</span> <span class="s1">&#39;owner&#39;</span> <span class="o">?</span> <span class="s1">&#39;Distilled Child&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="nx">userInfo</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="nx">identifier</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1047"><a class="lnlinks" href="#L1047">1047</a></span><span class="cl">        <span class="nx">content</span> <span class="o">+=</span> <span class="sb">`</span><span class="sb">[</span><span class="si">${</span><span class="nx">speaker</span><span class="si">}</span><span class="sb">]: </span><span class="si">${</span><span class="nx">msg</span><span class="p">.</span><span class="nx">text</span><span class="si">}</span><span class="sb">\n</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1048"><a class="lnlinks" href="#L1048">1048</a></span><span class="cl">    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1049"><a class="lnlinks" href="#L1049">1049</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1050"><a class="lnlinks" href="#L1050">1050</a></span><span class="cl">    <span class="nx">content</span> <span class="o">+=</span> <span class="sb">`</span><span class="sb">\n</span><span class="sb">=== End of Session ===</span><span class="sb">\n</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1051"><a class="lnlinks" href="#L1051">1051</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1052"><a class="lnlinks" href="#L1052">1052</a></span><span class="cl">    <span class="c1">// Append to file
</span></span></span><span class="line"><span class="ln" id="L1053"><a class="lnlinks" href="#L1053">1053</a></span><span class="cl"><span class="c1"></span>    <span class="nx">fs</span><span class="p">.</span><span class="nx">appendFileSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1054"><a class="lnlinks" href="#L1054">1054</a></span><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Chat saved to: </span><span class="si">${</span><span class="nx">filename</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1055"><a class="lnlinks" href="#L1055">1055</a></span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1056"><a class="lnlinks" href="#L1056">1056</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1057"><a class="lnlinks" href="#L1057">1057</a></span><span class="cl"><span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1058"><a class="lnlinks" href="#L1058">1058</a></span><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;User connected:&#39;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1059"><a class="lnlinks" href="#L1059">1059</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1060"><a class="lnlinks" href="#L1060">1060</a></span><span class="cl">    <span class="c1">// 1. Register Owner
</span></span></span><span class="line"><span class="ln" id="L1061"><a class="lnlinks" href="#L1061">1061</a></span><span class="cl"><span class="c1"></span>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;register_owner&#39;</span><span class="p">,</span> <span class="p">(</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1062"><a class="lnlinks" href="#L1062">1062</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Owner registered:&#39;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1063"><a class="lnlinks" href="#L1063">1063</a></span><span class="cl">        <span class="nx">ownerSocketId</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1064"><a class="lnlinks" href="#L1064">1064</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1065"><a class="lnlinks" href="#L1065">1065</a></span><span class="cl">        <span class="c1">// Send current queue and all waiting users to owner
</span></span></span><span class="line"><span class="ln" id="L1066"><a class="lnlinks" href="#L1066">1066</a></span><span class="cl"><span class="c1"></span>        <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_update&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1067"><a class="lnlinks" href="#L1067">1067</a></span><span class="cl">            <span class="nx">count</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1068"><a class="lnlinks" href="#L1068">1068</a></span><span class="cl">            <span class="nx">queue</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1069"><a class="lnlinks" href="#L1069">1069</a></span><span class="cl">            <span class="nx">active</span><span class="o">:</span> <span class="nx">activeChat</span> <span class="o">?</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1070"><a class="lnlinks" href="#L1070">1070</a></span><span class="cl">                <span class="nx">socketId</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1071"><a class="lnlinks" href="#L1071">1071</a></span><span class="cl">                <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">userInfo</span>
</span></span><span class="line"><span class="ln" id="L1072"><a class="lnlinks" href="#L1072">1072</a></span><span class="cl">            <span class="p">}</span> <span class="o">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="ln" id="L1073"><a class="lnlinks" href="#L1073">1073</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1074"><a class="lnlinks" href="#L1074">1074</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1075"><a class="lnlinks" href="#L1075">1075</a></span><span class="cl">        <span class="c1">// If there&#39;s no active chat but people are waiting, start next chat automatically
</span></span></span><span class="line"><span class="ln" id="L1076"><a class="lnlinks" href="#L1076">1076</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">activeChat</span> <span class="o">&amp;&amp;</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1077"><a class="lnlinks" href="#L1077">1077</a></span><span class="cl">            <span class="nx">startNextChat</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1078"><a class="lnlinks" href="#L1078">1078</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1079"><a class="lnlinks" href="#L1079">1079</a></span><span class="cl">    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1080"><a class="lnlinks" href="#L1080">1080</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1081"><a class="lnlinks" href="#L1081">1081</a></span><span class="cl">    <span class="c1">// 2. Visitor Joins Queue
</span></span></span><span class="line"><span class="ln" id="L1082"><a class="lnlinks" href="#L1082">1082</a></span><span class="cl"><span class="c1"></span>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;join_queue&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1083"><a class="lnlinks" href="#L1083">1083</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">ownerSocketId</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// Owner doesn&#39;t join queue
</span></span></span><span class="line"><span class="ln" id="L1084"><a class="lnlinks" href="#L1084">1084</a></span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln" id="L1085"><a class="lnlinks" href="#L1085">1085</a></span><span class="cl">        <span class="c1">// data: { userInfo: { email?, name?, avatar? } }
</span></span></span><span class="line"><span class="ln" id="L1086"><a class="lnlinks" href="#L1086">1086</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">userInfo</span> <span class="o">=</span> <span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">userInfo</span> <span class="o">||</span> <span class="p">{</span><span class="p">}</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1087"><a class="lnlinks" href="#L1087">1087</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1088"><a class="lnlinks" href="#L1088">1088</a></span><span class="cl">        <span class="c1">// Check if owner is online
</span></span></span><span class="line"><span class="ln" id="L1089"><a class="lnlinks" href="#L1089">1089</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ownerSocketId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1090"><a class="lnlinks" href="#L1090">1090</a></span><span class="cl">            <span class="c1">// Owner is offline - notify visitor
</span></span></span><span class="line"><span class="ln" id="L1091"><a class="lnlinks" href="#L1091">1091</a></span><span class="cl"><span class="c1"></span>            <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;owner_offline&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1092"><a class="lnlinks" href="#L1092">1092</a></span><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1093"><a class="lnlinks" href="#L1093">1093</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1094"><a class="lnlinks" href="#L1094">1094</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1095"><a class="lnlinks" href="#L1095">1095</a></span><span class="cl">        <span class="c1">// Check if already in queue or active
</span></span></span><span class="line"><span class="ln" id="L1096"><a class="lnlinks" href="#L1096">1096</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">q</span> <span class="p">=&gt;</span> <span class="nx">q</span><span class="p">.</span><span class="nx">socketId</span> <span class="o">===</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1097"><a class="lnlinks" href="#L1097">1097</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">activeChat</span> <span class="o">&amp;&amp;</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span> <span class="o">===</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1098"><a class="lnlinks" href="#L1098">1098</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1099"><a class="lnlinks" href="#L1099">1099</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Visitor joined queue:&#39;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">userInfo</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1100"><a class="lnlinks" href="#L1100">1100</a></span><span class="cl">        <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="p">{</span> <span class="nx">socketId</span><span class="o">:</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">userInfo</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1101"><a class="lnlinks" href="#L1101">1101</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1102"><a class="lnlinks" href="#L1102">1102</a></span><span class="cl">        <span class="c1">// Generate or retrieve session ID for this socket
</span></span></span><span class="line"><span class="ln" id="L1103"><a class="lnlinks" href="#L1103">1103</a></span><span class="cl"><span class="c1"></span>        <span class="kd">let</span> <span class="nx">sessionId</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">sessionId</span> <span class="o">||</span> <span class="sb">`</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(</span><span class="p">)</span><span class="si">}</span><span class="sb">-</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1104"><a class="lnlinks" href="#L1104">1104</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1105"><a class="lnlinks" href="#L1105">1105</a></span><span class="cl">        <span class="c1">// Initialize chat history with session ID
</span></span></span><span class="line"><span class="ln" id="L1106"><a class="lnlinks" href="#L1106">1106</a></span><span class="cl"><span class="c1"></span>        <span class="nx">allChats</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{</span> <span class="nx">messages</span><span class="o">:</span> <span class="p">[</span><span class="p">]</span><span class="p">,</span> <span class="nx">userInfo</span><span class="p">,</span> <span class="nx">sessionId</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1107"><a class="lnlinks" href="#L1107">1107</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1108"><a class="lnlinks" href="#L1108">1108</a></span><span class="cl">        <span class="c1">// Notify visitor of their position
</span></span></span><span class="line"><span class="ln" id="L1109"><a class="lnlinks" href="#L1109">1109</a></span><span class="cl"><span class="c1"></span>        <span class="nx">updateVisitorStatus</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1110"><a class="lnlinks" href="#L1110">1110</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1111"><a class="lnlinks" href="#L1111">1111</a></span><span class="cl">        <span class="c1">// Notify owner of new queue with user info
</span></span></span><span class="line"><span class="ln" id="L1112"><a class="lnlinks" href="#L1112">1112</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1113"><a class="lnlinks" href="#L1113">1113</a></span><span class="cl">            <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_update&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1114"><a class="lnlinks" href="#L1114">1114</a></span><span class="cl">                <span class="nx">count</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1115"><a class="lnlinks" href="#L1115">1115</a></span><span class="cl">                <span class="nx">queue</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1116"><a class="lnlinks" href="#L1116">1116</a></span><span class="cl">                <span class="nx">active</span><span class="o">:</span> <span class="nx">activeChat</span> <span class="o">?</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1117"><a class="lnlinks" href="#L1117">1117</a></span><span class="cl">                    <span class="nx">socketId</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1118"><a class="lnlinks" href="#L1118">1118</a></span><span class="cl">                    <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">userInfo</span>
</span></span><span class="line"><span class="ln" id="L1119"><a class="lnlinks" href="#L1119">1119</a></span><span class="cl">                <span class="p">}</span> <span class="o">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="ln" id="L1120"><a class="lnlinks" href="#L1120">1120</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1121"><a class="lnlinks" href="#L1121">1121</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1122"><a class="lnlinks" href="#L1122">1122</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1123"><a class="lnlinks" href="#L1123">1123</a></span><span class="cl">        <span class="c1">// Try to start chat if owner is free
</span></span></span><span class="line"><span class="ln" id="L1124"><a class="lnlinks" href="#L1124">1124</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">ownerSocketId</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">activeChat</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1125"><a class="lnlinks" href="#L1125">1125</a></span><span class="cl">            <span class="nx">startNextChat</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1126"><a class="lnlinks" href="#L1126">1126</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1127"><a class="lnlinks" href="#L1127">1127</a></span><span class="cl">    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1128"><a class="lnlinks" href="#L1128">1128</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1129"><a class="lnlinks" href="#L1129">1129</a></span><span class="cl">    <span class="c1">// 3. Send Message
</span></span></span><span class="line"><span class="ln" id="L1130"><a class="lnlinks" href="#L1130">1130</a></span><span class="cl"><span class="c1"></span>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;send_message&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1131"><a class="lnlinks" href="#L1131">1131</a></span><span class="cl">        <span class="c1">// data: { text: string, targetSocketId?: string }
</span></span></span><span class="line"><span class="ln" id="L1132"><a class="lnlinks" href="#L1132">1132</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">targetSocketId</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">targetSocketId</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1133"><a class="lnlinks" href="#L1133">1133</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1134"><a class="lnlinks" href="#L1134">1134</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">ownerSocketId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1135"><a class="lnlinks" href="#L1135">1135</a></span><span class="cl">            <span class="c1">// Owner sent message -&gt; send to specified visitor or active visitor
</span></span></span><span class="line"><span class="ln" id="L1136"><a class="lnlinks" href="#L1136">1136</a></span><span class="cl"><span class="c1"></span>            <span class="kr">const</span> <span class="nx">recipientId</span> <span class="o">=</span> <span class="nx">targetSocketId</span> <span class="o">||</span> <span class="p">(</span><span class="nx">activeChat</span> <span class="o">?</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span> <span class="o">:</span> <span class="kc">null</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1137"><a class="lnlinks" href="#L1137">1137</a></span><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">recipientId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1138"><a class="lnlinks" href="#L1138">1138</a></span><span class="cl">                <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">recipientId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;receive_message&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1139"><a class="lnlinks" href="#L1139">1139</a></span><span class="cl">                    <span class="nx">text</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1140"><a class="lnlinks" href="#L1140">1140</a></span><span class="cl">                    <span class="nx">sender</span><span class="o">:</span> <span class="s1">&#39;owner&#39;</span>
</span></span><span class="line"><span class="ln" id="L1141"><a class="lnlinks" href="#L1141">1141</a></span><span class="cl">                <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1142"><a class="lnlinks" href="#L1142">1142</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1143"><a class="lnlinks" href="#L1143">1143</a></span><span class="cl">                <span class="c1">// Store message in chat history
</span></span></span><span class="line"><span class="ln" id="L1144"><a class="lnlinks" href="#L1144">1144</a></span><span class="cl"><span class="c1"></span>                <span class="kr">const</span> <span class="nx">chatData</span> <span class="o">=</span> <span class="nx">allChats</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">recipientId</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1145"><a class="lnlinks" href="#L1145">1145</a></span><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">chatData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1146"><a class="lnlinks" href="#L1146">1146</a></span><span class="cl">                    <span class="nx">chatData</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="p">{</span> <span class="nx">sender</span><span class="o">:</span> <span class="s1">&#39;owner&#39;</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">timestamp</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(</span><span class="p">)</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1147"><a class="lnlinks" href="#L1147">1147</a></span><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1148"><a class="lnlinks" href="#L1148">1148</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1149"><a class="lnlinks" href="#L1149">1149</a></span><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1150"><a class="lnlinks" href="#L1150">1150</a></span><span class="cl">            <span class="c1">// Visitor sent message
</span></span></span><span class="line"><span class="ln" id="L1151"><a class="lnlinks" href="#L1151">1151</a></span><span class="cl"><span class="c1"></span>            <span class="c1">// Store message in chat history regardless of owner being online
</span></span></span><span class="line"><span class="ln" id="L1152"><a class="lnlinks" href="#L1152">1152</a></span><span class="cl"><span class="c1"></span>            <span class="kr">const</span> <span class="nx">chatData</span> <span class="o">=</span> <span class="nx">allChats</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1153"><a class="lnlinks" href="#L1153">1153</a></span><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">chatData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1154"><a class="lnlinks" href="#L1154">1154</a></span><span class="cl">                <span class="nx">chatData</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="p">{</span> <span class="nx">sender</span><span class="o">:</span> <span class="s1">&#39;visitor&#39;</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">timestamp</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(</span><span class="p">)</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1155"><a class="lnlinks" href="#L1155">1155</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1156"><a class="lnlinks" href="#L1156">1156</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1157"><a class="lnlinks" href="#L1157">1157</a></span><span class="cl">            <span class="c1">// If owner is online, send message to owner
</span></span></span><span class="line"><span class="ln" id="L1158"><a class="lnlinks" href="#L1158">1158</a></span><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">ownerSocketId</span> <span class="o">&amp;&amp;</span> <span class="nx">activeChat</span> <span class="o">&amp;&amp;</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1159"><a class="lnlinks" href="#L1159">1159</a></span><span class="cl">                <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;receive_message&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1160"><a class="lnlinks" href="#L1160">1160</a></span><span class="cl">                    <span class="nx">text</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1161"><a class="lnlinks" href="#L1161">1161</a></span><span class="cl">                    <span class="nx">sender</span><span class="o">:</span> <span class="s1">&#39;visitor&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1162"><a class="lnlinks" href="#L1162">1162</a></span><span class="cl">                    <span class="nx">fromSocketId</span><span class="o">:</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span>
</span></span><span class="line"><span class="ln" id="L1163"><a class="lnlinks" href="#L1163">1163</a></span><span class="cl">                <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1164"><a class="lnlinks" href="#L1164">1164</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1165"><a class="lnlinks" href="#L1165">1165</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1166"><a class="lnlinks" href="#L1166">1166</a></span><span class="cl">    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1167"><a class="lnlinks" href="#L1167">1167</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1168"><a class="lnlinks" href="#L1168">1168</a></span><span class="cl">    <span class="c1">// 4. Switch Chat (Owner selects different visitor)
</span></span></span><span class="line"><span class="ln" id="L1169"><a class="lnlinks" href="#L1169">1169</a></span><span class="cl"><span class="c1"></span>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;switch_chat&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1170"><a class="lnlinks" href="#L1170">1170</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">ownerSocketId</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1171"><a class="lnlinks" href="#L1171">1171</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1172"><a class="lnlinks" href="#L1172">1172</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">targetSocketId</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1173"><a class="lnlinks" href="#L1173">1173</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1174"><a class="lnlinks" href="#L1174">1174</a></span><span class="cl">        <span class="c1">// Check if target is in queue or already active
</span></span></span><span class="line"><span class="ln" id="L1175"><a class="lnlinks" href="#L1175">1175</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">inQueue</span> <span class="o">=</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">q</span> <span class="p">=&gt;</span> <span class="nx">q</span><span class="p">.</span><span class="nx">socketId</span> <span class="o">===</span> <span class="nx">targetSocketId</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1176"><a class="lnlinks" href="#L1176">1176</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">isActive</span> <span class="o">=</span> <span class="nx">activeChat</span> <span class="o">&amp;&amp;</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span> <span class="o">===</span> <span class="nx">targetSocketId</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1177"><a class="lnlinks" href="#L1177">1177</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1178"><a class="lnlinks" href="#L1178">1178</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">inQueue</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isActive</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1179"><a class="lnlinks" href="#L1179">1179</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1180"><a class="lnlinks" href="#L1180">1180</a></span><span class="cl">        <span class="c1">// If switching to someone in queue, move them to active and put current back in queue
</span></span></span><span class="line"><span class="ln" id="L1181"><a class="lnlinks" href="#L1181">1181</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">inQueue</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isActive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1182"><a class="lnlinks" href="#L1182">1182</a></span><span class="cl">            <span class="c1">// Put current active back in queue (at front)
</span></span></span><span class="line"><span class="ln" id="L1183"><a class="lnlinks" href="#L1183">1183</a></span><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">activeChat</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1184"><a class="lnlinks" href="#L1184">1184</a></span><span class="cl">                <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1185"><a class="lnlinks" href="#L1185">1185</a></span><span class="cl">                    <span class="nx">socketId</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1186"><a class="lnlinks" href="#L1186">1186</a></span><span class="cl">                    <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">userInfo</span>
</span></span><span class="line"><span class="ln" id="L1187"><a class="lnlinks" href="#L1187">1187</a></span><span class="cl">                <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1188"><a class="lnlinks" href="#L1188">1188</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1189"><a class="lnlinks" href="#L1189">1189</a></span><span class="cl">                <span class="c1">// Notify previous active visitor they&#39;re back in queue
</span></span></span><span class="line"><span class="ln" id="L1190"><a class="lnlinks" href="#L1190">1190</a></span><span class="cl"><span class="c1"></span>                <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_status&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1191"><a class="lnlinks" href="#L1191">1191</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1192"><a class="lnlinks" href="#L1192">1192</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1193"><a class="lnlinks" href="#L1193">1193</a></span><span class="cl">            <span class="c1">// Remove new active from queue
</span></span></span><span class="line"><span class="ln" id="L1194"><a class="lnlinks" href="#L1194">1194</a></span><span class="cl"><span class="c1"></span>            <span class="nx">waitingQueue</span> <span class="o">=</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">q</span> <span class="p">=&gt;</span> <span class="nx">q</span><span class="p">.</span><span class="nx">socketId</span> <span class="o">!==</span> <span class="nx">targetSocketId</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1195"><a class="lnlinks" href="#L1195">1195</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1196"><a class="lnlinks" href="#L1196">1196</a></span><span class="cl">            <span class="c1">// Set new active chat
</span></span></span><span class="line"><span class="ln" id="L1197"><a class="lnlinks" href="#L1197">1197</a></span><span class="cl"><span class="c1"></span>            <span class="nx">activeChat</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1198"><a class="lnlinks" href="#L1198">1198</a></span><span class="cl">                <span class="nx">visitorId</span><span class="o">:</span> <span class="nx">targetSocketId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1199"><a class="lnlinks" href="#L1199">1199</a></span><span class="cl">                <span class="nx">ownerId</span><span class="o">:</span> <span class="nx">ownerSocketId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1200"><a class="lnlinks" href="#L1200">1200</a></span><span class="cl">                <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">inQueue</span><span class="p">.</span><span class="nx">userInfo</span>
</span></span><span class="line"><span class="ln" id="L1201"><a class="lnlinks" href="#L1201">1201</a></span><span class="cl">            <span class="p">}</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1202"><a class="lnlinks" href="#L1202">1202</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1203"><a class="lnlinks" href="#L1203">1203</a></span><span class="cl">            <span class="c1">// Notify new active visitor
</span></span></span><span class="line"><span class="ln" id="L1204"><a class="lnlinks" href="#L1204">1204</a></span><span class="cl"><span class="c1"></span>            <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">targetSocketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat_started&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1205"><a class="lnlinks" href="#L1205">1205</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1206"><a class="lnlinks" href="#L1206">1206</a></span><span class="cl">            <span class="c1">// Send chat history to owner
</span></span></span><span class="line"><span class="ln" id="L1207"><a class="lnlinks" href="#L1207">1207</a></span><span class="cl"><span class="c1"></span>            <span class="kr">const</span> <span class="nx">chatData</span> <span class="o">=</span> <span class="nx">allChats</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">targetSocketId</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1208"><a class="lnlinks" href="#L1208">1208</a></span><span class="cl">            <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat_history&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1209"><a class="lnlinks" href="#L1209">1209</a></span><span class="cl">                <span class="nx">socketId</span><span class="o">:</span> <span class="nx">targetSocketId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1210"><a class="lnlinks" href="#L1210">1210</a></span><span class="cl">                <span class="nx">messages</span><span class="o">:</span> <span class="nx">chatData</span><span class="o">?</span><span class="p">.</span><span class="nx">messages</span> <span class="o">||</span> <span class="p">[</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1211"><a class="lnlinks" href="#L1211">1211</a></span><span class="cl">                <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">chatData</span><span class="o">?</span><span class="p">.</span><span class="nx">userInfo</span> <span class="o">||</span> <span class="p">{</span><span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1212"><a class="lnlinks" href="#L1212">1212</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1213"><a class="lnlinks" href="#L1213">1213</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1214"><a class="lnlinks" href="#L1214">1214</a></span><span class="cl">            <span class="c1">// Update owner&#39;s queue view
</span></span></span><span class="line"><span class="ln" id="L1215"><a class="lnlinks" href="#L1215">1215</a></span><span class="cl"><span class="c1"></span>            <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_update&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1216"><a class="lnlinks" href="#L1216">1216</a></span><span class="cl">                <span class="nx">count</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1217"><a class="lnlinks" href="#L1217">1217</a></span><span class="cl">                <span class="nx">queue</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1218"><a class="lnlinks" href="#L1218">1218</a></span><span class="cl">                <span class="nx">active</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1219"><a class="lnlinks" href="#L1219">1219</a></span><span class="cl">                    <span class="nx">socketId</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1220"><a class="lnlinks" href="#L1220">1220</a></span><span class="cl">                    <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">userInfo</span>
</span></span><span class="line"><span class="ln" id="L1221"><a class="lnlinks" href="#L1221">1221</a></span><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1222"><a class="lnlinks" href="#L1222">1222</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1223"><a class="lnlinks" href="#L1223">1223</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1224"><a class="lnlinks" href="#L1224">1224</a></span><span class="cl">            <span class="c1">// Update other waiters
</span></span></span><span class="line"><span class="ln" id="L1225"><a class="lnlinks" href="#L1225">1225</a></span><span class="cl"><span class="c1"></span>            <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span> <span class="nx">idx</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1226"><a class="lnlinks" href="#L1226">1226</a></span><span class="cl">                <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">socketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_status&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="nx">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1227"><a class="lnlinks" href="#L1227">1227</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1228"><a class="lnlinks" href="#L1228">1228</a></span><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isActive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1229"><a class="lnlinks" href="#L1229">1229</a></span><span class="cl">            <span class="c1">// Just send the chat history if clicking on already active user
</span></span></span><span class="line"><span class="ln" id="L1230"><a class="lnlinks" href="#L1230">1230</a></span><span class="cl"><span class="c1"></span>            <span class="kr">const</span> <span class="nx">chatData</span> <span class="o">=</span> <span class="nx">allChats</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">targetSocketId</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1231"><a class="lnlinks" href="#L1231">1231</a></span><span class="cl">            <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat_history&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1232"><a class="lnlinks" href="#L1232">1232</a></span><span class="cl">                <span class="nx">socketId</span><span class="o">:</span> <span class="nx">targetSocketId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1233"><a class="lnlinks" href="#L1233">1233</a></span><span class="cl">                <span class="nx">messages</span><span class="o">:</span> <span class="nx">chatData</span><span class="o">?</span><span class="p">.</span><span class="nx">messages</span> <span class="o">||</span> <span class="p">[</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1234"><a class="lnlinks" href="#L1234">1234</a></span><span class="cl">                <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">chatData</span><span class="o">?</span><span class="p">.</span><span class="nx">userInfo</span> <span class="o">||</span> <span class="p">{</span><span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1235"><a class="lnlinks" href="#L1235">1235</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1236"><a class="lnlinks" href="#L1236">1236</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1237"><a class="lnlinks" href="#L1237">1237</a></span><span class="cl">    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1238"><a class="lnlinks" href="#L1238">1238</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1239"><a class="lnlinks" href="#L1239">1239</a></span><span class="cl">    <span class="c1">// 5. Close Chat (Owner closes specific user&#39;s chat)
</span></span></span><span class="line"><span class="ln" id="L1240"><a class="lnlinks" href="#L1240">1240</a></span><span class="cl"><span class="c1"></span>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close_chat&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1241"><a class="lnlinks" href="#L1241">1241</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">ownerSocketId</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1242"><a class="lnlinks" href="#L1242">1242</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1243"><a class="lnlinks" href="#L1243">1243</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">targetSocketId</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1244"><a class="lnlinks" href="#L1244">1244</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1245"><a class="lnlinks" href="#L1245">1245</a></span><span class="cl">        <span class="c1">// Save chat to file
</span></span></span><span class="line"><span class="ln" id="L1246"><a class="lnlinks" href="#L1246">1246</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">chatData</span> <span class="o">=</span> <span class="nx">allChats</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">targetSocketId</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1247"><a class="lnlinks" href="#L1247">1247</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">chatData</span> <span class="o">&amp;&amp;</span> <span class="nx">chatData</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1248"><a class="lnlinks" href="#L1248">1248</a></span><span class="cl">            <span class="nx">saveChatToFile</span><span class="p">(</span><span class="nx">targetSocketId</span><span class="p">,</span> <span class="nx">chatData</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1249"><a class="lnlinks" href="#L1249">1249</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1250"><a class="lnlinks" href="#L1250">1250</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1251"><a class="lnlinks" href="#L1251">1251</a></span><span class="cl">        <span class="c1">// Remove from queue or active
</span></span></span><span class="line"><span class="ln" id="L1252"><a class="lnlinks" href="#L1252">1252</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">queueIndex</span> <span class="o">=</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">(</span><span class="nx">q</span> <span class="p">=&gt;</span> <span class="nx">q</span><span class="p">.</span><span class="nx">socketId</span> <span class="o">===</span> <span class="nx">targetSocketId</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1253"><a class="lnlinks" href="#L1253">1253</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">queueIndex</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1254"><a class="lnlinks" href="#L1254">1254</a></span><span class="cl">            <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">queueIndex</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1255"><a class="lnlinks" href="#L1255">1255</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1256"><a class="lnlinks" href="#L1256">1256</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1257"><a class="lnlinks" href="#L1257">1257</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">activeChat</span> <span class="o">&amp;&amp;</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span> <span class="o">===</span> <span class="nx">targetSocketId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1258"><a class="lnlinks" href="#L1258">1258</a></span><span class="cl">            <span class="c1">// Notify visitor that chat ended
</span></span></span><span class="line"><span class="ln" id="L1259"><a class="lnlinks" href="#L1259">1259</a></span><span class="cl"><span class="c1"></span>            <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">targetSocketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat_ended&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">reason</span><span class="o">:</span> <span class="s1">&#39;owner_closed&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1260"><a class="lnlinks" href="#L1260">1260</a></span><span class="cl">            <span class="nx">activeChat</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1261"><a class="lnlinks" href="#L1261">1261</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1262"><a class="lnlinks" href="#L1262">1262</a></span><span class="cl">            <span class="c1">// Start next chat if available
</span></span></span><span class="line"><span class="ln" id="L1263"><a class="lnlinks" href="#L1263">1263</a></span><span class="cl"><span class="c1"></span>            <span class="nx">startNextChat</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1264"><a class="lnlinks" href="#L1264">1264</a></span><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1265"><a class="lnlinks" href="#L1265">1265</a></span><span class="cl">            <span class="c1">// Just notify the visitor in queue
</span></span></span><span class="line"><span class="ln" id="L1266"><a class="lnlinks" href="#L1266">1266</a></span><span class="cl"><span class="c1"></span>            <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">targetSocketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat_ended&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">reason</span><span class="o">:</span> <span class="s1">&#39;owner_closed&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1267"><a class="lnlinks" href="#L1267">1267</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1268"><a class="lnlinks" href="#L1268">1268</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1269"><a class="lnlinks" href="#L1269">1269</a></span><span class="cl">        <span class="c1">// Update owner&#39;s queue
</span></span></span><span class="line"><span class="ln" id="L1270"><a class="lnlinks" href="#L1270">1270</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1271"><a class="lnlinks" href="#L1271">1271</a></span><span class="cl">            <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_update&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1272"><a class="lnlinks" href="#L1272">1272</a></span><span class="cl">                <span class="nx">count</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1273"><a class="lnlinks" href="#L1273">1273</a></span><span class="cl">                <span class="nx">queue</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1274"><a class="lnlinks" href="#L1274">1274</a></span><span class="cl">                <span class="nx">active</span><span class="o">:</span> <span class="nx">activeChat</span> <span class="o">?</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1275"><a class="lnlinks" href="#L1275">1275</a></span><span class="cl">                    <span class="nx">socketId</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1276"><a class="lnlinks" href="#L1276">1276</a></span><span class="cl">                    <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">userInfo</span>
</span></span><span class="line"><span class="ln" id="L1277"><a class="lnlinks" href="#L1277">1277</a></span><span class="cl">                <span class="p">}</span> <span class="o">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="ln" id="L1278"><a class="lnlinks" href="#L1278">1278</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1279"><a class="lnlinks" href="#L1279">1279</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1280"><a class="lnlinks" href="#L1280">1280</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1281"><a class="lnlinks" href="#L1281">1281</a></span><span class="cl">        <span class="c1">// Update other waiters
</span></span></span><span class="line"><span class="ln" id="L1282"><a class="lnlinks" href="#L1282">1282</a></span><span class="cl"><span class="c1"></span>        <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span> <span class="nx">idx</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1283"><a class="lnlinks" href="#L1283">1283</a></span><span class="cl">            <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">socketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_status&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="nx">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1284"><a class="lnlinks" href="#L1284">1284</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1285"><a class="lnlinks" href="#L1285">1285</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1286"><a class="lnlinks" href="#L1286">1286</a></span><span class="cl">        <span class="c1">// Don&#39;t delete chat data immediately - keep for potential reconnection
</span></span></span><span class="line"><span class="ln" id="L1287"><a class="lnlinks" href="#L1287">1287</a></span><span class="cl"><span class="c1"></span>    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1288"><a class="lnlinks" href="#L1288">1288</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1289"><a class="lnlinks" href="#L1289">1289</a></span><span class="cl">    <span class="c1">// 6. Visitor closes chat
</span></span></span><span class="line"><span class="ln" id="L1290"><a class="lnlinks" href="#L1290">1290</a></span><span class="cl"><span class="c1"></span>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;visitor_close&#39;</span><span class="p">,</span> <span class="p">(</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1291"><a class="lnlinks" href="#L1291">1291</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">ownerSocketId</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1292"><a class="lnlinks" href="#L1292">1292</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1293"><a class="lnlinks" href="#L1293">1293</a></span><span class="cl">        <span class="c1">// Save chat to file
</span></span></span><span class="line"><span class="ln" id="L1294"><a class="lnlinks" href="#L1294">1294</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">chatData</span> <span class="o">=</span> <span class="nx">allChats</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1295"><a class="lnlinks" href="#L1295">1295</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">chatData</span> <span class="o">&amp;&amp;</span> <span class="nx">chatData</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1296"><a class="lnlinks" href="#L1296">1296</a></span><span class="cl">            <span class="nx">saveChatToFile</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">chatData</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1297"><a class="lnlinks" href="#L1297">1297</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1298"><a class="lnlinks" href="#L1298">1298</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1299"><a class="lnlinks" href="#L1299">1299</a></span><span class="cl">        <span class="c1">// Reset chat history but keep the data structure for potential reconnection
</span></span></span><span class="line"><span class="ln" id="L1300"><a class="lnlinks" href="#L1300">1300</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">allChats</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1301"><a class="lnlinks" href="#L1301">1301</a></span><span class="cl">            <span class="kr">const</span> <span class="nx">chatData</span> <span class="o">=</span> <span class="nx">allChats</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1302"><a class="lnlinks" href="#L1302">1302</a></span><span class="cl">            <span class="nx">allChats</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1303"><a class="lnlinks" href="#L1303">1303</a></span><span class="cl">                <span class="nx">messages</span><span class="o">:</span> <span class="p">[</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1304"><a class="lnlinks" href="#L1304">1304</a></span><span class="cl">                <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">chatData</span><span class="p">.</span><span class="nx">userInfo</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1305"><a class="lnlinks" href="#L1305">1305</a></span><span class="cl">                <span class="nx">sessionId</span><span class="o">:</span> <span class="nx">chatData</span><span class="p">.</span><span class="nx">sessionId</span>
</span></span><span class="line"><span class="ln" id="L1306"><a class="lnlinks" href="#L1306">1306</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1307"><a class="lnlinks" href="#L1307">1307</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1308"><a class="lnlinks" href="#L1308">1308</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1309"><a class="lnlinks" href="#L1309">1309</a></span><span class="cl">        <span class="c1">// Remove from queue or active
</span></span></span><span class="line"><span class="ln" id="L1310"><a class="lnlinks" href="#L1310">1310</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">queueIndex</span> <span class="o">=</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">(</span><span class="nx">q</span> <span class="p">=&gt;</span> <span class="nx">q</span><span class="p">.</span><span class="nx">socketId</span> <span class="o">===</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1311"><a class="lnlinks" href="#L1311">1311</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">queueIndex</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1312"><a class="lnlinks" href="#L1312">1312</a></span><span class="cl">            <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">queueIndex</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1313"><a class="lnlinks" href="#L1313">1313</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1314"><a class="lnlinks" href="#L1314">1314</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1315"><a class="lnlinks" href="#L1315">1315</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">activeChat</span> <span class="o">&amp;&amp;</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span> <span class="o">===</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1316"><a class="lnlinks" href="#L1316">1316</a></span><span class="cl">            <span class="nx">activeChat</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1317"><a class="lnlinks" href="#L1317">1317</a></span><span class="cl">            <span class="c1">// Start next chat
</span></span></span><span class="line"><span class="ln" id="L1318"><a class="lnlinks" href="#L1318">1318</a></span><span class="cl"><span class="c1"></span>            <span class="nx">startNextChat</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1319"><a class="lnlinks" href="#L1319">1319</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1320"><a class="lnlinks" href="#L1320">1320</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1321"><a class="lnlinks" href="#L1321">1321</a></span><span class="cl">        <span class="c1">// Update owner
</span></span></span><span class="line"><span class="ln" id="L1322"><a class="lnlinks" href="#L1322">1322</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1323"><a class="lnlinks" href="#L1323">1323</a></span><span class="cl">            <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_update&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1324"><a class="lnlinks" href="#L1324">1324</a></span><span class="cl">                <span class="nx">count</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1325"><a class="lnlinks" href="#L1325">1325</a></span><span class="cl">                <span class="nx">queue</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1326"><a class="lnlinks" href="#L1326">1326</a></span><span class="cl">                <span class="nx">active</span><span class="o">:</span> <span class="nx">activeChat</span> <span class="o">?</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1327"><a class="lnlinks" href="#L1327">1327</a></span><span class="cl">                    <span class="nx">socketId</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1328"><a class="lnlinks" href="#L1328">1328</a></span><span class="cl">                    <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">userInfo</span>
</span></span><span class="line"><span class="ln" id="L1329"><a class="lnlinks" href="#L1329">1329</a></span><span class="cl">                <span class="p">}</span> <span class="o">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="ln" id="L1330"><a class="lnlinks" href="#L1330">1330</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1331"><a class="lnlinks" href="#L1331">1331</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1332"><a class="lnlinks" href="#L1332">1332</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1333"><a class="lnlinks" href="#L1333">1333</a></span><span class="cl">        <span class="c1">// Update other waiters
</span></span></span><span class="line"><span class="ln" id="L1334"><a class="lnlinks" href="#L1334">1334</a></span><span class="cl"><span class="c1"></span>        <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span> <span class="nx">idx</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1335"><a class="lnlinks" href="#L1335">1335</a></span><span class="cl">            <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">socketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_status&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="nx">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1336"><a class="lnlinks" href="#L1336">1336</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1337"><a class="lnlinks" href="#L1337">1337</a></span><span class="cl">    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1338"><a class="lnlinks" href="#L1338">1338</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1339"><a class="lnlinks" href="#L1339">1339</a></span><span class="cl">    <span class="c1">// 7. End Chat (Owner triggered - legacy)
</span></span></span><span class="line"><span class="ln" id="L1340"><a class="lnlinks" href="#L1340">1340</a></span><span class="cl"><span class="c1"></span>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end_chat&#39;</span><span class="p">,</span> <span class="p">(</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1341"><a class="lnlinks" href="#L1341">1341</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">ownerSocketId</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1342"><a class="lnlinks" href="#L1342">1342</a></span><span class="cl">        <span class="nx">endCurrentChat</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1343"><a class="lnlinks" href="#L1343">1343</a></span><span class="cl">    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1344"><a class="lnlinks" href="#L1344">1344</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1345"><a class="lnlinks" href="#L1345">1345</a></span><span class="cl">    <span class="c1">// 8. Disconnect
</span></span></span><span class="line"><span class="ln" id="L1346"><a class="lnlinks" href="#L1346">1346</a></span><span class="cl"><span class="c1"></span>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="p">(</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1347"><a class="lnlinks" href="#L1347">1347</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;User disconnected:&#39;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1348"><a class="lnlinks" href="#L1348">1348</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1349"><a class="lnlinks" href="#L1349">1349</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">ownerSocketId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1350"><a class="lnlinks" href="#L1350">1350</a></span><span class="cl">            <span class="nx">ownerSocketId</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1351"><a class="lnlinks" href="#L1351">1351</a></span><span class="cl">            <span class="c1">// Optionally notify active visitor that owner left?
</span></span></span><span class="line"><span class="ln" id="L1352"><a class="lnlinks" href="#L1352">1352</a></span><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1353"><a class="lnlinks" href="#L1353">1353</a></span><span class="cl">            <span class="c1">// Remove from queue if present
</span></span></span><span class="line"><span class="ln" id="L1354"><a class="lnlinks" href="#L1354">1354</a></span><span class="cl"><span class="c1"></span>            <span class="kr">const</span> <span class="nx">queueIndex</span> <span class="o">=</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">(</span><span class="nx">q</span> <span class="p">=&gt;</span> <span class="nx">q</span><span class="p">.</span><span class="nx">socketId</span> <span class="o">===</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1355"><a class="lnlinks" href="#L1355">1355</a></span><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">queueIndex</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1356"><a class="lnlinks" href="#L1356">1356</a></span><span class="cl">                <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">queueIndex</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1357"><a class="lnlinks" href="#L1357">1357</a></span><span class="cl">                <span class="c1">// Notify everyone behind them that position changed
</span></span></span><span class="line"><span class="ln" id="L1358"><a class="lnlinks" href="#L1358">1358</a></span><span class="cl"><span class="c1"></span>                <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span> <span class="nx">idx</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1359"><a class="lnlinks" href="#L1359">1359</a></span><span class="cl">                    <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">socketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_status&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="nx">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1360"><a class="lnlinks" href="#L1360">1360</a></span><span class="cl">                <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1361"><a class="lnlinks" href="#L1361">1361</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1362"><a class="lnlinks" href="#L1362">1362</a></span><span class="cl">                <span class="c1">// Notify owner
</span></span></span><span class="line"><span class="ln" id="L1363"><a class="lnlinks" href="#L1363">1363</a></span><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1364"><a class="lnlinks" href="#L1364">1364</a></span><span class="cl">                    <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_update&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1365"><a class="lnlinks" href="#L1365">1365</a></span><span class="cl">                        <span class="nx">count</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1366"><a class="lnlinks" href="#L1366">1366</a></span><span class="cl">                        <span class="nx">queue</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1367"><a class="lnlinks" href="#L1367">1367</a></span><span class="cl">                        <span class="nx">active</span><span class="o">:</span> <span class="nx">activeChat</span> <span class="o">?</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1368"><a class="lnlinks" href="#L1368">1368</a></span><span class="cl">                            <span class="nx">socketId</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1369"><a class="lnlinks" href="#L1369">1369</a></span><span class="cl">                            <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">userInfo</span>
</span></span><span class="line"><span class="ln" id="L1370"><a class="lnlinks" href="#L1370">1370</a></span><span class="cl">                        <span class="p">}</span> <span class="o">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="ln" id="L1371"><a class="lnlinks" href="#L1371">1371</a></span><span class="cl">                    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1372"><a class="lnlinks" href="#L1372">1372</a></span><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1373"><a class="lnlinks" href="#L1373">1373</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1374"><a class="lnlinks" href="#L1374">1374</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1375"><a class="lnlinks" href="#L1375">1375</a></span><span class="cl">            <span class="c1">// End active chat if it was this visitor
</span></span></span><span class="line"><span class="ln" id="L1376"><a class="lnlinks" href="#L1376">1376</a></span><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">activeChat</span> <span class="o">&amp;&amp;</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span> <span class="o">===</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1377"><a class="lnlinks" href="#L1377">1377</a></span><span class="cl">                <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat_ended&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">reason</span><span class="o">:</span> <span class="s1">&#39;visitor_disconnected&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1378"><a class="lnlinks" href="#L1378">1378</a></span><span class="cl">                <span class="nx">activeChat</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1379"><a class="lnlinks" href="#L1379">1379</a></span><span class="cl">                <span class="c1">// Auto-start next chat?
</span></span></span><span class="line"><span class="ln" id="L1380"><a class="lnlinks" href="#L1380">1380</a></span><span class="cl"><span class="c1"></span>                <span class="nx">startNextChat</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1381"><a class="lnlinks" href="#L1381">1381</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1382"><a class="lnlinks" href="#L1382">1382</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1383"><a class="lnlinks" href="#L1383">1383</a></span><span class="cl">            <span class="c1">// Keep chat history for a while (could clean up after timeout)
</span></span></span><span class="line"><span class="ln" id="L1384"><a class="lnlinks" href="#L1384">1384</a></span><span class="cl"><span class="c1"></span>            <span class="c1">// For now, we keep it in memory
</span></span></span><span class="line"><span class="ln" id="L1385"><a class="lnlinks" href="#L1385">1385</a></span><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1386"><a class="lnlinks" href="#L1386">1386</a></span><span class="cl">    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1387"><a class="lnlinks" href="#L1387">1387</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1388"><a class="lnlinks" href="#L1388">1388</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1389"><a class="lnlinks" href="#L1389">1389</a></span><span class="cl"><span class="kd">function</span> <span class="nx">startNextChat</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1390"><a class="lnlinks" href="#L1390">1390</a></span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1391"><a class="lnlinks" href="#L1391">1391</a></span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ownerSocketId</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1392"><a class="lnlinks" href="#L1392">1392</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1393"><a class="lnlinks" href="#L1393">1393</a></span><span class="cl">    <span class="kr">const</span> <span class="nx">nextVisitor</span> <span class="o">=</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">shift</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1394"><a class="lnlinks" href="#L1394">1394</a></span><span class="cl">    <span class="nx">activeChat</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1395"><a class="lnlinks" href="#L1395">1395</a></span><span class="cl">        <span class="nx">visitorId</span><span class="o">:</span> <span class="nx">nextVisitor</span><span class="p">.</span><span class="nx">socketId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1396"><a class="lnlinks" href="#L1396">1396</a></span><span class="cl">        <span class="nx">ownerId</span><span class="o">:</span> <span class="nx">ownerSocketId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1397"><a class="lnlinks" href="#L1397">1397</a></span><span class="cl">        <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">nextVisitor</span><span class="p">.</span><span class="nx">userInfo</span>
</span></span><span class="line"><span class="ln" id="L1398"><a class="lnlinks" href="#L1398">1398</a></span><span class="cl">    <span class="p">}</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1399"><a class="lnlinks" href="#L1399">1399</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1400"><a class="lnlinks" href="#L1400">1400</a></span><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Starting chat with:&#39;</span><span class="p">,</span> <span class="nx">nextVisitor</span><span class="p">.</span><span class="nx">socketId</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1401"><a class="lnlinks" href="#L1401">1401</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1402"><a class="lnlinks" href="#L1402">1402</a></span><span class="cl">    <span class="c1">// Send chat history to owner
</span></span></span><span class="line"><span class="ln" id="L1403"><a class="lnlinks" href="#L1403">1403</a></span><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">chatData</span> <span class="o">=</span> <span class="nx">allChats</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">nextVisitor</span><span class="p">.</span><span class="nx">socketId</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1404"><a class="lnlinks" href="#L1404">1404</a></span><span class="cl">    <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat_history&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1405"><a class="lnlinks" href="#L1405">1405</a></span><span class="cl">        <span class="nx">socketId</span><span class="o">:</span> <span class="nx">nextVisitor</span><span class="p">.</span><span class="nx">socketId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1406"><a class="lnlinks" href="#L1406">1406</a></span><span class="cl">        <span class="nx">messages</span><span class="o">:</span> <span class="nx">chatData</span><span class="o">?</span><span class="p">.</span><span class="nx">messages</span> <span class="o">||</span> <span class="p">[</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1407"><a class="lnlinks" href="#L1407">1407</a></span><span class="cl">        <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">chatData</span><span class="o">?</span><span class="p">.</span><span class="nx">userInfo</span> <span class="o">||</span> <span class="p">{</span><span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1408"><a class="lnlinks" href="#L1408">1408</a></span><span class="cl">    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1409"><a class="lnlinks" href="#L1409">1409</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1410"><a class="lnlinks" href="#L1410">1410</a></span><span class="cl">    <span class="c1">// Notify Owner
</span></span></span><span class="line"><span class="ln" id="L1411"><a class="lnlinks" href="#L1411">1411</a></span><span class="cl"><span class="c1"></span>    <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat_started&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">visitorId</span><span class="o">:</span> <span class="nx">nextVisitor</span><span class="p">.</span><span class="nx">socketId</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1412"><a class="lnlinks" href="#L1412">1412</a></span><span class="cl">    <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_update&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1413"><a class="lnlinks" href="#L1413">1413</a></span><span class="cl">        <span class="nx">count</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1414"><a class="lnlinks" href="#L1414">1414</a></span><span class="cl">        <span class="nx">queue</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1415"><a class="lnlinks" href="#L1415">1415</a></span><span class="cl">        <span class="nx">active</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1416"><a class="lnlinks" href="#L1416">1416</a></span><span class="cl">            <span class="nx">socketId</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">visitorId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1417"><a class="lnlinks" href="#L1417">1417</a></span><span class="cl">            <span class="nx">userInfo</span><span class="o">:</span> <span class="nx">activeChat</span><span class="p">.</span><span class="nx">userInfo</span>
</span></span><span class="line"><span class="ln" id="L1418"><a class="lnlinks" href="#L1418">1418</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1419"><a class="lnlinks" href="#L1419">1419</a></span><span class="cl">    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1420"><a class="lnlinks" href="#L1420">1420</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1421"><a class="lnlinks" href="#L1421">1421</a></span><span class="cl">    <span class="c1">// Notify Visitor
</span></span></span><span class="line"><span class="ln" id="L1422"><a class="lnlinks" href="#L1422">1422</a></span><span class="cl"><span class="c1"></span>    <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">nextVisitor</span><span class="p">.</span><span class="nx">socketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat_started&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1423"><a class="lnlinks" href="#L1423">1423</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1424"><a class="lnlinks" href="#L1424">1424</a></span><span class="cl">    <span class="c1">// Update remaining queue
</span></span></span><span class="line"><span class="ln" id="L1425"><a class="lnlinks" href="#L1425">1425</a></span><span class="cl"><span class="c1"></span>    <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span> <span class="nx">idx</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1426"><a class="lnlinks" href="#L1426">1426</a></span><span class="cl">        <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">socketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_status&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="nx">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1427"><a class="lnlinks" href="#L1427">1427</a></span><span class="cl">    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1428"><a class="lnlinks" href="#L1428">1428</a></span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1429"><a class="lnlinks" href="#L1429">1429</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1430"><a class="lnlinks" href="#L1430">1430</a></span><span class="cl"><span class="kd">function</span> <span class="nx">endCurrentChat</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1431"><a class="lnlinks" href="#L1431">1431</a></span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">activeChat</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1432"><a class="lnlinks" href="#L1432">1432</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1433"><a class="lnlinks" href="#L1433">1433</a></span><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">visitorId</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">activeChat</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1434"><a class="lnlinks" href="#L1434">1434</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1435"><a class="lnlinks" href="#L1435">1435</a></span><span class="cl">    <span class="c1">// Notify Visitor
</span></span></span><span class="line"><span class="ln" id="L1436"><a class="lnlinks" href="#L1436">1436</a></span><span class="cl"><span class="c1"></span>    <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">visitorId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat_ended&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">reason</span><span class="o">:</span> <span class="s1">&#39;owner_ended&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1437"><a class="lnlinks" href="#L1437">1437</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1438"><a class="lnlinks" href="#L1438">1438</a></span><span class="cl">    <span class="nx">activeChat</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1439"><a class="lnlinks" href="#L1439">1439</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1440"><a class="lnlinks" href="#L1440">1440</a></span><span class="cl">    <span class="c1">// Notify Owner (update UI)
</span></span></span><span class="line"><span class="ln" id="L1441"><a class="lnlinks" href="#L1441">1441</a></span><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1442"><a class="lnlinks" href="#L1442">1442</a></span><span class="cl">        <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">ownerSocketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_update&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1443"><a class="lnlinks" href="#L1443">1443</a></span><span class="cl">            <span class="nx">count</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1444"><a class="lnlinks" href="#L1444">1444</a></span><span class="cl">            <span class="nx">queue</span><span class="o">:</span> <span class="nx">waitingQueue</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1445"><a class="lnlinks" href="#L1445">1445</a></span><span class="cl">            <span class="nx">active</span><span class="o">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="ln" id="L1446"><a class="lnlinks" href="#L1446">1446</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1447"><a class="lnlinks" href="#L1447">1447</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1448"><a class="lnlinks" href="#L1448">1448</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1449"><a class="lnlinks" href="#L1449">1449</a></span><span class="cl">    <span class="c1">// Start next
</span></span></span><span class="line"><span class="ln" id="L1450"><a class="lnlinks" href="#L1450">1450</a></span><span class="cl"><span class="c1"></span>    <span class="nx">startNextChat</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1451"><a class="lnlinks" href="#L1451">1451</a></span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1452"><a class="lnlinks" href="#L1452">1452</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1453"><a class="lnlinks" href="#L1453">1453</a></span><span class="cl"><span class="kd">function</span> <span class="nx">updateVisitorStatus</span><span class="p">(</span><span class="nx">socketId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1454"><a class="lnlinks" href="#L1454">1454</a></span><span class="cl">    <span class="kr">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">waitingQueue</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">(</span><span class="nx">q</span> <span class="p">=&gt;</span> <span class="nx">q</span><span class="p">.</span><span class="nx">socketId</span> <span class="o">===</span> <span class="nx">socketId</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1455"><a class="lnlinks" href="#L1455">1455</a></span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1456"><a class="lnlinks" href="#L1456">1456</a></span><span class="cl">        <span class="c1">// Position 1 means 1 person ahead (index 0 = position 1)
</span></span></span><span class="line"><span class="ln" id="L1457"><a class="lnlinks" href="#L1457">1457</a></span><span class="cl"><span class="c1"></span>        <span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">socketId</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;queue_status&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1458"><a class="lnlinks" href="#L1458">1458</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1459"><a class="lnlinks" href="#L1459">1459</a></span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1460"><a class="lnlinks" href="#L1460">1460</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1461"><a class="lnlinks" href="#L1461">1461</a></span><span class="cl"><span class="c1">// --- Strava API Endpoints ---
</span></span></span><span class="line"><span class="ln" id="L1462"><a class="lnlinks" href="#L1462">1462</a></span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln" id="L1463"><a class="lnlinks" href="#L1463">1463</a></span><span class="cl"><span class="c1">// Strava OAuth - Initiate Authorization
</span></span></span><span class="line"><span class="ln" id="L1464"><a class="lnlinks" href="#L1464">1464</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/strava/auth&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1465"><a class="lnlinks" href="#L1465">1465</a></span><span class="cl">    <span class="kr">const</span> <span class="nx">clientId</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STRAVA</span><span class="nx">_CLIENT</span><span class="nx">_ID</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1466"><a class="lnlinks" href="#L1466">1466</a></span><span class="cl">    <span class="c1">// Use environment-based redirect URI (same as Google OAuth pattern)
</span></span></span><span class="line"><span class="ln" id="L1467"><a class="lnlinks" href="#L1467">1467</a></span><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">stravaRedirectUri</span> <span class="o">=</span> <span class="nx">isProduction</span>
</span></span><span class="line"><span class="ln" id="L1468"><a class="lnlinks" href="#L1468">1468</a></span><span class="cl">        <span class="o">?</span> <span class="s1">&#39;https://distilledchild.space/strava/callback&#39;</span>
</span></span><span class="line"><span class="ln" id="L1469"><a class="lnlinks" href="#L1469">1469</a></span><span class="cl">        <span class="o">:</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STRAVA</span><span class="nx">_REDIRECT</span><span class="nx">_URI</span> <span class="o">||</span> <span class="s1">&#39;http://localhost:3000/strava/callback&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1470"><a class="lnlinks" href="#L1470">1470</a></span><span class="cl">    <span class="kr">const</span> <span class="nx">redirectUri</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">stravaRedirectUri</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1471"><a class="lnlinks" href="#L1471">1471</a></span><span class="cl">    <span class="kr">const</span> <span class="nx">scope</span> <span class="o">=</span> <span class="s1">&#39;read,activity:read_all,profile:read_all,read_all&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1472"><a class="lnlinks" href="#L1472">1472</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1473"><a class="lnlinks" href="#L1473">1473</a></span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">clientId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1474"><a class="lnlinks" href="#L1474">1474</a></span><span class="cl">        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Strava client ID not configured&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1475"><a class="lnlinks" href="#L1475">1475</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1476"><a class="lnlinks" href="#L1476">1476</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1477"><a class="lnlinks" href="#L1477">1477</a></span><span class="cl">    <span class="kr">const</span> <span class="nx">authUrl</span> <span class="o">=</span> <span class="sb">`</span><span class="sb">https://www.strava.com/oauth/authorize?client_id=</span><span class="si">${</span><span class="nx">clientId</span><span class="si">}</span><span class="sb">&amp;response_type=code&amp;redirect_uri=</span><span class="si">${</span><span class="nx">redirectUri</span><span class="si">}</span><span class="sb">&amp;approval_prompt=force&amp;scope=</span><span class="si">${</span><span class="nx">scope</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1478"><a class="lnlinks" href="#L1478">1478</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1479"><a class="lnlinks" href="#L1479">1479</a></span><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">authUrl</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1480"><a class="lnlinks" href="#L1480">1480</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1481"><a class="lnlinks" href="#L1481">1481</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1482"><a class="lnlinks" href="#L1482">1482</a></span><span class="cl"><span class="c1">// Strava OAuth - Exchange Code for Token
</span></span></span><span class="line"><span class="ln" id="L1483"><a class="lnlinks" href="#L1483">1483</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/strava/exchange_token&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1484"><a class="lnlinks" href="#L1484">1484</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1485"><a class="lnlinks" href="#L1485">1485</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1486"><a class="lnlinks" href="#L1486">1486</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1487"><a class="lnlinks" href="#L1487">1487</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1488"><a class="lnlinks" href="#L1488">1488</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Authorization code is required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1489"><a class="lnlinks" href="#L1489">1489</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1490"><a class="lnlinks" href="#L1490">1490</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1491"><a class="lnlinks" href="#L1491">1491</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">clientId</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STRAVA</span><span class="nx">_CLIENT</span><span class="nx">_ID</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1492"><a class="lnlinks" href="#L1492">1492</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">clientSecret</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STRAVA</span><span class="nx">_CLIENT</span><span class="nx">_SECRET</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1493"><a class="lnlinks" href="#L1493">1493</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1494"><a class="lnlinks" href="#L1494">1494</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">clientId</span> <span class="o">||</span> <span class="o">!</span><span class="nx">clientSecret</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1495"><a class="lnlinks" href="#L1495">1495</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Strava credentials not configured&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1496"><a class="lnlinks" href="#L1496">1496</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1497"><a class="lnlinks" href="#L1497">1497</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1498"><a class="lnlinks" href="#L1498">1498</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://www.strava.com/oauth/token&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1499"><a class="lnlinks" href="#L1499">1499</a></span><span class="cl">            <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1500"><a class="lnlinks" href="#L1500">1500</a></span><span class="cl">            <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1501"><a class="lnlinks" href="#L1501">1501</a></span><span class="cl">            <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1502"><a class="lnlinks" href="#L1502">1502</a></span><span class="cl">                <span class="nx">client</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">clientId</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1503"><a class="lnlinks" href="#L1503">1503</a></span><span class="cl">                <span class="nx">client</span><span class="nx">_secret</span><span class="o">:</span> <span class="nx">clientSecret</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1504"><a class="lnlinks" href="#L1504">1504</a></span><span class="cl">                <span class="nx">code</span><span class="o">:</span> <span class="nx">code</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1505"><a class="lnlinks" href="#L1505">1505</a></span><span class="cl">                <span class="nx">grant</span><span class="nx">_type</span><span class="o">:</span> <span class="s1">&#39;authorization_code&#39;</span>
</span></span><span class="line"><span class="ln" id="L1506"><a class="lnlinks" href="#L1506">1506</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="L1507"><a class="lnlinks" href="#L1507">1507</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1508"><a class="lnlinks" href="#L1508">1508</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1509"><a class="lnlinks" href="#L1509">1509</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1510"><a class="lnlinks" href="#L1510">1510</a></span><span class="cl">            <span class="kr">const</span> <span class="nx">errorText</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1511"><a class="lnlinks" href="#L1511">1511</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Token exchange failed:&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">errorText</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1512"><a class="lnlinks" href="#L1512">1512</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Failed to exchange token&#39;</span><span class="p">,</span> <span class="nx">details</span><span class="o">:</span> <span class="nx">errorText</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1513"><a class="lnlinks" href="#L1513">1513</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1514"><a class="lnlinks" href="#L1514">1514</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1515"><a class="lnlinks" href="#L1515">1515</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1516"><a class="lnlinks" href="#L1516">1516</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Successfully exchanged code for token&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1517"><a class="lnlinks" href="#L1517">1517</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1518"><a class="lnlinks" href="#L1518">1518</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1519"><a class="lnlinks" href="#L1519">1519</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Token exchange error:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1520"><a class="lnlinks" href="#L1520">1520</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Failed to exchange token&#39;</span><span class="p">,</span> <span class="nx">details</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1521"><a class="lnlinks" href="#L1521">1521</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1522"><a class="lnlinks" href="#L1522">1522</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1523"><a class="lnlinks" href="#L1523">1523</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1524"><a class="lnlinks" href="#L1524">1524</a></span><span class="cl"><span class="c1">// Get Strava Activities with provided access token
</span></span></span><span class="line"><span class="ln" id="L1525"><a class="lnlinks" href="#L1525">1525</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/strava/activities-with-token&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1526"><a class="lnlinks" href="#L1526">1526</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1527"><a class="lnlinks" href="#L1527">1527</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">accessToken</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1528"><a class="lnlinks" href="#L1528">1528</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1529"><a class="lnlinks" href="#L1529">1529</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">accessToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1530"><a class="lnlinks" href="#L1530">1530</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Access token is required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1531"><a class="lnlinks" href="#L1531">1531</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1532"><a class="lnlinks" href="#L1532">1532</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1533"><a class="lnlinks" href="#L1533">1533</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://www.strava.com/api/v3/athlete/activities?per_page=100&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1534"><a class="lnlinks" href="#L1534">1534</a></span><span class="cl">            <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1535"><a class="lnlinks" href="#L1535">1535</a></span><span class="cl">                <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="sb">`</span><span class="sb">Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="ln" id="L1536"><a class="lnlinks" href="#L1536">1536</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1537"><a class="lnlinks" href="#L1537">1537</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1538"><a class="lnlinks" href="#L1538">1538</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1539"><a class="lnlinks" href="#L1539">1539</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1540"><a class="lnlinks" href="#L1540">1540</a></span><span class="cl">            <span class="kr">const</span> <span class="nx">errorText</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1541"><a class="lnlinks" href="#L1541">1541</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Strava API Error:&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">errorText</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1542"><a class="lnlinks" href="#L1542">1542</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="sb">`</span><span class="sb">Strava API error: </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="nx">details</span><span class="o">:</span> <span class="nx">errorText</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1543"><a class="lnlinks" href="#L1543">1543</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1544"><a class="lnlinks" href="#L1544">1544</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1545"><a class="lnlinks" href="#L1545">1545</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">activities</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1546"><a class="lnlinks" href="#L1546">1546</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Fetched </span><span class="si">${</span><span class="nx">activities</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> activities from Strava</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1547"><a class="lnlinks" href="#L1547">1547</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1548"><a class="lnlinks" href="#L1548">1548</a></span><span class="cl">        <span class="c1">// Sync with database
</span></span></span><span class="line"><span class="ln" id="L1549"><a class="lnlinks" href="#L1549">1549</a></span><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1550"><a class="lnlinks" href="#L1550">1550</a></span><span class="cl">            <span class="kr">const</span> <span class="nx">dbCount</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Workout</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1551"><a class="lnlinks" href="#L1551">1551</a></span><span class="cl">            <span class="kr">const</span> <span class="nx">apiCount</span> <span class="o">=</span> <span class="nx">activities</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1552"><a class="lnlinks" href="#L1552">1552</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1553"><a class="lnlinks" href="#L1553">1553</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">DB has </span><span class="si">${</span><span class="nx">dbCount</span><span class="si">}</span><span class="sb"> activities, API returned </span><span class="si">${</span><span class="nx">apiCount</span><span class="si">}</span><span class="sb"> activities</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1554"><a class="lnlinks" href="#L1554">1554</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1555"><a class="lnlinks" href="#L1555">1555</a></span><span class="cl">            <span class="c1">// Always try to sync/insert new activities
</span></span></span><span class="line"><span class="ln" id="L1556"><a class="lnlinks" href="#L1556">1556</a></span><span class="cl"><span class="c1"></span>            <span class="c1">// We&#39;ll filter out ones that already exist by ID to avoid duplicate key errors filling up logs,
</span></span></span><span class="line"><span class="ln" id="L1557"><a class="lnlinks" href="#L1557">1557</a></span><span class="cl"><span class="c1"></span>            <span class="c1">// or just rely on the unique index and ordered: false.
</span></span></span><span class="line"><span class="ln" id="L1558"><a class="lnlinks" href="#L1558">1558</a></span><span class="cl"><span class="c1"></span>            <span class="c1">// Since we want to be robust, let&#39;s just try to insert all and let Mongo handle duplicates.
</span></span></span><span class="line"><span class="ln" id="L1559"><a class="lnlinks" href="#L1559">1559</a></span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln" id="L1560"><a class="lnlinks" href="#L1560">1560</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Attempting to sync </span><span class="si">${</span><span class="nx">apiCount</span><span class="si">}</span><span class="sb"> activities to DB</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1561"><a class="lnlinks" href="#L1561">1561</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1562"><a class="lnlinks" href="#L1562">1562</a></span><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">apiCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1563"><a class="lnlinks" href="#L1563">1563</a></span><span class="cl">                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Sample activity structure:&#39;</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">activities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1564"><a class="lnlinks" href="#L1564">1564</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1565"><a class="lnlinks" href="#L1565">1565</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1566"><a class="lnlinks" href="#L1566">1566</a></span><span class="cl">            <span class="c1">// Prepare activities for insertion
</span></span></span><span class="line"><span class="ln" id="L1567"><a class="lnlinks" href="#L1567">1567</a></span><span class="cl"><span class="c1"></span>            <span class="kr">const</span> <span class="nx">activitiesToInsert</span> <span class="o">=</span> <span class="nx">activities</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">activity</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1568"><a class="lnlinks" href="#L1568">1568</a></span><span class="cl">                <span class="c1">// Ensure required fields are present
</span></span></span><span class="line"><span class="ln" id="L1569"><a class="lnlinks" href="#L1569">1569</a></span><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">activity</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1570"><a class="lnlinks" href="#L1570">1570</a></span><span class="cl">                    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Activity missing ID:&#39;</span><span class="p">,</span> <span class="nx">activity</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1571"><a class="lnlinks" href="#L1571">1571</a></span><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1572"><a class="lnlinks" href="#L1572">1572</a></span><span class="cl">                <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1573"><a class="lnlinks" href="#L1573">1573</a></span><span class="cl">                    <span class="nx">activity</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1574"><a class="lnlinks" href="#L1574">1574</a></span><span class="cl">                    <span class="nx">name</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1575"><a class="lnlinks" href="#L1575">1575</a></span><span class="cl">                    <span class="nx">distance</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">distance</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1576"><a class="lnlinks" href="#L1576">1576</a></span><span class="cl">                    <span class="nx">moving</span><span class="nx">_time</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">moving</span><span class="nx">_time</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1577"><a class="lnlinks" href="#L1577">1577</a></span><span class="cl">                    <span class="nx">elapsed</span><span class="nx">_time</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">elapsed</span><span class="nx">_time</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1578"><a class="lnlinks" href="#L1578">1578</a></span><span class="cl">                    <span class="nx">total</span><span class="nx">_elevation</span><span class="nx">_gain</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">total</span><span class="nx">_elevation</span><span class="nx">_gain</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1579"><a class="lnlinks" href="#L1579">1579</a></span><span class="cl">                    <span class="nx">type</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1580"><a class="lnlinks" href="#L1580">1580</a></span><span class="cl">                    <span class="nx">sport</span><span class="nx">_type</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">sport</span><span class="nx">_type</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1581"><a class="lnlinks" href="#L1581">1581</a></span><span class="cl">                    <span class="nx">start</span><span class="nx">_date</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">activity</span><span class="p">.</span><span class="nx">start</span><span class="nx">_date</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1582"><a class="lnlinks" href="#L1582">1582</a></span><span class="cl">                    <span class="nx">start</span><span class="nx">_date</span><span class="nx">_local</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">activity</span><span class="p">.</span><span class="nx">start</span><span class="nx">_date</span><span class="nx">_local</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1583"><a class="lnlinks" href="#L1583">1583</a></span><span class="cl">                    <span class="nx">average</span><span class="nx">_speed</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">average</span><span class="nx">_speed</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1584"><a class="lnlinks" href="#L1584">1584</a></span><span class="cl">                    <span class="nx">max</span><span class="nx">_speed</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">max</span><span class="nx">_speed</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1585"><a class="lnlinks" href="#L1585">1585</a></span><span class="cl">                    <span class="nx">athlete</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">athlete</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1586"><a class="lnlinks" href="#L1586">1586</a></span><span class="cl">                    <span class="nx">insertedAt</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="L1587"><a class="lnlinks" href="#L1587">1587</a></span><span class="cl">                <span class="p">}</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1588"><a class="lnlinks" href="#L1588">1588</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1589"><a class="lnlinks" href="#L1589">1589</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1590"><a class="lnlinks" href="#L1590">1590</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Prepared </span><span class="si">${</span><span class="nx">activitiesToInsert</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> documents for insertion</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1591"><a class="lnlinks" href="#L1591">1591</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1592"><a class="lnlinks" href="#L1592">1592</a></span><span class="cl">            <span class="c1">// Insert new activities (ignore duplicates)
</span></span></span><span class="line"><span class="ln" id="L1593"><a class="lnlinks" href="#L1593">1593</a></span><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1594"><a class="lnlinks" href="#L1594">1594</a></span><span class="cl">                <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Workout</span><span class="p">.</span><span class="nx">insertMany</span><span class="p">(</span><span class="nx">activitiesToInsert</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ordered</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1595"><a class="lnlinks" href="#L1595">1595</a></span><span class="cl">                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Successfully inserted </span><span class="si">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> activities.</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1596"><a class="lnlinks" href="#L1596">1596</a></span><span class="cl">            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1597"><a class="lnlinks" href="#L1597">1597</a></span><span class="cl">                <span class="c1">// Ignore duplicate key errors (code 11000)
</span></span></span><span class="line"><span class="ln" id="L1598"><a class="lnlinks" href="#L1598">1598</a></span><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="mi">11000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1599"><a class="lnlinks" href="#L1599">1599</a></span><span class="cl">                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Sync complete. Some activities already existed.</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1600"><a class="lnlinks" href="#L1600">1600</a></span><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">insertedDocs</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span><span class="p">.</span><span class="nx">insertedDocs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1601"><a class="lnlinks" href="#L1601">1601</a></span><span class="cl">                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Inserted </span><span class="si">${</span><span class="nx">err</span><span class="p">.</span><span class="nx">insertedDocs</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> new activities (others were duplicates).</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1602"><a class="lnlinks" href="#L1602">1602</a></span><span class="cl">                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1603"><a class="lnlinks" href="#L1603">1603</a></span><span class="cl">                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;No new activities inserted (all were duplicates).&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1604"><a class="lnlinks" href="#L1604">1604</a></span><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1605"><a class="lnlinks" href="#L1605">1605</a></span><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1606"><a class="lnlinks" href="#L1606">1606</a></span><span class="cl">                    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error inserting activities:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1607"><a class="lnlinks" href="#L1607">1607</a></span><span class="cl">                    <span class="c1">// Log validation errors if any
</span></span></span><span class="line"><span class="ln" id="L1608"><a class="lnlinks" href="#L1608">1608</a></span><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;ValidationError&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1609"><a class="lnlinks" href="#L1609">1609</a></span><span class="cl">                        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Validation Errors:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">errors</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1610"><a class="lnlinks" href="#L1610">1610</a></span><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1611"><a class="lnlinks" href="#L1611">1611</a></span><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1612"><a class="lnlinks" href="#L1612">1612</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1613"><a class="lnlinks" href="#L1613">1613</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1614"><a class="lnlinks" href="#L1614">1614</a></span><span class="cl">            <span class="c1">// Verify final count
</span></span></span><span class="line"><span class="ln" id="L1615"><a class="lnlinks" href="#L1615">1615</a></span><span class="cl"><span class="c1"></span>            <span class="kr">const</span> <span class="nx">finalCount</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Workout</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1616"><a class="lnlinks" href="#L1616">1616</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Final DB count: </span><span class="si">${</span><span class="nx">finalCount</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1617"><a class="lnlinks" href="#L1617">1617</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1618"><a class="lnlinks" href="#L1618">1618</a></span><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">dbErr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1619"><a class="lnlinks" href="#L1619">1619</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Database sync error:&#39;</span><span class="p">,</span> <span class="nx">dbErr</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1620"><a class="lnlinks" href="#L1620">1620</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1621"><a class="lnlinks" href="#L1621">1621</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1622"><a class="lnlinks" href="#L1622">1622</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">activities</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1623"><a class="lnlinks" href="#L1623">1623</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1624"><a class="lnlinks" href="#L1624">1624</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Strava API handler error:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1625"><a class="lnlinks" href="#L1625">1625</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Failed to fetch Strava activities&#39;</span><span class="p">,</span> <span class="nx">details</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1626"><a class="lnlinks" href="#L1626">1626</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1627"><a class="lnlinks" href="#L1627">1627</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1628"><a class="lnlinks" href="#L1628">1628</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1629"><a class="lnlinks" href="#L1629">1629</a></span><span class="cl"><span class="c1">// Function to refresh Strava Access Token
</span></span></span><span class="line"><span class="ln" id="L1630"><a class="lnlinks" href="#L1630">1630</a></span><span class="cl"><span class="c1"></span><span class="kr">async</span> <span class="kd">function</span> <span class="nx">refreshStravaToken</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1631"><a class="lnlinks" href="#L1631">1631</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1632"><a class="lnlinks" href="#L1632">1632</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Refreshing Strava Access Token...&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1633"><a class="lnlinks" href="#L1633">1633</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://www.strava.com/oauth/token&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1634"><a class="lnlinks" href="#L1634">1634</a></span><span class="cl">            <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1635"><a class="lnlinks" href="#L1635">1635</a></span><span class="cl">            <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1636"><a class="lnlinks" href="#L1636">1636</a></span><span class="cl">            <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1637"><a class="lnlinks" href="#L1637">1637</a></span><span class="cl">                <span class="nx">client</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STRAVA</span><span class="nx">_CLIENT</span><span class="nx">_ID</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1638"><a class="lnlinks" href="#L1638">1638</a></span><span class="cl">                <span class="nx">client</span><span class="nx">_secret</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STRAVA</span><span class="nx">_CLIENT</span><span class="nx">_SECRET</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1639"><a class="lnlinks" href="#L1639">1639</a></span><span class="cl">                <span class="nx">grant</span><span class="nx">_type</span><span class="o">:</span> <span class="s1">&#39;refresh_token&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1640"><a class="lnlinks" href="#L1640">1640</a></span><span class="cl">                <span class="nx">refresh</span><span class="nx">_token</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STRAVA</span><span class="nx">_REFRESH</span><span class="nx">_TOKEN</span>
</span></span><span class="line"><span class="ln" id="L1641"><a class="lnlinks" href="#L1641">1641</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="L1642"><a class="lnlinks" href="#L1642">1642</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1643"><a class="lnlinks" href="#L1643">1643</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1644"><a class="lnlinks" href="#L1644">1644</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1645"><a class="lnlinks" href="#L1645">1645</a></span><span class="cl">            <span class="kr">const</span> <span class="nx">errorText</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1646"><a class="lnlinks" href="#L1646">1646</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to refresh token response:&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">errorText</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1647"><a class="lnlinks" href="#L1647">1647</a></span><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="sb">`</span><span class="sb">Failed to refresh token: </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1648"><a class="lnlinks" href="#L1648">1648</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1649"><a class="lnlinks" href="#L1649">1649</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1650"><a class="lnlinks" href="#L1650">1650</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1651"><a class="lnlinks" href="#L1651">1651</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Successfully refreshed Strava token&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1652"><a class="lnlinks" href="#L1652">1652</a></span><span class="cl">        <span class="k">return</span> <span class="nx">data</span><span class="p">.</span><span class="nx">access</span><span class="nx">_token</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1653"><a class="lnlinks" href="#L1653">1653</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1654"><a class="lnlinks" href="#L1654">1654</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error refreshing Strava token:&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1655"><a class="lnlinks" href="#L1655">1655</a></span><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1656"><a class="lnlinks" href="#L1656">1656</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1657"><a class="lnlinks" href="#L1657">1657</a></span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1658"><a class="lnlinks" href="#L1658">1658</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1659"><a class="lnlinks" href="#L1659">1659</a></span><span class="cl"><span class="c1">// Get Strava Activities
</span></span></span><span class="line"><span class="ln" id="L1660"><a class="lnlinks" href="#L1660">1660</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/strava/activities&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1661"><a class="lnlinks" href="#L1661">1661</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1662"><a class="lnlinks" href="#L1662">1662</a></span><span class="cl">        <span class="kd">let</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STRAVA</span><span class="nx">_ACCESS</span><span class="nx">_TOKEN</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1663"><a class="lnlinks" href="#L1663">1663</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1664"><a class="lnlinks" href="#L1664">1664</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">accessToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1665"><a class="lnlinks" href="#L1665">1665</a></span><span class="cl">            <span class="c1">// Try refreshing if no access token is set initially
</span></span></span><span class="line"><span class="ln" id="L1666"><a class="lnlinks" href="#L1666">1666</a></span><span class="cl"><span class="c1"></span>            <span class="nx">accessToken</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">refreshStravaToken</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1667"><a class="lnlinks" href="#L1667">1667</a></span><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">accessToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1668"><a class="lnlinks" href="#L1668">1668</a></span><span class="cl">                <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Strava configuration missing&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1669"><a class="lnlinks" href="#L1669">1669</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1670"><a class="lnlinks" href="#L1670">1670</a></span><span class="cl">            <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STRAVA</span><span class="nx">_ACCESS</span><span class="nx">_TOKEN</span> <span class="o">=</span> <span class="nx">accessToken</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1671"><a class="lnlinks" href="#L1671">1671</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1672"><a class="lnlinks" href="#L1672">1672</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1673"><a class="lnlinks" href="#L1673">1673</a></span><span class="cl">        <span class="c1">// Helper to fetch activities
</span></span></span><span class="line"><span class="ln" id="L1674"><a class="lnlinks" href="#L1674">1674</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">fetchActivities</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1675"><a class="lnlinks" href="#L1675">1675</a></span><span class="cl">            <span class="k">return</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://www.strava.com/api/v3/athlete/activities?per_page=30&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1676"><a class="lnlinks" href="#L1676">1676</a></span><span class="cl">                <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1677"><a class="lnlinks" href="#L1677">1677</a></span><span class="cl">                    <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="sb">`</span><span class="sb">Bearer </span><span class="si">${</span><span class="nx">token</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="ln" id="L1678"><a class="lnlinks" href="#L1678">1678</a></span><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1679"><a class="lnlinks" href="#L1679">1679</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1680"><a class="lnlinks" href="#L1680">1680</a></span><span class="cl">        <span class="p">}</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1681"><a class="lnlinks" href="#L1681">1681</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1682"><a class="lnlinks" href="#L1682">1682</a></span><span class="cl">        <span class="kd">let</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetchActivities</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1683"><a class="lnlinks" href="#L1683">1683</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1684"><a class="lnlinks" href="#L1684">1684</a></span><span class="cl">        <span class="c1">// If 401 Unauthorized, try refreshing token
</span></span></span><span class="line"><span class="ln" id="L1685"><a class="lnlinks" href="#L1685">1685</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">401</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1686"><a class="lnlinks" href="#L1686">1686</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Strava token expired (401), attempting refresh...&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1687"><a class="lnlinks" href="#L1687">1687</a></span><span class="cl">            <span class="kr">const</span> <span class="nx">newToken</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">refreshStravaToken</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1688"><a class="lnlinks" href="#L1688">1688</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1689"><a class="lnlinks" href="#L1689">1689</a></span><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">newToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1690"><a class="lnlinks" href="#L1690">1690</a></span><span class="cl">                <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STRAVA</span><span class="nx">_ACCESS</span><span class="nx">_TOKEN</span> <span class="o">=</span> <span class="nx">newToken</span><span class="p">;</span> <span class="c1">// Update in memory
</span></span></span><span class="line"><span class="ln" id="L1691"><a class="lnlinks" href="#L1691">1691</a></span><span class="cl"><span class="c1"></span>                <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetchActivities</span><span class="p">(</span><span class="nx">newToken</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1692"><a class="lnlinks" href="#L1692">1692</a></span><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1693"><a class="lnlinks" href="#L1693">1693</a></span><span class="cl">                <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Failed to refresh Strava token&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1694"><a class="lnlinks" href="#L1694">1694</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1695"><a class="lnlinks" href="#L1695">1695</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1696"><a class="lnlinks" href="#L1696">1696</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1697"><a class="lnlinks" href="#L1697">1697</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1698"><a class="lnlinks" href="#L1698">1698</a></span><span class="cl">            <span class="kr">const</span> <span class="nx">errorText</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1699"><a class="lnlinks" href="#L1699">1699</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Strava API Error:&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">errorText</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1700"><a class="lnlinks" href="#L1700">1700</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="sb">`</span><span class="sb">Strava API error: </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="nx">details</span><span class="o">:</span> <span class="nx">errorText</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1701"><a class="lnlinks" href="#L1701">1701</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1702"><a class="lnlinks" href="#L1702">1702</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1703"><a class="lnlinks" href="#L1703">1703</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">activities</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1704"><a class="lnlinks" href="#L1704">1704</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Fetched </span><span class="si">${</span><span class="nx">activities</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> activities from Strava</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1705"><a class="lnlinks" href="#L1705">1705</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">activities</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1706"><a class="lnlinks" href="#L1706">1706</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1707"><a class="lnlinks" href="#L1707">1707</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Strava API handler error:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1708"><a class="lnlinks" href="#L1708">1708</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Failed to fetch Strava activities&#39;</span><span class="p">,</span> <span class="nx">details</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1709"><a class="lnlinks" href="#L1709">1709</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1710"><a class="lnlinks" href="#L1710">1710</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1711"><a class="lnlinks" href="#L1711">1711</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1712"><a class="lnlinks" href="#L1712">1712</a></span><span class="cl"><span class="c1">// Get stored workouts from Database
</span></span></span><span class="line"><span class="ln" id="L1713"><a class="lnlinks" href="#L1713">1713</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/workouts&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1714"><a class="lnlinks" href="#L1714">1714</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1715"><a class="lnlinks" href="#L1715">1715</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">workouts</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Workout</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="p">{</span> <span class="nx">start</span><span class="nx">_date</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1716"><a class="lnlinks" href="#L1716">1716</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Fetched </span><span class="si">${</span><span class="nx">workouts</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> workouts from DB</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1717"><a class="lnlinks" href="#L1717">1717</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">workouts</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1718"><a class="lnlinks" href="#L1718">1718</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1719"><a class="lnlinks" href="#L1719">1719</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Database fetch error:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1720"><a class="lnlinks" href="#L1720">1720</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Failed to fetch workouts from database&#39;</span><span class="p">,</span> <span class="nx">details</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1721"><a class="lnlinks" href="#L1721">1721</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1722"><a class="lnlinks" href="#L1722">1722</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1723"><a class="lnlinks" href="#L1723">1723</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1724"><a class="lnlinks" href="#L1724">1724</a></span><span class="cl"><span class="c1">// Clean up duplicate workouts (development only)
</span></span></span><span class="line"><span class="ln" id="L1725"><a class="lnlinks" href="#L1725">1725</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/api/workouts/cleanup-duplicates&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1726"><a class="lnlinks" href="#L1726">1726</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1727"><a class="lnlinks" href="#L1727">1727</a></span><span class="cl">        <span class="c1">// Find all duplicates by activity_id
</span></span></span><span class="line"><span class="ln" id="L1728"><a class="lnlinks" href="#L1728">1728</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">duplicates</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Workout</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span><span class="p">[</span>
</span></span><span class="line"><span class="ln" id="L1729"><a class="lnlinks" href="#L1729">1729</a></span><span class="cl">            <span class="p">{</span> <span class="nx">$match</span><span class="o">:</span> <span class="p">{</span> <span class="nx">activity</span><span class="nx">_id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$ne</span><span class="o">:</span> <span class="kc">null</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1730"><a class="lnlinks" href="#L1730">1730</a></span><span class="cl">            <span class="p">{</span> <span class="nx">$group</span><span class="o">:</span> <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;$activity_id&#39;</span><span class="p">,</span> <span class="nx">count</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$sum</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span><span class="p">,</span> <span class="nx">ids</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$push</span><span class="o">:</span> <span class="s1">&#39;$_id&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1731"><a class="lnlinks" href="#L1731">1731</a></span><span class="cl">            <span class="p">{</span> <span class="nx">$match</span><span class="o">:</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$gt</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1732"><a class="lnlinks" href="#L1732">1732</a></span><span class="cl">        <span class="p">]</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1733"><a class="lnlinks" href="#L1733">1733</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1734"><a class="lnlinks" href="#L1734">1734</a></span><span class="cl">        <span class="kd">let</span> <span class="nx">deletedCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1735"><a class="lnlinks" href="#L1735">1735</a></span><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">dup</span> <span class="k">of</span> <span class="nx">duplicates</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1736"><a class="lnlinks" href="#L1736">1736</a></span><span class="cl">            <span class="c1">// Keep the first one, delete the rest
</span></span></span><span class="line"><span class="ln" id="L1737"><a class="lnlinks" href="#L1737">1737</a></span><span class="cl"><span class="c1"></span>            <span class="kr">const</span> <span class="nx">idsToDelete</span> <span class="o">=</span> <span class="nx">dup</span><span class="p">.</span><span class="nx">ids</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1738"><a class="lnlinks" href="#L1738">1738</a></span><span class="cl">            <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Workout</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">(</span><span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="nx">idsToDelete</span> <span class="p">}</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1739"><a class="lnlinks" href="#L1739">1739</a></span><span class="cl">            <span class="nx">deletedCount</span> <span class="o">+=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">deletedCount</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1740"><a class="lnlinks" href="#L1740">1740</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1741"><a class="lnlinks" href="#L1741">1741</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1742"><a class="lnlinks" href="#L1742">1742</a></span><span class="cl">        <span class="c1">// Delete all workouts with null activity_id
</span></span></span><span class="line"><span class="ln" id="L1743"><a class="lnlinks" href="#L1743">1743</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">nullResult</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Workout</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">(</span><span class="p">{</span> <span class="nx">activity</span><span class="nx">_id</span><span class="o">:</span> <span class="kc">null</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1744"><a class="lnlinks" href="#L1744">1744</a></span><span class="cl">        <span class="nx">deletedCount</span> <span class="o">+=</span> <span class="nx">nullResult</span><span class="p">.</span><span class="nx">deletedCount</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1745"><a class="lnlinks" href="#L1745">1745</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1746"><a class="lnlinks" href="#L1746">1746</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">remainingCount</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Workout</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1747"><a class="lnlinks" href="#L1747">1747</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1748"><a class="lnlinks" href="#L1748">1748</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1749"><a class="lnlinks" href="#L1749">1749</a></span><span class="cl">            <span class="nx">success</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1750"><a class="lnlinks" href="#L1750">1750</a></span><span class="cl">            <span class="nx">deletedCount</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1751"><a class="lnlinks" href="#L1751">1751</a></span><span class="cl">            <span class="nx">remainingCount</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1752"><a class="lnlinks" href="#L1752">1752</a></span><span class="cl">            <span class="nx">message</span><span class="o">:</span> <span class="sb">`</span><span class="sb">Cleaned up </span><span class="si">${</span><span class="nx">deletedCount</span><span class="si">}</span><span class="sb"> duplicate/invalid workouts</span><span class="sb">`</span>
</span></span><span class="line"><span class="ln" id="L1753"><a class="lnlinks" href="#L1753">1753</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1754"><a class="lnlinks" href="#L1754">1754</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1755"><a class="lnlinks" href="#L1755">1755</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Cleanup error:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1756"><a class="lnlinks" href="#L1756">1756</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Failed to cleanup duplicates&#39;</span><span class="p">,</span> <span class="nx">details</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1757"><a class="lnlinks" href="#L1757">1757</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1758"><a class="lnlinks" href="#L1758">1758</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1759"><a class="lnlinks" href="#L1759">1759</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1760"><a class="lnlinks" href="#L1760">1760</a></span><span class="cl"><span class="c1">// Sync Strava Activities - Fetch from Strava and insert only new activities
</span></span></span><span class="line"><span class="ln" id="L1761"><a class="lnlinks" href="#L1761">1761</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/workouts/sync&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1762"><a class="lnlinks" href="#L1762">1762</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1763"><a class="lnlinks" href="#L1763">1763</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">accessToken</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1764"><a class="lnlinks" href="#L1764">1764</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1765"><a class="lnlinks" href="#L1765">1765</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">accessToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1766"><a class="lnlinks" href="#L1766">1766</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Access token is required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1767"><a class="lnlinks" href="#L1767">1767</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1768"><a class="lnlinks" href="#L1768">1768</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1769"><a class="lnlinks" href="#L1769">1769</a></span><span class="cl">        <span class="c1">// Fetch activities from Strava
</span></span></span><span class="line"><span class="ln" id="L1770"><a class="lnlinks" href="#L1770">1770</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">stravaResponse</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://www.strava.com/api/v3/athlete/activities?per_page=200&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1771"><a class="lnlinks" href="#L1771">1771</a></span><span class="cl">            <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1772"><a class="lnlinks" href="#L1772">1772</a></span><span class="cl">                <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="sb">`</span><span class="sb">Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="ln" id="L1773"><a class="lnlinks" href="#L1773">1773</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1774"><a class="lnlinks" href="#L1774">1774</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1775"><a class="lnlinks" href="#L1775">1775</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1776"><a class="lnlinks" href="#L1776">1776</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stravaResponse</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1777"><a class="lnlinks" href="#L1777">1777</a></span><span class="cl">            <span class="kr">const</span> <span class="nx">errorText</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">stravaResponse</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1778"><a class="lnlinks" href="#L1778">1778</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Strava API Error:&#39;</span><span class="p">,</span> <span class="nx">stravaResponse</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">errorText</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1779"><a class="lnlinks" href="#L1779">1779</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">stravaResponse</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="sb">`</span><span class="sb">Strava API error: </span><span class="si">${</span><span class="nx">stravaResponse</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="nx">details</span><span class="o">:</span> <span class="nx">errorText</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1780"><a class="lnlinks" href="#L1780">1780</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1781"><a class="lnlinks" href="#L1781">1781</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1782"><a class="lnlinks" href="#L1782">1782</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">stravaActivities</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">stravaResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1783"><a class="lnlinks" href="#L1783">1783</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Fetched </span><span class="si">${</span><span class="nx">stravaActivities</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> activities from Strava</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1784"><a class="lnlinks" href="#L1784">1784</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1785"><a class="lnlinks" href="#L1785">1785</a></span><span class="cl">        <span class="c1">// Get current count in DB
</span></span></span><span class="line"><span class="ln" id="L1786"><a class="lnlinks" href="#L1786">1786</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">dbCount</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Workout</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1787"><a class="lnlinks" href="#L1787">1787</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Current DB count: </span><span class="si">${</span><span class="nx">dbCount</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1788"><a class="lnlinks" href="#L1788">1788</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1789"><a class="lnlinks" href="#L1789">1789</a></span><span class="cl">        <span class="c1">// Get existing activity IDs from DB
</span></span></span><span class="line"><span class="ln" id="L1790"><a class="lnlinks" href="#L1790">1790</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">existingActivities</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Workout</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="p">{</span><span class="p">}</span><span class="p">,</span> <span class="p">{</span> <span class="nx">activity</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1791"><a class="lnlinks" href="#L1791">1791</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">existingIds</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">(</span><span class="nx">existingActivities</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">a</span> <span class="p">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">activity</span><span class="nx">_id</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1792"><a class="lnlinks" href="#L1792">1792</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1793"><a class="lnlinks" href="#L1793">1793</a></span><span class="cl">        <span class="c1">// Filter out activities that already exist
</span></span></span><span class="line"><span class="ln" id="L1794"><a class="lnlinks" href="#L1794">1794</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">newActivities</span> <span class="o">=</span> <span class="nx">stravaActivities</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">activity</span> <span class="p">=&gt;</span> <span class="o">!</span><span class="nx">existingIds</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">activity</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1795"><a class="lnlinks" href="#L1795">1795</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Found </span><span class="si">${</span><span class="nx">newActivities</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> new activities to insert</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1796"><a class="lnlinks" href="#L1796">1796</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1797"><a class="lnlinks" href="#L1797">1797</a></span><span class="cl">        <span class="c1">// Insert new activities
</span></span></span><span class="line"><span class="ln" id="L1798"><a class="lnlinks" href="#L1798">1798</a></span><span class="cl"><span class="c1"></span>        <span class="kd">let</span> <span class="nx">insertedCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1799"><a class="lnlinks" href="#L1799">1799</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">newActivities</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1800"><a class="lnlinks" href="#L1800">1800</a></span><span class="cl">            <span class="kr">const</span> <span class="nx">workoutsToInsert</span> <span class="o">=</span> <span class="nx">newActivities</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">activity</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1801"><a class="lnlinks" href="#L1801">1801</a></span><span class="cl">                <span class="nx">activity</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1802"><a class="lnlinks" href="#L1802">1802</a></span><span class="cl">                <span class="nx">name</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1803"><a class="lnlinks" href="#L1803">1803</a></span><span class="cl">                <span class="nx">distance</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">distance</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1804"><a class="lnlinks" href="#L1804">1804</a></span><span class="cl">                <span class="nx">moving</span><span class="nx">_time</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">moving</span><span class="nx">_time</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1805"><a class="lnlinks" href="#L1805">1805</a></span><span class="cl">                <span class="nx">elapsed</span><span class="nx">_time</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">elapsed</span><span class="nx">_time</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1806"><a class="lnlinks" href="#L1806">1806</a></span><span class="cl">                <span class="nx">total</span><span class="nx">_elevation</span><span class="nx">_gain</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">total</span><span class="nx">_elevation</span><span class="nx">_gain</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1807"><a class="lnlinks" href="#L1807">1807</a></span><span class="cl">                <span class="nx">type</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1808"><a class="lnlinks" href="#L1808">1808</a></span><span class="cl">                <span class="nx">sport</span><span class="nx">_type</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">sport</span><span class="nx">_type</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1809"><a class="lnlinks" href="#L1809">1809</a></span><span class="cl">                <span class="nx">start</span><span class="nx">_date</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">start</span><span class="nx">_date</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1810"><a class="lnlinks" href="#L1810">1810</a></span><span class="cl">                <span class="nx">start</span><span class="nx">_date</span><span class="nx">_local</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">start</span><span class="nx">_date</span><span class="nx">_local</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1811"><a class="lnlinks" href="#L1811">1811</a></span><span class="cl">                <span class="nx">average</span><span class="nx">_speed</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">average</span><span class="nx">_speed</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1812"><a class="lnlinks" href="#L1812">1812</a></span><span class="cl">                <span class="nx">max</span><span class="nx">_speed</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">max</span><span class="nx">_speed</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1813"><a class="lnlinks" href="#L1813">1813</a></span><span class="cl">                <span class="nx">athlete</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">athlete</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span>
</span></span><span class="line"><span class="ln" id="L1814"><a class="lnlinks" href="#L1814">1814</a></span><span class="cl">            <span class="p">}</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1815"><a class="lnlinks" href="#L1815">1815</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1816"><a class="lnlinks" href="#L1816">1816</a></span><span class="cl">            <span class="kr">const</span> <span class="nx">insertResult</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Workout</span><span class="p">.</span><span class="nx">insertMany</span><span class="p">(</span><span class="nx">workoutsToInsert</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ordered</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1817"><a class="lnlinks" href="#L1817">1817</a></span><span class="cl">            <span class="nx">insertedCount</span> <span class="o">=</span> <span class="nx">insertResult</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1818"><a class="lnlinks" href="#L1818">1818</a></span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Successfully inserted </span><span class="si">${</span><span class="nx">insertedCount</span><span class="si">}</span><span class="sb"> new activities</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1819"><a class="lnlinks" href="#L1819">1819</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1820"><a class="lnlinks" href="#L1820">1820</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1821"><a class="lnlinks" href="#L1821">1821</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">newDbCount</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Workout</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1822"><a class="lnlinks" href="#L1822">1822</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1823"><a class="lnlinks" href="#L1823">1823</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1824"><a class="lnlinks" href="#L1824">1824</a></span><span class="cl">            <span class="nx">success</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1825"><a class="lnlinks" href="#L1825">1825</a></span><span class="cl">            <span class="nx">stravaCount</span><span class="o">:</span> <span class="nx">stravaActivities</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1826"><a class="lnlinks" href="#L1826">1826</a></span><span class="cl">            <span class="nx">previousDbCount</span><span class="o">:</span> <span class="nx">dbCount</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1827"><a class="lnlinks" href="#L1827">1827</a></span><span class="cl">            <span class="nx">newDbCount</span><span class="o">:</span> <span class="nx">newDbCount</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1828"><a class="lnlinks" href="#L1828">1828</a></span><span class="cl">            <span class="nx">inserted</span><span class="o">:</span> <span class="nx">insertedCount</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1829"><a class="lnlinks" href="#L1829">1829</a></span><span class="cl">            <span class="nx">message</span><span class="o">:</span> <span class="sb">`</span><span class="sb">Synced </span><span class="si">${</span><span class="nx">insertedCount</span><span class="si">}</span><span class="sb"> new activities</span><span class="sb">`</span>
</span></span><span class="line"><span class="ln" id="L1830"><a class="lnlinks" href="#L1830">1830</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1831"><a class="lnlinks" href="#L1831">1831</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1832"><a class="lnlinks" href="#L1832">1832</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Sync error:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1833"><a class="lnlinks" href="#L1833">1833</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Failed to sync activities&#39;</span><span class="p">,</span> <span class="nx">details</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1834"><a class="lnlinks" href="#L1834">1834</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1835"><a class="lnlinks" href="#L1835">1835</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1836"><a class="lnlinks" href="#L1836">1836</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1837"><a class="lnlinks" href="#L1837">1837</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1838"><a class="lnlinks" href="#L1838">1838</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1839"><a class="lnlinks" href="#L1839">1839</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1840"><a class="lnlinks" href="#L1840">1840</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1841"><a class="lnlinks" href="#L1841">1841</a></span><span class="cl"><span class="c1">// Member Schema
</span></span></span><span class="line"><span class="ln" id="L1842"><a class="lnlinks" href="#L1842">1842</a></span><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">memberSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1843"><a class="lnlinks" href="#L1843">1843</a></span><span class="cl">    <span class="nx">email</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">unique</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1844"><a class="lnlinks" href="#L1844">1844</a></span><span class="cl">    <span class="nx">role</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span><span class="p">,</span> <span class="c1">// ADMIN, EDITOR, etc.
</span></span></span><span class="line"><span class="ln" id="L1845"><a class="lnlinks" href="#L1845">1845</a></span><span class="cl"><span class="c1"></span>    <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1846"><a class="lnlinks" href="#L1846">1846</a></span><span class="cl">    <span class="nx">createdAt</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1847"><a class="lnlinks" href="#L1847">1847</a></span><span class="cl"><span class="p">}</span><span class="p">,</span> <span class="p">{</span> <span class="nx">collection</span><span class="o">:</span> <span class="s1">&#39;MEMBER&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1848"><a class="lnlinks" href="#L1848">1848</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1849"><a class="lnlinks" href="#L1849">1849</a></span><span class="cl"><span class="kr">const</span> <span class="nx">Member</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Member&#39;</span><span class="p">,</span> <span class="nx">memberSchema</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1850"><a class="lnlinks" href="#L1850">1850</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1851"><a class="lnlinks" href="#L1851">1851</a></span><span class="cl"><span class="c1">// Get Contact Info
</span></span></span><span class="line"><span class="ln" id="L1852"><a class="lnlinks" href="#L1852">1852</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/contact&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1853"><a class="lnlinks" href="#L1853">1853</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1854"><a class="lnlinks" href="#L1854">1854</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">contact</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Contact</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1855"><a class="lnlinks" href="#L1855">1855</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">contact</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1856"><a class="lnlinks" href="#L1856">1856</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1857"><a class="lnlinks" href="#L1857">1857</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch contact:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1858"><a class="lnlinks" href="#L1858">1858</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1859"><a class="lnlinks" href="#L1859">1859</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1860"><a class="lnlinks" href="#L1860">1860</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1861"><a class="lnlinks" href="#L1861">1861</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1862"><a class="lnlinks" href="#L1862">1862</a></span><span class="cl"><span class="c1">// Update Contact Info
</span></span></span><span class="line"><span class="ln" id="L1863"><a class="lnlinks" href="#L1863">1863</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;/api/contact/:id&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1864"><a class="lnlinks" href="#L1864">1864</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1865"><a class="lnlinks" href="#L1865">1865</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1866"><a class="lnlinks" href="#L1866">1866</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">Email</span><span class="p">,</span> <span class="nx">GitHub</span><span class="p">,</span> <span class="nx">LinkedIn</span><span class="p">,</span> <span class="nx">Location</span><span class="p">,</span> <span class="nx">userEmail</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1867"><a class="lnlinks" href="#L1867">1867</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1868"><a class="lnlinks" href="#L1868">1868</a></span><span class="cl">        <span class="c1">// Check authorization
</span></span></span><span class="line"><span class="ln" id="L1869"><a class="lnlinks" href="#L1869">1869</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1870"><a class="lnlinks" href="#L1870">1870</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1871"><a class="lnlinks" href="#L1871">1871</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1872"><a class="lnlinks" href="#L1872">1872</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1873"><a class="lnlinks" href="#L1873">1873</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1874"><a class="lnlinks" href="#L1874">1874</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">contact</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Contact</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1875"><a class="lnlinks" href="#L1875">1875</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">contact</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1876"><a class="lnlinks" href="#L1876">1876</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Contact not found&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1877"><a class="lnlinks" href="#L1877">1877</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1878"><a class="lnlinks" href="#L1878">1878</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1879"><a class="lnlinks" href="#L1879">1879</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">Email</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">contact</span><span class="p">.</span><span class="nx">Email</span> <span class="o">=</span> <span class="nx">Email</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1880"><a class="lnlinks" href="#L1880">1880</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">GitHub</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">contact</span><span class="p">.</span><span class="nx">GitHub</span> <span class="o">=</span> <span class="nx">GitHub</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1881"><a class="lnlinks" href="#L1881">1881</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">LinkedIn</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">contact</span><span class="p">.</span><span class="nx">LinkedIn</span> <span class="o">=</span> <span class="nx">LinkedIn</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1882"><a class="lnlinks" href="#L1882">1882</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1883"><a class="lnlinks" href="#L1883">1883</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">Location</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1884"><a class="lnlinks" href="#L1884">1884</a></span><span class="cl">            <span class="c1">// Check if location fields are empty (use IP geolocation)
</span></span></span><span class="line"><span class="ln" id="L1885"><a class="lnlinks" href="#L1885">1885</a></span><span class="cl"><span class="c1"></span>            <span class="kr">const</span> <span class="nx">hasLocationData</span> <span class="o">=</span> <span class="nx">Location</span><span class="p">.</span><span class="nx">city</span> <span class="o">&amp;&amp;</span> <span class="nx">Location</span><span class="p">.</span><span class="nx">state</span> <span class="o">&amp;&amp;</span> <span class="nx">Location</span><span class="p">.</span><span class="nx">country</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1886"><a class="lnlinks" href="#L1886">1886</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1887"><a class="lnlinks" href="#L1887">1887</a></span><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasLocationData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1888"><a class="lnlinks" href="#L1888">1888</a></span><span class="cl">                <span class="c1">// Get user&#39;s IP address
</span></span></span><span class="line"><span class="ln" id="L1889"><a class="lnlinks" href="#L1889">1889</a></span><span class="cl"><span class="c1"></span>                <span class="kd">let</span> <span class="nx">userIp</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;x-forwarded-for&#39;</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="ln" id="L1890"><a class="lnlinks" href="#L1890">1890</a></span><span class="cl">                    <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;x-real-ip&#39;</span><span class="p">]</span> <span class="o">||</span>
</span></span><span class="line"><span class="ln" id="L1891"><a class="lnlinks" href="#L1891">1891</a></span><span class="cl">                    <span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">remoteAddress</span> <span class="o">||</span>
</span></span><span class="line"><span class="ln" id="L1892"><a class="lnlinks" href="#L1892">1892</a></span><span class="cl">                    <span class="nx">req</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">remoteAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1893"><a class="lnlinks" href="#L1893">1893</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1894"><a class="lnlinks" href="#L1894">1894</a></span><span class="cl">                <span class="c1">// Clean up IPv6 localhost format
</span></span></span><span class="line"><span class="ln" id="L1895"><a class="lnlinks" href="#L1895">1895</a></span><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nx">userIp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">userIp</span> <span class="o">===</span> <span class="s1">&#39;::1&#39;</span> <span class="o">||</span> <span class="nx">userIp</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">userIp</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;::ffff:&#39;</span><span class="p">)</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1896"><a class="lnlinks" href="#L1896">1896</a></span><span class="cl">                    <span class="c1">// For localhost/development, use a default IP for testing
</span></span></span><span class="line"><span class="ln" id="L1897"><a class="lnlinks" href="#L1897">1897</a></span><span class="cl"><span class="c1"></span>                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Localhost detected, using public IP for geolocation test&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1898"><a class="lnlinks" href="#L1898">1898</a></span><span class="cl">                    <span class="nx">userIp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="c1">// Leave empty to let ip-api.com use the server&#39;s IP
</span></span></span><span class="line"><span class="ln" id="L1899"><a class="lnlinks" href="#L1899">1899</a></span><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1900"><a class="lnlinks" href="#L1900">1900</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1901"><a class="lnlinks" href="#L1901">1901</a></span><span class="cl">                <span class="c1">// Try to get coordinates from IP geolocation API
</span></span></span><span class="line"><span class="ln" id="L1902"><a class="lnlinks" href="#L1902">1902</a></span><span class="cl"><span class="c1"></span>                <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1903"><a class="lnlinks" href="#L1903">1903</a></span><span class="cl">                    <span class="kr">const</span> <span class="nx">ipUrl</span> <span class="o">=</span> <span class="nx">userIp</span> <span class="o">?</span> <span class="sb">`</span><span class="sb">http://ip-api.com/json/</span><span class="si">${</span><span class="nx">userIp</span><span class="si">}</span><span class="sb">?fields=status,message,city,regionName,country,lat,lon,query,timezone</span><span class="sb">`</span> <span class="o">:</span> <span class="s1">&#39;http://ip-api.com/json/?fields=status,message,city,regionName,country,lat,lon,query,timezone&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1904"><a class="lnlinks" href="#L1904">1904</a></span><span class="cl">                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Fetching IP geolocation from:&#39;</span><span class="p">,</span> <span class="nx">ipUrl</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1905"><a class="lnlinks" href="#L1905">1905</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1906"><a class="lnlinks" href="#L1906">1906</a></span><span class="cl">                    <span class="kr">const</span> <span class="nx">ipResponse</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">ipUrl</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1907"><a class="lnlinks" href="#L1907">1907</a></span><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">ipResponse</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1908"><a class="lnlinks" href="#L1908">1908</a></span><span class="cl">                        <span class="kr">const</span> <span class="nx">ipData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">ipResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1909"><a class="lnlinks" href="#L1909">1909</a></span><span class="cl">                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;IP Geolocation response:&#39;</span><span class="p">,</span> <span class="nx">ipData</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1910"><a class="lnlinks" href="#L1910">1910</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1911"><a class="lnlinks" href="#L1911">1911</a></span><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="nx">ipData</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1912"><a class="lnlinks" href="#L1912">1912</a></span><span class="cl">                            <span class="nx">Location</span><span class="p">.</span><span class="nx">latitude</span> <span class="o">=</span> <span class="nx">ipData</span><span class="p">.</span><span class="nx">lat</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1913"><a class="lnlinks" href="#L1913">1913</a></span><span class="cl">                            <span class="nx">Location</span><span class="p">.</span><span class="nx">longitude</span> <span class="o">=</span> <span class="nx">ipData</span><span class="p">.</span><span class="nx">lon</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1914"><a class="lnlinks" href="#L1914">1914</a></span><span class="cl">                            <span class="nx">Location</span><span class="p">.</span><span class="nx">ip</span> <span class="o">=</span> <span class="nx">ipData</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span> <span class="c1">// Actual IP from response
</span></span></span><span class="line"><span class="ln" id="L1915"><a class="lnlinks" href="#L1915">1915</a></span><span class="cl"><span class="c1"></span>                            <span class="c1">// Use IP data for location
</span></span></span><span class="line"><span class="ln" id="L1916"><a class="lnlinks" href="#L1916">1916</a></span><span class="cl"><span class="c1"></span>                            <span class="nx">Location</span><span class="p">.</span><span class="nx">city</span> <span class="o">=</span> <span class="nx">ipData</span><span class="p">.</span><span class="nx">city</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1917"><a class="lnlinks" href="#L1917">1917</a></span><span class="cl">                            <span class="nx">Location</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">ipData</span><span class="p">.</span><span class="nx">regionName</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1918"><a class="lnlinks" href="#L1918">1918</a></span><span class="cl">                            <span class="nx">Location</span><span class="p">.</span><span class="nx">country</span> <span class="o">=</span> <span class="nx">ipData</span><span class="p">.</span><span class="nx">country</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1919"><a class="lnlinks" href="#L1919">1919</a></span><span class="cl">                            <span class="nx">Location</span><span class="p">.</span><span class="nx">timezone</span> <span class="o">=</span> <span class="nx">ipData</span><span class="p">.</span><span class="nx">timezone</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1920"><a class="lnlinks" href="#L1920">1920</a></span><span class="cl">                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;IP geolocation successful:&#39;</span><span class="p">,</span> <span class="nx">Location</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1921"><a class="lnlinks" href="#L1921">1921</a></span><span class="cl">                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1922"><a class="lnlinks" href="#L1922">1922</a></span><span class="cl">                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;IP geolocation failed:&#39;</span><span class="p">,</span> <span class="nx">ipData</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1923"><a class="lnlinks" href="#L1923">1923</a></span><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1924"><a class="lnlinks" href="#L1924">1924</a></span><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1925"><a class="lnlinks" href="#L1925">1925</a></span><span class="cl">                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">ipErr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1926"><a class="lnlinks" href="#L1926">1926</a></span><span class="cl">                    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to get IP geolocation:&#39;</span><span class="p">,</span> <span class="nx">ipErr</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1927"><a class="lnlinks" href="#L1927">1927</a></span><span class="cl">                    <span class="c1">// Continue without coordinates if IP lookup fails
</span></span></span><span class="line"><span class="ln" id="L1928"><a class="lnlinks" href="#L1928">1928</a></span><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1929"><a class="lnlinks" href="#L1929">1929</a></span><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Location</span><span class="p">.</span><span class="nx">latitude</span> <span class="o">||</span> <span class="o">!</span><span class="nx">Location</span><span class="p">.</span><span class="nx">longitude</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1930"><a class="lnlinks" href="#L1930">1930</a></span><span class="cl">                <span class="c1">// Has city/state/country but no coordinates - use geocoding
</span></span></span><span class="line"><span class="ln" id="L1931"><a class="lnlinks" href="#L1931">1931</a></span><span class="cl"><span class="c1"></span>                <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1932"><a class="lnlinks" href="#L1932">1932</a></span><span class="cl">                    <span class="kr">const</span> <span class="nx">address</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">Location</span><span class="p">.</span><span class="nx">city</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">Location</span><span class="p">.</span><span class="nx">state</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">Location</span><span class="p">.</span><span class="nx">country</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1933"><a class="lnlinks" href="#L1933">1933</a></span><span class="cl">                    <span class="kr">const</span> <span class="nx">geocodeUrl</span> <span class="o">=</span> <span class="sb">`</span><span class="sb">https://nominatim.openstreetmap.org/search?format=json&amp;q=</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">address</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1934"><a class="lnlinks" href="#L1934">1934</a></span><span class="cl">                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Geocoding address:&#39;</span><span class="p">,</span> <span class="nx">address</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1935"><a class="lnlinks" href="#L1935">1935</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1936"><a class="lnlinks" href="#L1936">1936</a></span><span class="cl">                    <span class="kr">const</span> <span class="nx">geocodeResponse</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">geocodeUrl</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1937"><a class="lnlinks" href="#L1937">1937</a></span><span class="cl">                        <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1938"><a class="lnlinks" href="#L1938">1938</a></span><span class="cl">                            <span class="s1">&#39;User-Agent&#39;</span><span class="o">:</span> <span class="s1">&#39;PersonalWebsite/1.0&#39;</span>
</span></span><span class="line"><span class="ln" id="L1939"><a class="lnlinks" href="#L1939">1939</a></span><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1940"><a class="lnlinks" href="#L1940">1940</a></span><span class="cl">                    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1941"><a class="lnlinks" href="#L1941">1941</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1942"><a class="lnlinks" href="#L1942">1942</a></span><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">geocodeResponse</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1943"><a class="lnlinks" href="#L1943">1943</a></span><span class="cl">                        <span class="kr">const</span> <span class="nx">geocodeData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">geocodeResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1944"><a class="lnlinks" href="#L1944">1944</a></span><span class="cl">                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Geocoding response:&#39;</span><span class="p">,</span> <span class="nx">geocodeData</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1945"><a class="lnlinks" href="#L1945">1945</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1946"><a class="lnlinks" href="#L1946">1946</a></span><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="nx">geocodeData</span> <span class="o">&amp;&amp;</span> <span class="nx">geocodeData</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1947"><a class="lnlinks" href="#L1947">1947</a></span><span class="cl">                            <span class="nx">Location</span><span class="p">.</span><span class="nx">latitude</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">geocodeData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">.</span><span class="nx">lat</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1948"><a class="lnlinks" href="#L1948">1948</a></span><span class="cl">                            <span class="nx">Location</span><span class="p">.</span><span class="nx">longitude</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">geocodeData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">.</span><span class="nx">lon</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1949"><a class="lnlinks" href="#L1949">1949</a></span><span class="cl">                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Geocoding successful:&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">latitude</span><span class="o">:</span> <span class="nx">Location</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">longitude</span><span class="o">:</span> <span class="nx">Location</span><span class="p">.</span><span class="nx">longitude</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1950"><a class="lnlinks" href="#L1950">1950</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1951"><a class="lnlinks" href="#L1951">1951</a></span><span class="cl">                            <span class="c1">// Fetch timezone for coordinates
</span></span></span><span class="line"><span class="ln" id="L1952"><a class="lnlinks" href="#L1952">1952</a></span><span class="cl"><span class="c1"></span>                            <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1953"><a class="lnlinks" href="#L1953">1953</a></span><span class="cl">                                <span class="kr">const</span> <span class="nx">tzResponse</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="sb">https://timeapi.io/api/TimeZone/coordinate?latitude=</span><span class="si">${</span><span class="nx">Location</span><span class="p">.</span><span class="nx">latitude</span><span class="si">}</span><span class="sb">&amp;longitude=</span><span class="si">${</span><span class="nx">Location</span><span class="p">.</span><span class="nx">longitude</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1954"><a class="lnlinks" href="#L1954">1954</a></span><span class="cl">                                <span class="k">if</span> <span class="p">(</span><span class="nx">tzResponse</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1955"><a class="lnlinks" href="#L1955">1955</a></span><span class="cl">                                    <span class="kr">const</span> <span class="nx">tzData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">tzResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1956"><a class="lnlinks" href="#L1956">1956</a></span><span class="cl">                                    <span class="nx">Location</span><span class="p">.</span><span class="nx">timezone</span> <span class="o">=</span> <span class="nx">tzData</span><span class="p">.</span><span class="nx">timeZone</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1957"><a class="lnlinks" href="#L1957">1957</a></span><span class="cl">                                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Timezone fetch successful:&#39;</span><span class="p">,</span> <span class="nx">Location</span><span class="p">.</span><span class="nx">timezone</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1958"><a class="lnlinks" href="#L1958">1958</a></span><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1959"><a class="lnlinks" href="#L1959">1959</a></span><span class="cl">                            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">tzErr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1960"><a class="lnlinks" href="#L1960">1960</a></span><span class="cl">                                <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch timezone:&#39;</span><span class="p">,</span> <span class="nx">tzErr</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1961"><a class="lnlinks" href="#L1961">1961</a></span><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1962"><a class="lnlinks" href="#L1962">1962</a></span><span class="cl">                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1963"><a class="lnlinks" href="#L1963">1963</a></span><span class="cl">                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;No geocoding results found for address:&#39;</span><span class="p">,</span> <span class="nx">address</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1964"><a class="lnlinks" href="#L1964">1964</a></span><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1965"><a class="lnlinks" href="#L1965">1965</a></span><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1966"><a class="lnlinks" href="#L1966">1966</a></span><span class="cl">                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">geocodeErr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1967"><a class="lnlinks" href="#L1967">1967</a></span><span class="cl">                    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to geocode address:&#39;</span><span class="p">,</span> <span class="nx">geocodeErr</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1968"><a class="lnlinks" href="#L1968">1968</a></span><span class="cl">                    <span class="c1">// Continue without coordinates if geocoding fails
</span></span></span><span class="line"><span class="ln" id="L1969"><a class="lnlinks" href="#L1969">1969</a></span><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1970"><a class="lnlinks" href="#L1970">1970</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1971"><a class="lnlinks" href="#L1971">1971</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1972"><a class="lnlinks" href="#L1972">1972</a></span><span class="cl">            <span class="nx">contact</span><span class="p">.</span><span class="nx">Location</span> <span class="o">=</span> <span class="nx">Location</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1973"><a class="lnlinks" href="#L1973">1973</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1974"><a class="lnlinks" href="#L1974">1974</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1975"><a class="lnlinks" href="#L1975">1975</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">contact</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1976"><a class="lnlinks" href="#L1976">1976</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">contact</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1977"><a class="lnlinks" href="#L1977">1977</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1978"><a class="lnlinks" href="#L1978">1978</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to update contact:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1979"><a class="lnlinks" href="#L1979">1979</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1980"><a class="lnlinks" href="#L1980">1980</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1981"><a class="lnlinks" href="#L1981">1981</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1982"><a class="lnlinks" href="#L1982">1982</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1983"><a class="lnlinks" href="#L1983">1983</a></span><span class="cl"><span class="c1">// Check Member Role by Email
</span></span></span><span class="line"><span class="ln" id="L1984"><a class="lnlinks" href="#L1984">1984</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/member/role/:email&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1985"><a class="lnlinks" href="#L1985">1985</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1986"><a class="lnlinks" href="#L1986">1986</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1987"><a class="lnlinks" href="#L1987">1987</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">member</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Member</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="p">{</span> <span class="nx">email</span><span class="o">:</span> <span class="nx">email</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1988"><a class="lnlinks" href="#L1988">1988</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1989"><a class="lnlinks" href="#L1989">1989</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">member</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1990"><a class="lnlinks" href="#L1990">1990</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">authorized</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span> <span class="kc">null</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1991"><a class="lnlinks" href="#L1991">1991</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L1992"><a class="lnlinks" href="#L1992">1992</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L1993"><a class="lnlinks" href="#L1993">1993</a></span><span class="cl">        <span class="c1">// Check if role is ADMIN or EDITOR
</span></span></span><span class="line"><span class="ln" id="L1994"><a class="lnlinks" href="#L1994">1994</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">isAuthorized</span> <span class="o">=</span> <span class="nx">member</span><span class="p">.</span><span class="nx">role</span> <span class="o">===</span> <span class="s1">&#39;ADMIN&#39;</span> <span class="o">||</span> <span class="nx">member</span><span class="p">.</span><span class="nx">role</span> <span class="o">===</span> <span class="s1">&#39;EDITOR&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L1995"><a class="lnlinks" href="#L1995">1995</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L1996"><a class="lnlinks" href="#L1996">1996</a></span><span class="cl">            <span class="nx">authorized</span><span class="o">:</span> <span class="nx">isAuthorized</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1997"><a class="lnlinks" href="#L1997">1997</a></span><span class="cl">            <span class="nx">role</span><span class="o">:</span> <span class="nx">member</span><span class="p">.</span><span class="nx">role</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L1998"><a class="lnlinks" href="#L1998">1998</a></span><span class="cl">            <span class="nx">email</span><span class="o">:</span> <span class="nx">member</span><span class="p">.</span><span class="nx">email</span>
</span></span><span class="line"><span class="ln" id="L1999"><a class="lnlinks" href="#L1999">1999</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2000"><a class="lnlinks" href="#L2000">2000</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2001"><a class="lnlinks" href="#L2001">2001</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to check member role:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2002"><a class="lnlinks" href="#L2002">2002</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2003"><a class="lnlinks" href="#L2003">2003</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2004"><a class="lnlinks" href="#L2004">2004</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2005"><a class="lnlinks" href="#L2005">2005</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2006"><a class="lnlinks" href="#L2006">2006</a></span><span class="cl"><span class="kr">const</span> <span class="nx">timeZone</span> <span class="o">=</span> <span class="s1">&#39;America/Chicago&#39;</span><span class="p">;</span> <span class="c1">// US Central Time
</span></span></span><span class="line"><span class="ln" id="L2007"><a class="lnlinks" href="#L2007">2007</a></span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln" id="L2008"><a class="lnlinks" href="#L2008">2008</a></span><span class="cl"><span class="c1">// ... (rest of the file)
</span></span></span><span class="line"><span class="ln" id="L2009"><a class="lnlinks" href="#L2009">2009</a></span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln" id="L2010"><a class="lnlinks" href="#L2010">2010</a></span><span class="cl"><span class="c1">// --- TODO List Endpoints ---
</span></span></span><span class="line"><span class="ln" id="L2011"><a class="lnlinks" href="#L2011">2011</a></span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln" id="L2012"><a class="lnlinks" href="#L2012">2012</a></span><span class="cl"><span class="c1">// Get all TODO items
</span></span></span><span class="line"><span class="ln" id="L2013"><a class="lnlinks" href="#L2013">2013</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/todos&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2014"><a class="lnlinks" href="#L2014">2014</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2015"><a class="lnlinks" href="#L2015">2015</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">category</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2016"><a class="lnlinks" href="#L2016">2016</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">matchStage</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">show</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span> <span class="p">}</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2017"><a class="lnlinks" href="#L2017">2017</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">category</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2018"><a class="lnlinks" href="#L2018">2018</a></span><span class="cl">            <span class="nx">matchStage</span><span class="p">.</span><span class="nx">category</span> <span class="o">=</span> <span class="nx">category</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2019"><a class="lnlinks" href="#L2019">2019</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2020"><a class="lnlinks" href="#L2020">2020</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2021"><a class="lnlinks" href="#L2021">2021</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">todos</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">TodoList</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span><span class="p">[</span>
</span></span><span class="line"><span class="ln" id="L2022"><a class="lnlinks" href="#L2022">2022</a></span><span class="cl">            <span class="p">{</span> <span class="nx">$match</span><span class="o">:</span> <span class="nx">matchStage</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2023"><a class="lnlinks" href="#L2023">2023</a></span><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2024"><a class="lnlinks" href="#L2024">2024</a></span><span class="cl">                <span class="nx">$addFields</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2025"><a class="lnlinks" href="#L2025">2025</a></span><span class="cl">                    <span class="nx">priorityWeight</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2026"><a class="lnlinks" href="#L2026">2026</a></span><span class="cl">                        <span class="nx">$switch</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2027"><a class="lnlinks" href="#L2027">2027</a></span><span class="cl">                            <span class="nx">branches</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln" id="L2028"><a class="lnlinks" href="#L2028">2028</a></span><span class="cl">                                <span class="p">{</span> <span class="k">case</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$eq</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;$priority&#34;</span><span class="p">,</span> <span class="s2">&#34;high&#34;</span><span class="p">]</span> <span class="p">}</span><span class="p">,</span> <span class="nx">then</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2029"><a class="lnlinks" href="#L2029">2029</a></span><span class="cl">                                <span class="p">{</span> <span class="k">case</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$eq</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;$priority&#34;</span><span class="p">,</span> <span class="s2">&#34;medium&#34;</span><span class="p">]</span> <span class="p">}</span><span class="p">,</span> <span class="nx">then</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2030"><a class="lnlinks" href="#L2030">2030</a></span><span class="cl">                                <span class="p">{</span> <span class="k">case</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$eq</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;$priority&#34;</span><span class="p">,</span> <span class="s2">&#34;low&#34;</span><span class="p">]</span> <span class="p">}</span><span class="p">,</span> <span class="nx">then</span><span class="o">:</span> <span class="mi">3</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2031"><a class="lnlinks" href="#L2031">2031</a></span><span class="cl">                            <span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2032"><a class="lnlinks" href="#L2032">2032</a></span><span class="cl">                            <span class="k">default</span><span class="o">:</span> <span class="mi">4</span>
</span></span><span class="line"><span class="ln" id="L2033"><a class="lnlinks" href="#L2033">2033</a></span><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2034"><a class="lnlinks" href="#L2034">2034</a></span><span class="cl">                    <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2035"><a class="lnlinks" href="#L2035">2035</a></span><span class="cl">                    <span class="nx">hasDueDate</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2036"><a class="lnlinks" href="#L2036">2036</a></span><span class="cl">                        <span class="nx">$cond</span><span class="o">:</span> <span class="p">{</span> <span class="k">if</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$ifNull</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;$due_date&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">]</span> <span class="p">}</span><span class="p">,</span> <span class="nx">then</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="k">else</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2037"><a class="lnlinks" href="#L2037">2037</a></span><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2038"><a class="lnlinks" href="#L2038">2038</a></span><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2039"><a class="lnlinks" href="#L2039">2039</a></span><span class="cl">            <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2040"><a class="lnlinks" href="#L2040">2040</a></span><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2041"><a class="lnlinks" href="#L2041">2041</a></span><span class="cl">                <span class="nx">$sort</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2042"><a class="lnlinks" href="#L2042">2042</a></span><span class="cl">                    <span class="nx">priorityWeight</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2043"><a class="lnlinks" href="#L2043">2043</a></span><span class="cl">                    <span class="nx">hasDueDate</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2044"><a class="lnlinks" href="#L2044">2044</a></span><span class="cl">                    <span class="nx">due</span><span class="nx">_date</span><span class="o">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln" id="L2045"><a class="lnlinks" href="#L2045">2045</a></span><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2046"><a class="lnlinks" href="#L2046">2046</a></span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2047"><a class="lnlinks" href="#L2047">2047</a></span><span class="cl">        <span class="p">]</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2048"><a class="lnlinks" href="#L2048">2048</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">todos</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2049"><a class="lnlinks" href="#L2049">2049</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2050"><a class="lnlinks" href="#L2050">2050</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error fetching todos:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2051"><a class="lnlinks" href="#L2051">2051</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2052"><a class="lnlinks" href="#L2052">2052</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2053"><a class="lnlinks" href="#L2053">2053</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2054"><a class="lnlinks" href="#L2054">2054</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2055"><a class="lnlinks" href="#L2055">2055</a></span><span class="cl"><span class="c1">// Create new TODO
</span></span></span><span class="line"><span class="ln" id="L2056"><a class="lnlinks" href="#L2056">2056</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/todos&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2057"><a class="lnlinks" href="#L2057">2057</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2058"><a class="lnlinks" href="#L2058">2058</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">category</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">description</span><span class="p">,</span> <span class="nx">priority</span><span class="p">,</span> <span class="nx">due</span><span class="nx">_date</span><span class="p">,</span> <span class="nx">start</span><span class="nx">_time</span><span class="p">,</span> <span class="nx">end</span><span class="nx">_time</span><span class="p">,</span> <span class="nx">sort</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2059"><a class="lnlinks" href="#L2059">2059</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2060"><a class="lnlinks" href="#L2060">2060</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">email</span> <span class="o">||</span> <span class="o">!</span><span class="nx">title</span> <span class="o">||</span> <span class="o">!</span><span class="nx">description</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2061"><a class="lnlinks" href="#L2061">2061</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Email, title, and description are required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2062"><a class="lnlinks" href="#L2062">2062</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2063"><a class="lnlinks" href="#L2063">2063</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2064"><a class="lnlinks" href="#L2064">2064</a></span><span class="cl">        <span class="c1">// Check authorization
</span></span></span><span class="line"><span class="ln" id="L2065"><a class="lnlinks" href="#L2065">2065</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2066"><a class="lnlinks" href="#L2066">2066</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2067"><a class="lnlinks" href="#L2067">2067</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2068"><a class="lnlinks" href="#L2068">2068</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2069"><a class="lnlinks" href="#L2069">2069</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2070"><a class="lnlinks" href="#L2070">2070</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">newTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2071"><a class="lnlinks" href="#L2071">2071</a></span><span class="cl">            <span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2072"><a class="lnlinks" href="#L2072">2072</a></span><span class="cl">            <span class="nx">category</span><span class="o">:</span> <span class="nx">category</span> <span class="o">||</span> <span class="s1">&#39;personal&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2073"><a class="lnlinks" href="#L2073">2073</a></span><span class="cl">            <span class="nx">title</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2074"><a class="lnlinks" href="#L2074">2074</a></span><span class="cl">            <span class="nx">description</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2075"><a class="lnlinks" href="#L2075">2075</a></span><span class="cl">            <span class="nx">status</span><span class="o">:</span> <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2076"><a class="lnlinks" href="#L2076">2076</a></span><span class="cl">            <span class="nx">priority</span><span class="o">:</span> <span class="nx">priority</span> <span class="o">||</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2077"><a class="lnlinks" href="#L2077">2077</a></span><span class="cl">            <span class="nx">due</span><span class="nx">_date</span><span class="o">:</span> <span class="nx">due</span><span class="nx">_date</span> <span class="o">?</span> <span class="nx">fromZonedTime</span><span class="p">(</span><span class="nx">due</span><span class="nx">_date</span><span class="p">,</span> <span class="nx">timeZone</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2078"><a class="lnlinks" href="#L2078">2078</a></span><span class="cl">            <span class="nx">start</span><span class="nx">_time</span><span class="o">:</span> <span class="nx">start</span><span class="nx">_time</span> <span class="o">?</span> <span class="nx">fromZonedTime</span><span class="p">(</span><span class="nx">start</span><span class="nx">_time</span><span class="p">,</span> <span class="nx">timeZone</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2079"><a class="lnlinks" href="#L2079">2079</a></span><span class="cl">            <span class="nx">end</span><span class="nx">_time</span><span class="o">:</span> <span class="nx">end</span><span class="nx">_time</span> <span class="o">?</span> <span class="nx">fromZonedTime</span><span class="p">(</span><span class="nx">end</span><span class="nx">_time</span><span class="p">,</span> <span class="nx">timeZone</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2080"><a class="lnlinks" href="#L2080">2080</a></span><span class="cl">            <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2081"><a class="lnlinks" href="#L2081">2081</a></span><span class="cl">            <span class="nx">show</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2082"><a class="lnlinks" href="#L2082">2082</a></span><span class="cl">            <span class="nx">sort</span><span class="o">:</span> <span class="nx">sort</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2083"><a class="lnlinks" href="#L2083">2083</a></span><span class="cl">            <span class="nx">created</span><span class="nx">_at</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2084"><a class="lnlinks" href="#L2084">2084</a></span><span class="cl">            <span class="nx">updated</span><span class="nx">_at</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="L2085"><a class="lnlinks" href="#L2085">2085</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2086"><a class="lnlinks" href="#L2086">2086</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2087"><a class="lnlinks" href="#L2087">2087</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TODO] Creating new todo with sort:&#39;</span><span class="p">,</span> <span class="nx">sort</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2088"><a class="lnlinks" href="#L2088">2088</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">newTodo</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2089"><a class="lnlinks" href="#L2089">2089</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">newTodo</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2090"><a class="lnlinks" href="#L2090">2090</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2091"><a class="lnlinks" href="#L2091">2091</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error creating todo:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2092"><a class="lnlinks" href="#L2092">2092</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2093"><a class="lnlinks" href="#L2093">2093</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2094"><a class="lnlinks" href="#L2094">2094</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2095"><a class="lnlinks" href="#L2095">2095</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2096"><a class="lnlinks" href="#L2096">2096</a></span><span class="cl"><span class="c1">// Update TODO
</span></span></span><span class="line"><span class="ln" id="L2097"><a class="lnlinks" href="#L2097">2097</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;/api/todos/:id&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2098"><a class="lnlinks" href="#L2098">2098</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2099"><a class="lnlinks" href="#L2099">2099</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2100"><a class="lnlinks" href="#L2100">2100</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">category</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">description</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">priority</span><span class="p">,</span> <span class="nx">due</span><span class="nx">_date</span><span class="p">,</span> <span class="nx">start</span><span class="nx">_time</span><span class="p">,</span> <span class="nx">end</span><span class="nx">_time</span><span class="p">,</span> <span class="nx">completed</span><span class="p">,</span> <span class="nx">sort</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2101"><a class="lnlinks" href="#L2101">2101</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2102"><a class="lnlinks" href="#L2102">2102</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2103"><a class="lnlinks" href="#L2103">2103</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Email is required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2104"><a class="lnlinks" href="#L2104">2104</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2105"><a class="lnlinks" href="#L2105">2105</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2106"><a class="lnlinks" href="#L2106">2106</a></span><span class="cl">        <span class="c1">// Check authorization
</span></span></span><span class="line"><span class="ln" id="L2107"><a class="lnlinks" href="#L2107">2107</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2108"><a class="lnlinks" href="#L2108">2108</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2109"><a class="lnlinks" href="#L2109">2109</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2110"><a class="lnlinks" href="#L2110">2110</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2111"><a class="lnlinks" href="#L2111">2111</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2112"><a class="lnlinks" href="#L2112">2112</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">todo</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">TodoList</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2113"><a class="lnlinks" href="#L2113">2113</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2114"><a class="lnlinks" href="#L2114">2114</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;TODO not found&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2115"><a class="lnlinks" href="#L2115">2115</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2116"><a class="lnlinks" href="#L2116">2116</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2117"><a class="lnlinks" href="#L2117">2117</a></span><span class="cl">        <span class="c1">// Update fields
</span></span></span><span class="line"><span class="ln" id="L2118"><a class="lnlinks" href="#L2118">2118</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">category</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">category</span> <span class="o">=</span> <span class="nx">category</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2119"><a class="lnlinks" href="#L2119">2119</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">title</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">title</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2120"><a class="lnlinks" href="#L2120">2120</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">description</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">description</span> <span class="o">=</span> <span class="nx">description</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2121"><a class="lnlinks" href="#L2121">2121</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2122"><a class="lnlinks" href="#L2122">2122</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">priority</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">priority</span> <span class="o">=</span> <span class="nx">priority</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2123"><a class="lnlinks" href="#L2123">2123</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">due</span><span class="nx">_date</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">due</span><span class="nx">_date</span> <span class="o">=</span> <span class="nx">due</span><span class="nx">_date</span> <span class="o">?</span> <span class="nx">fromZonedTime</span><span class="p">(</span><span class="nx">due</span><span class="nx">_date</span><span class="p">,</span> <span class="nx">timeZone</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2124"><a class="lnlinks" href="#L2124">2124</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">start</span><span class="nx">_time</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">start</span><span class="nx">_time</span> <span class="o">=</span> <span class="nx">start</span><span class="nx">_time</span> <span class="o">?</span> <span class="nx">fromZonedTime</span><span class="p">(</span><span class="nx">start</span><span class="nx">_time</span><span class="p">,</span> <span class="nx">timeZone</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2125"><a class="lnlinks" href="#L2125">2125</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">end</span><span class="nx">_time</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">end</span><span class="nx">_time</span> <span class="o">=</span> <span class="nx">end</span><span class="nx">_time</span> <span class="o">?</span> <span class="nx">fromZonedTime</span><span class="p">(</span><span class="nx">end</span><span class="nx">_time</span><span class="p">,</span> <span class="nx">timeZone</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2126"><a class="lnlinks" href="#L2126">2126</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">completed</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">completed</span> <span class="o">=</span> <span class="nx">completed</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2127"><a class="lnlinks" href="#L2127">2127</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">sort</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">sort</span> <span class="o">=</span> <span class="nx">sort</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2128"><a class="lnlinks" href="#L2128">2128</a></span><span class="cl">        <span class="nx">todo</span><span class="p">.</span><span class="nx">updated</span><span class="nx">_at</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2129"><a class="lnlinks" href="#L2129">2129</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2130"><a class="lnlinks" href="#L2130">2130</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TODO] Updating todo with sort:&#39;</span><span class="p">,</span> <span class="nx">sort</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2131"><a class="lnlinks" href="#L2131">2131</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2132"><a class="lnlinks" href="#L2132">2132</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2133"><a class="lnlinks" href="#L2133">2133</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2134"><a class="lnlinks" href="#L2134">2134</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error updating todo:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2135"><a class="lnlinks" href="#L2135">2135</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2136"><a class="lnlinks" href="#L2136">2136</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2137"><a class="lnlinks" href="#L2137">2137</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2138"><a class="lnlinks" href="#L2138">2138</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2139"><a class="lnlinks" href="#L2139">2139</a></span><span class="cl"><span class="c1">// Delete TODO (Soft Delete)
</span></span></span><span class="line"><span class="ln" id="L2140"><a class="lnlinks" href="#L2140">2140</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/api/todos/:id&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2141"><a class="lnlinks" href="#L2141">2141</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2142"><a class="lnlinks" href="#L2142">2142</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2143"><a class="lnlinks" href="#L2143">2143</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2144"><a class="lnlinks" href="#L2144">2144</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2145"><a class="lnlinks" href="#L2145">2145</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2146"><a class="lnlinks" href="#L2146">2146</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Email is required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2147"><a class="lnlinks" href="#L2147">2147</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2148"><a class="lnlinks" href="#L2148">2148</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2149"><a class="lnlinks" href="#L2149">2149</a></span><span class="cl">        <span class="c1">// Check authorization
</span></span></span><span class="line"><span class="ln" id="L2150"><a class="lnlinks" href="#L2150">2150</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2151"><a class="lnlinks" href="#L2151">2151</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2152"><a class="lnlinks" href="#L2152">2152</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2153"><a class="lnlinks" href="#L2153">2153</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2154"><a class="lnlinks" href="#L2154">2154</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2155"><a class="lnlinks" href="#L2155">2155</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">todo</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">TodoList</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2156"><a class="lnlinks" href="#L2156">2156</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2157"><a class="lnlinks" href="#L2157">2157</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;TODO not found&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2158"><a class="lnlinks" href="#L2158">2158</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2159"><a class="lnlinks" href="#L2159">2159</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2160"><a class="lnlinks" href="#L2160">2160</a></span><span class="cl">        <span class="c1">// Soft delete: set show to &#39;N&#39;
</span></span></span><span class="line"><span class="ln" id="L2161"><a class="lnlinks" href="#L2161">2161</a></span><span class="cl"><span class="c1"></span>        <span class="nx">todo</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2162"><a class="lnlinks" href="#L2162">2162</a></span><span class="cl">        <span class="nx">todo</span><span class="p">.</span><span class="nx">updated</span><span class="nx">_at</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2163"><a class="lnlinks" href="#L2163">2163</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2164"><a class="lnlinks" href="#L2164">2164</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2165"><a class="lnlinks" href="#L2165">2165</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;TODO deleted successfully&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2166"><a class="lnlinks" href="#L2166">2166</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2167"><a class="lnlinks" href="#L2167">2167</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error deleting todo:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2168"><a class="lnlinks" href="#L2168">2168</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2169"><a class="lnlinks" href="#L2169">2169</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2170"><a class="lnlinks" href="#L2170">2170</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2171"><a class="lnlinks" href="#L2171">2171</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2172"><a class="lnlinks" href="#L2172">2172</a></span><span class="cl"><span class="c1">// --- PROJECT Endpoints ---
</span></span></span><span class="line"><span class="ln" id="L2173"><a class="lnlinks" href="#L2173">2173</a></span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln" id="L2174"><a class="lnlinks" href="#L2174">2174</a></span><span class="cl"><span class="c1">// Project Schema
</span></span></span><span class="line"><span class="ln" id="L2175"><a class="lnlinks" href="#L2175">2175</a></span><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">projectSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2176"><a class="lnlinks" href="#L2176">2176</a></span><span class="cl">    <span class="nx">project</span><span class="nx">_name</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2177"><a class="lnlinks" href="#L2177">2177</a></span><span class="cl">    <span class="nx">github</span><span class="nx">_url</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2178"><a class="lnlinks" href="#L2178">2178</a></span><span class="cl">    <span class="nx">web</span><span class="nx">_url</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2179"><a class="lnlinks" href="#L2179">2179</a></span><span class="cl">    <span class="nx">created</span><span class="nx">_at</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2180"><a class="lnlinks" href="#L2180">2180</a></span><span class="cl">    <span class="nx">expected</span><span class="nx">_end</span><span class="nx">_at</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2181"><a class="lnlinks" href="#L2181">2181</a></span><span class="cl">    <span class="nx">actual</span><span class="nx">_end</span><span class="nx">_at</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2182"><a class="lnlinks" href="#L2182">2182</a></span><span class="cl">    <span class="nx">description</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2183"><a class="lnlinks" href="#L2183">2183</a></span><span class="cl">    <span class="nx">status</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="kr">enum</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;ongoing&#39;</span><span class="p">,</span> <span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="s1">&#39;paused&#39;</span><span class="p">]</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="s1">&#39;ongoing&#39;</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2184"><a class="lnlinks" href="#L2184">2184</a></span><span class="cl">    <span class="nx">team</span><span class="nx">_members</span><span class="o">:</span> <span class="p">[</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2185"><a class="lnlinks" href="#L2185">2185</a></span><span class="cl">        <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2186"><a class="lnlinks" href="#L2186">2186</a></span><span class="cl">        <span class="nx">role</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2187"><a class="lnlinks" href="#L2187">2187</a></span><span class="cl">        <span class="nx">email</span><span class="o">:</span> <span class="nb">String</span>
</span></span><span class="line"><span class="ln" id="L2188"><a class="lnlinks" href="#L2188">2188</a></span><span class="cl">    <span class="p">}</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2189"><a class="lnlinks" href="#L2189">2189</a></span><span class="cl">    <span class="nx">technologies</span><span class="o">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2190"><a class="lnlinks" href="#L2190">2190</a></span><span class="cl">    <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2191"><a class="lnlinks" href="#L2191">2191</a></span><span class="cl">    <span class="nx">budget</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2192"><a class="lnlinks" href="#L2192">2192</a></span><span class="cl">    <span class="nx">progress</span><span class="nx">_percent</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2193"><a class="lnlinks" href="#L2193">2193</a></span><span class="cl">    <span class="nx">last</span><span class="nx">_updated</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2194"><a class="lnlinks" href="#L2194">2194</a></span><span class="cl">    <span class="nx">show</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2195"><a class="lnlinks" href="#L2195">2195</a></span><span class="cl"><span class="p">}</span><span class="p">,</span> <span class="p">{</span> <span class="nx">collection</span><span class="o">:</span> <span class="s1">&#39;PROJECT&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2196"><a class="lnlinks" href="#L2196">2196</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2197"><a class="lnlinks" href="#L2197">2197</a></span><span class="cl"><span class="kr">const</span> <span class="nx">Project</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Project&#39;</span><span class="p">,</span> <span class="nx">projectSchema</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2198"><a class="lnlinks" href="#L2198">2198</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2199"><a class="lnlinks" href="#L2199">2199</a></span><span class="cl"><span class="c1">// Get all Projects
</span></span></span><span class="line"><span class="ln" id="L2200"><a class="lnlinks" href="#L2200">2200</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/projects&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2201"><a class="lnlinks" href="#L2201">2201</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2202"><a class="lnlinks" href="#L2202">2202</a></span><span class="cl">        <span class="c1">// Find projects where show is &#39;Y&#39; or show field doesn&#39;t exist
</span></span></span><span class="line"><span class="ln" id="L2203"><a class="lnlinks" href="#L2203">2203</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">projects</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Project</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2204"><a class="lnlinks" href="#L2204">2204</a></span><span class="cl">            <span class="nx">$or</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln" id="L2205"><a class="lnlinks" href="#L2205">2205</a></span><span class="cl">                <span class="p">{</span> <span class="nx">show</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span> <span class="p">}</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2206"><a class="lnlinks" href="#L2206">2206</a></span><span class="cl">                <span class="p">{</span> <span class="nx">show</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$exists</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2207"><a class="lnlinks" href="#L2207">2207</a></span><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="ln" id="L2208"><a class="lnlinks" href="#L2208">2208</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="p">{</span> <span class="nx">created</span><span class="nx">_at</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2209"><a class="lnlinks" href="#L2209">2209</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[API] Fetched projects:&#39;</span><span class="p">,</span> <span class="nx">projects</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2210"><a class="lnlinks" href="#L2210">2210</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">projects</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2211"><a class="lnlinks" href="#L2211">2211</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2212"><a class="lnlinks" href="#L2212">2212</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error fetching projects:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2213"><a class="lnlinks" href="#L2213">2213</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2214"><a class="lnlinks" href="#L2214">2214</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2215"><a class="lnlinks" href="#L2215">2215</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2216"><a class="lnlinks" href="#L2216">2216</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2217"><a class="lnlinks" href="#L2217">2217</a></span><span class="cl"><span class="c1">// Get single Project by ID
</span></span></span><span class="line"><span class="ln" id="L2218"><a class="lnlinks" href="#L2218">2218</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/projects/:id&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2219"><a class="lnlinks" href="#L2219">2219</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2220"><a class="lnlinks" href="#L2220">2220</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2221"><a class="lnlinks" href="#L2221">2221</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">project</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Project</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2222"><a class="lnlinks" href="#L2222">2222</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">project</span> <span class="o">||</span> <span class="nx">project</span><span class="p">.</span><span class="nx">show</span> <span class="o">===</span> <span class="s1">&#39;N&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2223"><a class="lnlinks" href="#L2223">2223</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Project not found&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2224"><a class="lnlinks" href="#L2224">2224</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2225"><a class="lnlinks" href="#L2225">2225</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">project</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2226"><a class="lnlinks" href="#L2226">2226</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2227"><a class="lnlinks" href="#L2227">2227</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error fetching project:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2228"><a class="lnlinks" href="#L2228">2228</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2229"><a class="lnlinks" href="#L2229">2229</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2230"><a class="lnlinks" href="#L2230">2230</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2231"><a class="lnlinks" href="#L2231">2231</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2232"><a class="lnlinks" href="#L2232">2232</a></span><span class="cl"><span class="c1">// Create new Project
</span></span></span><span class="line"><span class="ln" id="L2233"><a class="lnlinks" href="#L2233">2233</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/projects&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2234"><a class="lnlinks" href="#L2234">2234</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2235"><a class="lnlinks" href="#L2235">2235</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">project</span><span class="nx">_name</span><span class="p">,</span> <span class="nx">github</span><span class="nx">_url</span><span class="p">,</span> <span class="nx">web</span><span class="nx">_url</span><span class="p">,</span> <span class="nx">expected</span><span class="nx">_end</span><span class="nx">_at</span><span class="p">,</span> <span class="nx">description</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">team</span><span class="nx">_members</span><span class="p">,</span> <span class="nx">technologies</span><span class="p">,</span> <span class="nx">tags</span><span class="p">,</span> <span class="nx">budget</span><span class="p">,</span> <span class="nx">progress</span><span class="nx">_percent</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2236"><a class="lnlinks" href="#L2236">2236</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2237"><a class="lnlinks" href="#L2237">2237</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">email</span> <span class="o">||</span> <span class="o">!</span><span class="nx">project</span><span class="nx">_name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2238"><a class="lnlinks" href="#L2238">2238</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Email and project_name are required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2239"><a class="lnlinks" href="#L2239">2239</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2240"><a class="lnlinks" href="#L2240">2240</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2241"><a class="lnlinks" href="#L2241">2241</a></span><span class="cl">        <span class="c1">// Check authorization
</span></span></span><span class="line"><span class="ln" id="L2242"><a class="lnlinks" href="#L2242">2242</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2243"><a class="lnlinks" href="#L2243">2243</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2244"><a class="lnlinks" href="#L2244">2244</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2245"><a class="lnlinks" href="#L2245">2245</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2246"><a class="lnlinks" href="#L2246">2246</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2247"><a class="lnlinks" href="#L2247">2247</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">newProject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Project</span><span class="p">(</span><span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2248"><a class="lnlinks" href="#L2248">2248</a></span><span class="cl">            <span class="nx">project</span><span class="nx">_name</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2249"><a class="lnlinks" href="#L2249">2249</a></span><span class="cl">            <span class="nx">github</span><span class="nx">_url</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2250"><a class="lnlinks" href="#L2250">2250</a></span><span class="cl">            <span class="nx">web</span><span class="nx">_url</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2251"><a class="lnlinks" href="#L2251">2251</a></span><span class="cl">            <span class="nx">expected</span><span class="nx">_end</span><span class="nx">_at</span><span class="o">:</span> <span class="nx">expected</span><span class="nx">_end</span><span class="nx">_at</span> <span class="o">?</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">expected</span><span class="nx">_end</span><span class="nx">_at</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2252"><a class="lnlinks" href="#L2252">2252</a></span><span class="cl">            <span class="nx">description</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2253"><a class="lnlinks" href="#L2253">2253</a></span><span class="cl">            <span class="nx">status</span><span class="o">:</span> <span class="nx">status</span> <span class="o">||</span> <span class="s1">&#39;ongoing&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2254"><a class="lnlinks" href="#L2254">2254</a></span><span class="cl">            <span class="nx">team</span><span class="nx">_members</span><span class="o">:</span> <span class="nx">team</span><span class="nx">_members</span> <span class="o">||</span> <span class="p">[</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2255"><a class="lnlinks" href="#L2255">2255</a></span><span class="cl">            <span class="nx">technologies</span><span class="o">:</span> <span class="nx">technologies</span> <span class="o">||</span> <span class="p">[</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2256"><a class="lnlinks" href="#L2256">2256</a></span><span class="cl">            <span class="nx">tags</span><span class="o">:</span> <span class="nx">tags</span> <span class="o">||</span> <span class="p">[</span><span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2257"><a class="lnlinks" href="#L2257">2257</a></span><span class="cl">            <span class="nx">budget</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2258"><a class="lnlinks" href="#L2258">2258</a></span><span class="cl">            <span class="nx">progress</span><span class="nx">_percent</span><span class="o">:</span> <span class="nx">progress</span><span class="nx">_percent</span> <span class="o">||</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2259"><a class="lnlinks" href="#L2259">2259</a></span><span class="cl">            <span class="nx">show</span><span class="o">:</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2260"><a class="lnlinks" href="#L2260">2260</a></span><span class="cl">            <span class="nx">created</span><span class="nx">_at</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="ln" id="L2261"><a class="lnlinks" href="#L2261">2261</a></span><span class="cl">            <span class="nx">last</span><span class="nx">_updated</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="ln" id="L2262"><a class="lnlinks" href="#L2262">2262</a></span><span class="cl">        <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2263"><a class="lnlinks" href="#L2263">2263</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2264"><a class="lnlinks" href="#L2264">2264</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">newProject</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2265"><a class="lnlinks" href="#L2265">2265</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">newProject</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2266"><a class="lnlinks" href="#L2266">2266</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2267"><a class="lnlinks" href="#L2267">2267</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error creating project:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2268"><a class="lnlinks" href="#L2268">2268</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2269"><a class="lnlinks" href="#L2269">2269</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2270"><a class="lnlinks" href="#L2270">2270</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2271"><a class="lnlinks" href="#L2271">2271</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2272"><a class="lnlinks" href="#L2272">2272</a></span><span class="cl"><span class="c1">// Update Project
</span></span></span><span class="line"><span class="ln" id="L2273"><a class="lnlinks" href="#L2273">2273</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;/api/projects/:id&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2274"><a class="lnlinks" href="#L2274">2274</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2275"><a class="lnlinks" href="#L2275">2275</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2276"><a class="lnlinks" href="#L2276">2276</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">project</span><span class="nx">_name</span><span class="p">,</span> <span class="nx">github</span><span class="nx">_url</span><span class="p">,</span> <span class="nx">web</span><span class="nx">_url</span><span class="p">,</span> <span class="nx">expected</span><span class="nx">_end</span><span class="nx">_at</span><span class="p">,</span> <span class="nx">actual</span><span class="nx">_end</span><span class="nx">_at</span><span class="p">,</span> <span class="nx">description</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">team</span><span class="nx">_members</span><span class="p">,</span> <span class="nx">technologies</span><span class="p">,</span> <span class="nx">tags</span><span class="p">,</span> <span class="nx">budget</span><span class="p">,</span> <span class="nx">progress</span><span class="nx">_percent</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2277"><a class="lnlinks" href="#L2277">2277</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2278"><a class="lnlinks" href="#L2278">2278</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2279"><a class="lnlinks" href="#L2279">2279</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Email is required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2280"><a class="lnlinks" href="#L2280">2280</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2281"><a class="lnlinks" href="#L2281">2281</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2282"><a class="lnlinks" href="#L2282">2282</a></span><span class="cl">        <span class="c1">// Check authorization
</span></span></span><span class="line"><span class="ln" id="L2283"><a class="lnlinks" href="#L2283">2283</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2284"><a class="lnlinks" href="#L2284">2284</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2285"><a class="lnlinks" href="#L2285">2285</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2286"><a class="lnlinks" href="#L2286">2286</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2287"><a class="lnlinks" href="#L2287">2287</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2288"><a class="lnlinks" href="#L2288">2288</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">project</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Project</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2289"><a class="lnlinks" href="#L2289">2289</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">project</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2290"><a class="lnlinks" href="#L2290">2290</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Project not found&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2291"><a class="lnlinks" href="#L2291">2291</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2292"><a class="lnlinks" href="#L2292">2292</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2293"><a class="lnlinks" href="#L2293">2293</a></span><span class="cl">        <span class="c1">// Update fields
</span></span></span><span class="line"><span class="ln" id="L2294"><a class="lnlinks" href="#L2294">2294</a></span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">project</span><span class="nx">_name</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">project</span><span class="p">.</span><span class="nx">project</span><span class="nx">_name</span> <span class="o">=</span> <span class="nx">project</span><span class="nx">_name</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2295"><a class="lnlinks" href="#L2295">2295</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">github</span><span class="nx">_url</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">project</span><span class="p">.</span><span class="nx">github</span><span class="nx">_url</span> <span class="o">=</span> <span class="nx">github</span><span class="nx">_url</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2296"><a class="lnlinks" href="#L2296">2296</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">web</span><span class="nx">_url</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">project</span><span class="p">.</span><span class="nx">web</span><span class="nx">_url</span> <span class="o">=</span> <span class="nx">web</span><span class="nx">_url</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2297"><a class="lnlinks" href="#L2297">2297</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">expected</span><span class="nx">_end</span><span class="nx">_at</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">project</span><span class="p">.</span><span class="nx">expected</span><span class="nx">_end</span><span class="nx">_at</span> <span class="o">=</span> <span class="nx">expected</span><span class="nx">_end</span><span class="nx">_at</span> <span class="o">?</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">expected</span><span class="nx">_end</span><span class="nx">_at</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2298"><a class="lnlinks" href="#L2298">2298</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">actual</span><span class="nx">_end</span><span class="nx">_at</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">project</span><span class="p">.</span><span class="nx">actual</span><span class="nx">_end</span><span class="nx">_at</span> <span class="o">=</span> <span class="nx">actual</span><span class="nx">_end</span><span class="nx">_at</span> <span class="o">?</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">actual</span><span class="nx">_end</span><span class="nx">_at</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2299"><a class="lnlinks" href="#L2299">2299</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">description</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">project</span><span class="p">.</span><span class="nx">description</span> <span class="o">=</span> <span class="nx">description</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2300"><a class="lnlinks" href="#L2300">2300</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">project</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2301"><a class="lnlinks" href="#L2301">2301</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">team</span><span class="nx">_members</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">project</span><span class="p">.</span><span class="nx">team</span><span class="nx">_members</span> <span class="o">=</span> <span class="nx">team</span><span class="nx">_members</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2302"><a class="lnlinks" href="#L2302">2302</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">technologies</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">project</span><span class="p">.</span><span class="nx">technologies</span> <span class="o">=</span> <span class="nx">technologies</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2303"><a class="lnlinks" href="#L2303">2303</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">tags</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">project</span><span class="p">.</span><span class="nx">tags</span> <span class="o">=</span> <span class="nx">tags</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2304"><a class="lnlinks" href="#L2304">2304</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">budget</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">project</span><span class="p">.</span><span class="nx">budget</span> <span class="o">=</span> <span class="nx">budget</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2305"><a class="lnlinks" href="#L2305">2305</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">progress</span><span class="nx">_percent</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">project</span><span class="p">.</span><span class="nx">progress</span><span class="nx">_percent</span> <span class="o">=</span> <span class="nx">progress</span><span class="nx">_percent</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2306"><a class="lnlinks" href="#L2306">2306</a></span><span class="cl">        <span class="nx">project</span><span class="p">.</span><span class="nx">last</span><span class="nx">_updated</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2307"><a class="lnlinks" href="#L2307">2307</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2308"><a class="lnlinks" href="#L2308">2308</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">project</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2309"><a class="lnlinks" href="#L2309">2309</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">project</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2310"><a class="lnlinks" href="#L2310">2310</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2311"><a class="lnlinks" href="#L2311">2311</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error updating project:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2312"><a class="lnlinks" href="#L2312">2312</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2313"><a class="lnlinks" href="#L2313">2313</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2314"><a class="lnlinks" href="#L2314">2314</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2315"><a class="lnlinks" href="#L2315">2315</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2316"><a class="lnlinks" href="#L2316">2316</a></span><span class="cl"><span class="c1">// Delete Project (Soft Delete)
</span></span></span><span class="line"><span class="ln" id="L2317"><a class="lnlinks" href="#L2317">2317</a></span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/api/projects/:id&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2318"><a class="lnlinks" href="#L2318">2318</a></span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2319"><a class="lnlinks" href="#L2319">2319</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2320"><a class="lnlinks" href="#L2320">2320</a></span><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2321"><a class="lnlinks" href="#L2321">2321</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2322"><a class="lnlinks" href="#L2322">2322</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2323"><a class="lnlinks" href="#L2323">2323</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Email is required&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2324"><a class="lnlinks" href="#L2324">2324</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2325"><a class="lnlinks" href="#L2325">2325</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2326"><a class="lnlinks" href="#L2326">2326</a></span><span class="cl">        <span class="c1">// Check authorization
</span></span></span><span class="line"><span class="ln" id="L2327"><a class="lnlinks" href="#L2327">2327</a></span><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">authorizedEmails</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distilledchild@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;wellclouder@gmail.com&#39;</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2328"><a class="lnlinks" href="#L2328">2328</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorizedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2329"><a class="lnlinks" href="#L2329">2329</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2330"><a class="lnlinks" href="#L2330">2330</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2331"><a class="lnlinks" href="#L2331">2331</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2332"><a class="lnlinks" href="#L2332">2332</a></span><span class="cl">        <span class="kr">const</span> <span class="nx">project</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Project</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2333"><a class="lnlinks" href="#L2333">2333</a></span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">project</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2334"><a class="lnlinks" href="#L2334">2334</a></span><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Project not found&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2335"><a class="lnlinks" href="#L2335">2335</a></span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2336"><a class="lnlinks" href="#L2336">2336</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2337"><a class="lnlinks" href="#L2337">2337</a></span><span class="cl">        <span class="c1">// Soft delete: set show to &#39;N&#39;
</span></span></span><span class="line"><span class="ln" id="L2338"><a class="lnlinks" href="#L2338">2338</a></span><span class="cl"><span class="c1"></span>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">[PROJECT] Soft deleting project </span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb"> (setting show=&#39;N&#39;)</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2339"><a class="lnlinks" href="#L2339">2339</a></span><span class="cl">        <span class="nx">project</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2340"><a class="lnlinks" href="#L2340">2340</a></span><span class="cl">        <span class="nx">project</span><span class="p">.</span><span class="nx">last</span><span class="nx">_updated</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2341"><a class="lnlinks" href="#L2341">2341</a></span><span class="cl">        <span class="kr">await</span> <span class="nx">project</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2342"><a class="lnlinks" href="#L2342">2342</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2343"><a class="lnlinks" href="#L2343">2343</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Project deleted successfully&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2344"><a class="lnlinks" href="#L2344">2344</a></span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2345"><a class="lnlinks" href="#L2345">2345</a></span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error deleting project:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2346"><a class="lnlinks" href="#L2346">2346</a></span><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2347"><a class="lnlinks" href="#L2347">2347</a></span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln" id="L2348"><a class="lnlinks" href="#L2348">2348</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2349"><a class="lnlinks" href="#L2349">2349</a></span><span class="cl">
</span></span><span class="line"><span class="ln" id="L2350"><a class="lnlinks" href="#L2350">2350</a></span><span class="cl"><span class="kr">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">4000</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2351"><a class="lnlinks" href="#L2351">2351</a></span><span class="cl"><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">(</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln" id="L2352"><a class="lnlinks" href="#L2352">2352</a></span><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">SERVER RUNNING ON PORT </span><span class="si">${</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="ln" id="L2353"><a class="lnlinks" href="#L2353">2353</a></span><span class="cl"><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span></code></pre>
    

    </div>
</main>
<footer>
    Generated by <a href="https://github.com/antonmedv/gitmal">Gitmal</a>
</footer>
</body>
</html>
